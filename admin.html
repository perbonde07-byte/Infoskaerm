<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin ‚Ä¢ Infosk√¶rm</title>

  <!-- ===== Admin gate (PIN: 0705) ===== -->
  <script>
    const ADMIN_KEY = "0705";
    (function gate(){
      try {
        const q = new URLSearchParams(location.search);
        const pin = (q.get("admin")||"").trim();
        if (pin && pin===ADMIN_KEY){
          localStorage.setItem("admin_ok","1");
          const u = new URL(location.href);
          u.searchParams.delete("admin");
          location.replace(u.toString());
          return;
        }
        if (localStorage.getItem("admin_ok")==="1") return;

        const html = `
          <style>
            html,body{height:100%;margin:0}
            body{background:#0b1220;color:#e8eefb;font-family:system-ui;display:flex;align-items:center;justify-content:center}
            .card{width:min(92vw,420px);background:#111a2d;border:1px solid rgba(255,255,255,.1);
                  border-radius:16px;padding:24px;text-align:center}
            input{width:100%;padding:12px;border-radius:10px;border:1px solid #243147;background:#0f172a;color:#e8eefb}
            button{margin-top:12px;width:100%;padding:12px;border:0;border-radius:10px;background:#5aa2ff;color:#061022;font-weight:600;cursor:pointer}
            .hint{margin-top:10px;opacity:.7}
          </style>
          <div class="card">
            <h1>Ingen adgang</h1>
            <p>Indtast admin-kode for at √•bne.</p>
            <input id="pin" placeholder="Kode" inputmode="numeric" autocomplete="one-time-code"/>
            <button id="ok">Log ind</button>
            <div class="hint">Tip: ?admin=${ADMIN_KEY}</div>
          </div>`;
        document.documentElement.innerHTML = html;
        addEventListener("click",e=>{ if(e.target.id==="ok") go(); });
        addEventListener("keydown",e=>{ if(e.key==="Enter") go(); });
        function go(){
          const v = (document.getElementById("pin").value||"").trim();
          if(v===ADMIN_KEY){ localStorage.setItem("admin_ok","1"); location.reload(); }
          else alert("Forkert kode");
        }
      } catch(err){ console.error(err); }
    })();
  </script>
  <!-- ===== /gate ===== -->

  <style>
    :root{
      --bg:#0b1220;
      --panel:#111a2d;
      --muted:#243147;
      --accent:#5aa2ff;
      --text:#e8eefb;
    }
    *{box-sizing:border-box}
    body{background:var(--bg);color:var(--text);font-family:system-ui;margin:0;padding:20px}
    h1{margin:0 0 16px}
    h2{margin:0 0 10px}
    section{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:18px;margin:16px 0}
    label{display:block;margin:.6rem 0 .2rem}
    input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--muted);background:#0f172a;color:var(--text)}
    textarea{min-height:80px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .btn{background:var(--accent);color:#061022;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .ghost{background:#162238;color:#cfe1ff;border:1px solid var(--muted)}
    #status{margin-top:8px;opacity:.8}
    .pill{display:inline-block;background:#0e1a2e;border:1px solid var(--muted);padding:2px 8px;border-radius:999px}

    /* chips + ikon knapper til dato-v√¶lgeren */
    .chips{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.25rem}
    .chip{display:inline-flex;align-items:center;gap:.4rem;background:#18243b;
      border:1px solid var(--muted);padding:.3rem .6rem;border-radius:999px}
    .chip button{all:unset;cursor:pointer;color:#ff9a9a;padding-left:.25rem}
    .iconbtn{border:1px solid var(--muted);background:#0f172a;color:#cfe1ff;border-radius:10px;padding:9px 10px;cursor:pointer}
    .iconbtn:hover{background:#152039}
    .small{opacity:.8;font-size:.9rem}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid var(--muted);padding:8px 6px;text-align:left}
  </style>
</head>
<body>
  <h1>Admin ‚Ä¢ Infosk√¶rm</h1>

  <!-- Datakilde -->
  <section>
    <h2>Datakilde</h2>
    <label>Adresse til <code>data.json</code></label>
    <input id="dataUrl" value="https://perbonde07-byte.github.io/Infoskaerm/data.json"/>
    <div style="display:flex;gap:10px;margin-top:10px">
      <button id="loadBtn" class="ghost">Hent data</button>
      <button id="downloadBtn" class="ghost">Download ny data.json</button>
      <button id="saveServerBtn" class="btn">Gem til server</button>
    </div>
    <div id="status"></div>
  </section>

  <!-- Indstillinger -->
  <section>
    <h2>Indstillinger</h2>
    <div class="row">
      <div>
        <label>Logo URL (valgfrit)</label>
        <input id="set_logo_url" placeholder="https://..."/>
      </div>
      <div>
        <label>Media-mappe (OneDrive/andet) link</label>
        <input id="set_media_url" placeholder="https://... (delt mappe-URL)"/>
        <label class="small">Kode / n√∏gle (valgfrit)</label>
        <input id="set_media_key" placeholder="fx adgangskode til mappe"/>
      </div>
    </div>
  </section>

  <!-- T√∏mning -->
  <section>
    <h2>T√∏mmeplan</h2>
    <div class="row">
      <div>
        <label>Ugedage</label>
        <div style="display:flex;gap:14px;align-items:center">
          <label><input type="checkbox" class="day-cb" data-day="1"> Man</label>
          <label><input type="checkbox" class="day-cb" data-day="2"> Tir</label>
          <label><input type="checkbox" class="day-cb" data-day="3"> Ons</label>
          <label><input type="checkbox" class="day-cb" data-day="4"> Tor</label>
          <label><input type="checkbox" class="day-cb" data-day="5"> Fre</label>
        </div>

        <label>Spring over datoer</label>
        <div class="chips" id="skipChips"></div>
        <div style="display:flex;gap:.5rem;align-items:center;margin-top:.5rem">
          <input type="date" id="skipPicker">
          <button type="button" class="iconbtn" id="openSkipPicker" title="V√¶lg dato">üìÖ</button>
          <button type="button" class="ghost" id="addSkip">Tilf√∏j dato</button>
        </div>
        <small class="small">Datoer gemmes som <code>YYYY-MM-DD</code>, men vises som <b>DD-MM-√Ö√Ö√Ö√Ö</b>.</small>
      </div>

      <div>
        <label>Navneliste (√©n pr. linje eller komma-separeret ‚Äì roterer i r√¶kkef√∏lge)</label>
        <textarea id="trash_names" placeholder="per&#10;martin&#10;kasper"></textarea>
      </div>
    </div>
  </section>

  <!-- F√∏dselsdage -->
  <section>
    <h2>F√∏dselsdage</h2>
    <div class="row">
      <div>
        <label>Navn</label>
        <input id="bdayName" placeholder="Navn">
        <label>F√∏dselsdag (YYYY-MM-DD)</label>
        <div style="display:flex;gap:.5rem;align-items:center">
          <input type="date" id="bdayDate">
          <button type="button" class="iconbtn" id="openBdayPicker" title="V√¶lg dato">üìÖ</button>
        </div>
        <label>Foto URL (valgfrit)</label>
        <input id="bdayPhoto" placeholder="https://...">
        <button id="addBday" class="ghost" style="margin-top:10px">Tilf√∏j</button>
      </div>
      <div>
        <table>
          <thead><tr><th>Navn</th><th>Dato</th><th>Foto</th><th></th></tr></thead>
          <tbody id="bdayTable"></tbody>
        </table>
      </div>
    </div>
  </section>

  <script>
    // ---------- Dansk datoformat helper ----------
    function fmtDa(iso){
      if(!iso) return '';
      const d = new Date(iso);
      if(Number.isNaN(d.getTime())) return iso;
      return d.toLocaleDateString('da-DK', {day:'2-digit',month:'2-digit',year:'numeric'});
    }

    // ---------- App state ----------
    const $ = s => document.querySelector(s);
    const state = {
      dataUrl: $('#dataUrl').value,
      data: { brand:'Bredsgaard ‚Ä¢ Infosk√¶rm' } // udfyldes ved load()
    };

    // S√∏rg for at settings altid findes
    function ensureSettings(){
      const s = state.data.settings ||= {};
      s.brand ||= 'Bredsgaard ‚Ä¢ Infosk√¶rm';
      s.logo  ||= { url: '' };
      s.media ||= { url: '', key: '' };
      s.trash ||= { days:[1], names:[], skipDates:[] };   // mandag default
      s.birthdays ||= [];                                  // [{name,date,photo}]
    }

    // ---------- Render ----------
    function render(){
      ensureSettings();
      const s = state.data.settings;

      // Indstillinger
      $('#set_logo_url').value  = s.logo.url || '';
      $('#set_media_url').value = s.media.url || '';
      $('#set_media_key').value = s.media.key || '';

      // Dage
      document.querySelectorAll('.day-cb').forEach(cb=>{
        cb.checked = (s.trash.days || []).includes(+cb.dataset.day);
      });

      // Navne
      $('#trash_names').value = (s.trash.names||[]).join('\n');

      renderSkipChips();
      renderBdays();
      $('#status').textContent = 'Klar';
    }

    // ---------- Skip dato chips ----------
    function renderSkipChips(){
      ensureSettings();
      const box = $('#skipChips'); box.innerHTML='';
      const arr = state.data.settings.trash.skipDates || [];
      arr.forEach((iso, idx)=>{
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.innerHTML = `${fmtDa(iso)} <button title="Fjern">&times;</button>`;
        chip.querySelector('button').onclick = ()=>{ arr.splice(idx,1); renderSkipChips(); };
        box.appendChild(chip);
      });
    }

    // ---------- F√∏dselsdage ----------
    function renderBdays(){
      const tb = $('#bdayTable'); tb.innerHTML='';
      const arr = state.data.settings.birthdays || [];
      arr.forEach((b,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${b.name||''}</td>
          <td>${fmtDa(b.date)}</td>
          <td>${b.photo?'<span class="pill">link</span>':''}</td>
          <td><button class="ghost" data-i="${i}">Slet</button></td>`;
        tr.querySelector('button').onclick = e=>{
          arr.splice(+e.target.dataset.i,1);
          renderBdays();
        };
        tb.appendChild(tr);
      });
    }

    // ---------- Load / Save ----------
    async function load(){
      try{
        $('#status').textContent = 'Henter data...';
        const res = await fetch(state.dataUrl+'?v='+Date.now());
        if(!res.ok) throw new Error('HTTP '+res.status);
        state.data = await res.json();
      }catch(e){
        // tom start
        state.data = { brand:'Bredsgaard ‚Ä¢ Infosk√¶rm' };
      }
      render();
    }

    async function saveToServer(){
      try{
        $('#status').textContent = 'Gemmer til server...';
        const res = await fetch('/api/save',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(state.data)
        });
        const txt = await res.text();
        if(!res.ok) throw new Error(txt);
        $('#status').textContent = '‚úÖ Data gemt p√• GitHub!';
      }catch(err){
        $('#status').textContent = 'Fejl under gemning: '+err.message;
      }
    }

    // ---------- Events ----------
    $('#dataUrl').addEventListener('input',e=> state.dataUrl = e.target.value);
    $('#loadBtn').onclick = load;
    $('#downloadBtn').onclick = ()=>{
      const blob = new Blob([JSON.stringify(state.data,null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='data.json'; a.click();
    };
    $('#saveServerBtn').onclick = ()=>{ ensureSettings(); saveToServer(); };

    // settings inputs
    $('#set_logo_url').addEventListener('input',e=>{ ensureSettings(); state.data.settings.logo.url = e.target.value.trim(); });
    $('#set_media_url').addEventListener('input',e=>{ ensureSettings(); state.data.settings.media.url = e.target.value.trim(); });
    $('#set_media_key').addEventListener('input',e=>{ ensureSettings(); state.data.settings.media.key = e.target.value.trim(); });

    // dage
    document.querySelectorAll('.day-cb').forEach(cb=>{
      cb.addEventListener('change',()=>{
        ensureSettings();
        const d = +cb.dataset.day;
        const arr = state.data.settings.trash.days ||= [];
        if(cb.checked && !arr.includes(d)) arr.push(d);
        if(!cb.checked) state.data.settings.trash.days = arr.filter(x=>x!==d);
      });
    });

    // navne
    $('#trash_names').addEventListener('input',e=>{
      ensureSettings();
      const lines = e.target.value.split(/\n|,/).map(x=>x.trim()).filter(Boolean);
      state.data.settings.trash.names = lines;
    });

    // skip datoer
    $('#openSkipPicker').onclick = ()=> $('#skipPicker')?.showPicker?.();
    $('#addSkip').onclick = ()=>{
      ensureSettings();
      const val = $('#skipPicker').value;
      if(!val) return alert('V√¶lg en dato f√∏rst');
      const arr = state.data.settings.trash.skipDates ||= [];
      if(!arr.includes(val)) arr.push(val);
      renderSkipChips();
    };

    // f√∏dselsdage
    $('#openBdayPicker').onclick = ()=> $('#bdayDate')?.showPicker?.();
    $('#addBday').onclick = ()=>{
      ensureSettings();
      const name = $('#bdayName').value.trim();
      const date = $('#bdayDate').value;
      const photo = $('#bdayPhoto').value.trim();
      if(!name || !date) return alert('Udfyld navn og dato');
      state.data.settings.birthdays.push({name,date,photo});
      $('#bdayName').value=''; $('#bdayDate').value=''; $('#bdayPhoto').value='';
      renderBdays();
    };

    // start
    load();
  </script>
</body>
</html>

