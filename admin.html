<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin • Infoskaerm</title>
  <style>
    :root{--bg:#0b1220;--panel:#111a2d;--muted:#243147;--text:#e8eefb;--accent:#5aa2ff}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:86px auto 80px;padding:0 18px}
    h1{margin:0 0 10px}
    h2{margin:18px 0 10px}
    section{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:16px 16px 6px;margin:14px 0}
    label{display:block;margin:10px 0 6px}
    input,textarea,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--muted);background:#0f172a;color:var(--text)}
    textarea{min-height:84px}
    small{opacity:.8}
    .row{display:grid;gap:14px}
    .g2{grid-template-columns:1fr 1fr}
    .g3{grid-template-columns:1fr 1fr 1fr}
    .btn{display:inline-flex;align-items:center;gap:8px;background:var(--accent);color:#071022;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.subtle{background:#1a2440;color:#cfe0ff}
    .btn.danger{background:#d25b5b;color:#1a0909}
    .topbar{
      position:fixed;inset:0 0 auto 0;height:64px;background:rgba(15,23,42,.9);backdrop-filter:blur(6px);
      border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;gap:12px;padding:0 16px;z-index:10
    }
    .spacer{flex:1}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;background:#0f1b34;border:1px solid #203258}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-bottom:1px solid var(--muted);padding:8px 10px;text-align:left}
    th{opacity:.8;font-weight:600}
    .sticky-save{position:fixed;right:16px;bottom:16px;display:none}
    details>summary{cursor:pointer;list-style:none;font-weight:700;margin:-6px 0 6px}
    details>summary::marker, details>summary::-webkit-details-marker{display:none}
    .hide{display:none}
    .note{font-size:13px;color:#bcd2ff;opacity:.85}
  </style>
</head>
<body>
  <!-- top bar with always-visible SAVE -->
  <div class="topbar">
    <strong>Infoskærm • Admin</strong>
    <span class="pill">Data: <code id="dataUrlView"></code></span>
    <button class="btn subtle" id="loadBtn">Hent data</button>
    <div class="spacer"></div>
    <span id="status" class="pill">Klar</span>
    <button class="btn" id="saveBtn">Gem ændringer</button>
  </div>

  <div class="wrap">
    <section>
      <details>
        <summary>Datakilde</summary>
        <label>Adresse til <code>data.json</code></label>
        <input id="dataUrl" />
        <div style="display:flex;gap:10px;margin-top:10px">
          <button class="btn subtle" id="setUrlBtn">Brug denne adresse</button>
          <button class="btn subtle" id="downloadBtn">Download ny data.json</button>
        </div>
        <p class="note">Tip: Brug din GitHub Pages-URL, fx <code>https://perbonde07-byte.github.io/Infoskaerm/data.json</code></p>
      </details>
    </section>

    <section>
      <h2>Indstillinger</h2>
      <div class="row g2">
        <div>
          <label>Brand (vises i bunden på skærmen)</label>
          <input id="brand">
        </div>
        <div>
          <label>Logo URL (valgfrit)</label>
          <input id="logoUrl" placeholder="https://...">
        </div>
      </div>
      <div class="row g2">
        <div>
          <label>Logo placering</label>
          <select id="logoPos">
            <option>Øverst højre</option>
            <option>Øverst venstre</option>
            <option>Nederst højre</option>
            <option>Nederst venstre</option>
          </select>
        </div>
        <div>
          <label>Medie-mappe (OneDrive/Dropbox/Share) – link</label>
          <input id="mediaBase" placeholder="https://... (delt mappe-URL)">
          <small class="note">Brug et delt mappe-link. Vi gemmer det i data.json så viewer kan vise billeder via fulde URLs.</small>
        </div>
      </div>
      <div class="row g2">
        <div>
          <label>Kode / nøgle (valgfrit – hvis din mappe kræver det)</label>
          <input id="mediaKey" placeholder="fx note eller adgangskode">
        </div>
        <div></div>
      </div>
    </section>

    <section>
      <h2>Slides</h2>
      <div class="row g3">
        <div>
          <label>Skabelon</label>
          <select id="s_type">
            <option value="bullets">Bullets (tekst)</option>
            <option value="image">Billede (fuldskærm)</option>
            <option value="empties">Tømningstabel</option>
            <option value="birthday">Fødselsdag</option>
          </select>
        </div>
        <div>
          <label>Titel</label>
          <input id="s_title" placeholder="Titel...">
        </div>
        <div>
          <label>Varighed (sek.)</label>
          <input id="s_duration" type="number" value="12" min="3">
        </div>
      </div>

      <div class="row g2">
        <div>
          <label>Linjer (brug | for nye punkter)</label>
          <textarea id="s_lines" placeholder="Punkt 1 | Punkt 2 | Punkt 3"></textarea>
        </div>
        <div>
          <label>Billede URL (kun for skabelon = Billede/Fødselsdag)</label>
          <input id="s_image" placeholder="https://...">
        </div>
      </div>

      <div style="display:flex;gap:10px;margin:8px 0 10px">
        <button class="btn" id="addSlide">Tilføj slide</button>
        <button class="btn danger" id="clearSlides">Tøm alle slides</button>
      </div>

      <table id="slidesTable">
        <thead><tr><th style="width:36px">#</th><th>Type</th><th>Titel</th><th>Forhåndsvisning</th><th style="width:90px"></th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <section>
      <h2>Tømmeplan</h2>
      <div class="row g2">
        <div>
          <label>Ugedage</label>
          <div style="display:flex;gap:18px;padding:8px 0">
            <label><input type="checkbox" class="wd" data-i="0"> Man</label>
            <label><input type="checkbox" class="wd" data-i="1"> Tir</label>
            <label><input type="checkbox" class="wd" data-i="2"> Ons</label>
            <label><input type="checkbox" class="wd" data-i="3"> Tor</label>
            <label><input type="checkbox" class="wd" data-i="4"> Fre</label>
          </div>

          <label>Spring over datoer (YYYY-MM-DD, komma eller linjeskift)</label>
          <textarea id="skipDates" placeholder="2025-12-24, 2025-12-31"></textarea>
        </div>
        <div>
          <label>Navneliste (ét pr. linje eller komma-separeret – roterer i rækkefølge)</label>
          <textarea id="emptyNames" placeholder="Per, Martin, Kasper"></textarea>
        </div>
      </div>
    </section>

    <section>
      <h2>Fødselsdage</h2>
      <div class="row g3">
        <div>
          <label>Navn</label>
          <input id="bd_name" placeholder="Navn">
        </div>
        <div>
          <label>Fødselsdag (YYYY-MM-DD)</label>
          <input id="bd_date" placeholder="1986-05-07">
        </div>
        <div>
          <label>Foto URL (valgfrit)</label>
          <input id="bd_photo" placeholder="https://...">
        </div>
      </div>
      <div style="margin-top:10px">
        <button class="btn" id="addBd">Tilføj</button>
      </div>

      <table id="bdTable">
        <thead><tr><th>Navn</th><th>Dato</th><th>Foto</th><th style="width:90px"></th></tr></thead>
        <tbody></tbody>
      </table>
      <p class="note">Viewer viser automatisk fødselsdags-slides i den uge (man–søn) hvor fødselsdagen falder.</p>
    </section>

    <!-- sticky mini save if man scroller langt ned -->
    <button class="btn sticky-save" id="saveBtn2">Gem ændringer</button>
  </div>

  <script>
    // ---------- MODEL ----------
    const DEFAULT_URL = "https://perbonde07-byte.github.io/Infoskaerm/data.json";
    const state = {
      dataUrl: DEFAULT_URL,
      data: {
        brand: "Bredsgaard • Infoskaerm",
        logoUrl: "",
        logoPos: "Øverst højre",
        media: { baseUrl: "", key: "" },
        empties: { weekdays: [true,false,false,false,false], skipDates: [], names: [] },
        birthdays: [],
        slides: []
      }
    };

    // ---------- DOM ----------
    const $ = (s)=>document.querySelector(s);
    const els = {
      // top
      dataUrlView: $("#dataUrlView"), dataUrl: $("#dataUrl"), setUrlBtn: $("#setUrlBtn"),
      loadBtn: $("#loadBtn"), saveBtn: $("#saveBtn"), saveBtn2: $("#saveBtn2"), status: $("#status"),
      downloadBtn: $("#downloadBtn"),

      // settings
      brand: $("#brand"), logoUrl: $("#logoUrl"), logoPos: $("#logoPos"),
      mediaBase: $("#mediaBase"), mediaKey: $("#mediaKey"),

      // slides creator
      s_type: $("#s_type"), s_title: $("#s_title"), s_duration: $("#s_duration"),
      s_lines: $("#s_lines"), s_image: $("#s_image"),
      addSlide: $("#addSlide"), clearSlides: $("#clearSlides"), slidesTable: $("#slidesTable tbody"),

      // empties
      wd: Array.from(document.querySelectorAll(".wd")), skipDates: $("#skipDates"), emptyNames: $("#emptyNames"),

      // birthdays
      bd_name: $("#bd_name"), bd_date: $("#bd_date"), bd_photo: $("#bd_photo"),
      addBd: $("#addBd"), bdTable: $("#bdTable tbody"),
    };

    // ---------- RENDER ----------
    function bindSettings(){
      els.brand.value       = state.data.brand || "";
      els.logoUrl.value     = state.data.logoUrl || "";
      els.logoPos.value     = state.data.logoPos || "Øverst højre";
      els.mediaBase.value   = (state.data.media && state.data.media.baseUrl) || "";
      els.mediaKey.value    = (state.data.media && state.data.media.key) || "";

      // empties
      const e = state.data.empties || {weekdays:[true,false,false,false,false],skipDates:[],names:[]};
      els.wd.forEach((c,i)=> c.checked = !!e.weekdays?.[i]);
      els.skipDates.value = (e.skipDates||[]).join(", ");
      els.emptyNames.value = (e.names||[]).join(", ");
    }

    function renderSlides(){
      els.slidesTable.innerHTML = "";
      (state.data.slides||[]).forEach((s,idx)=>{
        const tr = document.createElement("tr");
        const prev = s.type==="image" ? (s.image||"(intet)") :
                     s.type==="empties" ? "Tømningstabel" :
                     s.type==="birthday"? "Fødselsdag" :
                     (s.lines||[]).join(" | ");
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${s.type}</td>
          <td>${escapeHtml(s.title||"")}</td>
          <td>${escapeHtml(prev)}</td>
          <td><button class="btn danger" data-del="${idx}">Slet</button></td>`;
        els.slidesTable.appendChild(tr);
      });
      els.slidesTable.querySelectorAll("[data-del]").forEach(b=>{
        b.onclick = () => { state.data.slides.splice(+b.dataset.del,1); renderSlides(); dirty(); };
      });
    }

    function renderBirthdays(){
      els.bdTable.innerHTML = "";
      (state.data.birthdays||[]).forEach((b,idx)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(b.name||"")}</td>
          <td>${escapeHtml(b.date||"")}</td>
          <td>${b.photo?`<a href="${escapeHtml(b.photo)}" target="_blank">link</a>`:""}</td>
          <td><button class="btn danger" data-delbd="${idx}">Slet</button></td>`;
        els.bdTable.appendChild(tr);
      });
      els.bdTable.querySelectorAll("[data-delbd]").forEach(b=>{
        b.onclick = ()=>{ state.data.birthdays.splice(+b.dataset.delbd,1); renderBirthdays(); dirty(); };
      });
    }

    function renderAll(){
      els.dataUrl.value = state.dataUrl;
      els.dataUrlView.textContent = state.dataUrl;
      bindSettings();
      renderSlides();
      renderBirthdays();
      clean();
    }

    // ---------- HELPERS ----------
    function escapeHtml(s){ return (s||"").replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function dirty(msg="Ikke gemt"){ els.status.textContent = msg; document.querySelector(".sticky-save").style.display="inline-flex"; }
    function clean(){ els.status.textContent = "Klar"; document.querySelector(".sticky-save").style.display="none"; }

    // ---------- LOAD / SAVE ----------
    async function load(){
      try{
        els.status.textContent = "Henter...";
        const res = await fetch(state.dataUrl + "?v=" + Date.now());
        state.data = await res.json();
        renderAll();
      }catch(e){
        // init tom hvis ingen fil
        console.warn("Ingen eksisterende data.json – starter tom");
        state.data = {
          brand: "Bredsgaard • Infoskaerm",
          logoUrl:"", logoPos:"Øverst højre",
          media:{baseUrl:"", key:""},
          empties:{weekdays:[true,false,false,false,false],skipDates:[],names:[]},
          birthdays:[], slides:[]
        };
        renderAll();
      }
    }

    async function save(){
      // sync from inputs -> state
      state.data.brand = els.brand.value.trim();
      state.data.logoUrl = els.logoUrl.value.trim();
      state.data.logoPos = els.logoPos.value;
      state.data.media = { baseUrl: els.mediaBase.value.trim(), key: els.mediaKey.value.trim() };

      const weekdays = els.wd.map(cb=>cb.checked);
      const skipDates = (els.skipDates.value||"").split(/[, \n]+/).map(x=>x.trim()).filter(Boolean);
      const names = (els.emptyNames.value||"").split(/[, \n]+/).map(x=>x.trim()).filter(Boolean);
      state.data.empties = { weekdays, skipDates, names };

      try{
        els.status.textContent = "Gemmer…";
        els.saveBtn.disabled = els.saveBtn2.disabled = true;
        const res = await fetch("/api/save", {
          method:"POST", headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(state.data)
        });
        if(!res.ok){
          const t = await res.text();
          throw new Error(t || ("HTTP "+res.status));
        }
        els.status.textContent = "✅ Data gemt på GitHub!";
        els.saveBtn.disabled = els.saveBtn2.disabled = false;
        clean();
      }catch(e){
        els.saveBtn.disabled = els.saveBtn2.disabled = false;
        els.status.textContent = "Fejl: "+ (e.message||e);
      }
    }

    // ---------- UI EVENTS ----------
    els.setUrlBtn.onclick = ()=>{ state.dataUrl = els.dataUrl.value.trim() || DEFAULT_URL; renderAll(); };
    els.loadBtn.onclick = load;
    els.saveBtn.onclick = save;
    els.saveBtn2.onclick = save;
    els.downloadBtn.onclick = ()=>{
      const blob = new Blob([JSON.stringify(state.data,null,2)],{type:"application/json"});
      const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "data.json"; a.click();
    };

    // track dirty
    ["brand","logoUrl","logoPos","mediaBase","mediaKey","skipDates","emptyNames"].forEach(id=>{
      $("#"+id).addEventListener("input",()=>dirty());
    });
    els.wd.forEach(cb=>cb.addEventListener("change",()=>dirty()));

    // slides
    els.addSlide.onclick = ()=>{
      const s = {
        type: els.s_type.value,
        title: els.s_title.value.trim(),
        lines: (els.s_lines.value||"").split("|").map(x=>x.trim()).filter(Boolean),
        image: els.s_image.value.trim(),
        duration: Math.max(3, +els.s_duration.value || 12)
      };
      state.data.slides.push(s);
      renderSlides();
      dirty("Ikke gemt");
    };
    els.clearSlides.onclick = ()=>{
      if(!confirm("Slette alle slides?")) return;
      state.data.slides = [];
      renderSlides();
      dirty();
    };

    // birthdays
    els.addBd.onclick = ()=>{
      const name = els.bd_name.value.trim();
      const date = els.bd_date.value.trim();
      const photo = els.bd_photo.value.trim();
      if(!name || !date) { alert("Navn og dato er påkrævet."); return; }
      state.data.birthdays.push({name,date,photo});
      els.bd_name.value = els.bd_date.value = els.bd_photo.value = "";
      renderBirthdays();
      dirty();
    };

    // init
    (function init(){
      const fromUrl = new URLSearchParams(location.search).get("data");
      if(fromUrl) state.dataUrl = fromUrl;
      els.dataUrl.value = state.dataUrl;
      els.dataUrlView.textContent = state.dataUrl;
      load();
    })();
  </script>
</body>
</html>


