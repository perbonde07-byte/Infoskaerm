<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin • Infoskærm</title>
  <style>
    :root{
      --bg:#0b1220;--panel:#111a2d;--muted:#243147;--text:#e8eefb;--accent:#5aa2ff;
      --ok:#33d17a;--err:#ff6b6b;--sub:#1a2440;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
    a{color:#9ec1ff} .hide{display:none}

    /* Topbar */
    .topbar{position:sticky;top:0;z-index:30;height:64px;background:rgba(15,23,42,.92);backdrop-filter:blur(6px);
      display:flex;align-items:center;gap:10px;padding:0 14px;border-bottom:1px solid rgba(255,255,255,.08)}
    .pill{padding:6px 10px;border-radius:999px;background:#0f1b34;border:1px solid #203258;font-size:12px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;background:var(--accent);color:#061022;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.sub{background:var(--sub);color:#d6e4ff}.btn.small{padding:7px 10px}.btn.danger{background:#aa3c3c;color:#150909}
    .ok{color:var(--ok)} .err{color:var(--err)}
    .wrap{max-width:1100px;margin:18px auto;padding:0 16px 40px}

    .tabs{display:flex;gap:10px;margin:6px 0 14px;flex-wrap:wrap}
    .tabbtn{background:#0f1b34;border:1px solid #203258;color:#cfe1ff;padding:8px 12px;border-radius:999px;cursor:pointer}
    .tabbtn.active{background:#27406e;color:white}

    section{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:16px;margin:14px 0}
    h1{margin:0 0 6px 2px} h2{margin:0 0 12px} label{display:block;margin:10px 0 6px}
    input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--muted);background:#0f172a;color:var(--text);font-size:15px}
    textarea{min-height:92px}
    .row{display:grid;gap:12px}
    .g2{grid-template-columns:1fr 1fr}
    .g3{grid-template-columns:repeat(3,1fr)}
    .inline{display:flex;gap:8px;align-items:flex-start}

    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px 10px;border-bottom:1px solid var(--muted);text-align:left}
    th{opacity:.85}
    .hint{font-size:12px;opacity:.75;margin-top:4px}

    /* Modal (fx. fremtidig filvælger) */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:24px;z-index:1000}
    .modal.open{display:flex}
    .sheet{width:min(1100px,96vw);max-height:90vh;overflow:auto;background:#0f172a;border:1px solid #203258;border-radius:16px;padding:18px;box-shadow:0 10px 35px rgba(0,0,0,.35)}
    .sheet .bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  </style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <strong>Infoskærm • Admin</strong>
    <span class="pill">Data: <code id="dataUrlView"></code></span>
    <button class="btn sub" id="loadBtn">Hent data</button>
    <div class="spacer"></div>
    <input id="adminPin" type="password" placeholder="PIN (valgfri)" style="width:160px;background:#0f1b34;border:1px solid #203258;color:#cfe1ff;border-radius:10px;padding:8px 10px">
    <span id="status" class="pill">Klar</span>
    <button class="btn" id="saveBtn">Gem (API)</button>
    <button class="btn sub" id="downloadBtn">Download data.json</button>
  </div>

  <div class="wrap">
    <div class="tabs">
      <button class="tabbtn active" data-tab="slidesTab">Slides</button>
      <button class="tabbtn" data-tab="emptiesTab">Tømmeplan</button>
      <button class="tabbtn" data-tab="birthdaysTab">Fødselsdage</button>
      <button class="tabbtn" data-tab="settingsTab">Indstillinger</button>
      <button class="tabbtn" data-tab="sourceTab">Datakilde</button>
    </div>

    <!-- Slides -->
    <section id="slidesTab">
      <h2>Slides</h2>
      <div class="inline" style="gap:8px;margin-bottom:10px">
        <button class="btn small sub" id="addImgBtn">+ Billede</button>
        <button class="btn small sub" id="addTxtBtn">+ Tekst</button>
        <button class="btn small sub" id="addEmptyBtn">+ Tømning</button>
        <button class="btn small sub" id="addBdayBtn">+ Fødselsdag</button>
      </div>

      <div class="row g3">
        <div>
          <label>Type</label>
          <select id="s_type">
            <option value="image">Billede (fuldskærm eller m. sidetekst)</option>
            <option value="text">Tekst (overskrift + afsnit)</option>
            <option value="empties">Tømningstabel</option>
            <option value="birthday">Fødselsdage (uge)</option>
          </select>
        </div>
        <div>
          <label>Titel</label>
          <input id="s_title" placeholder="Titel…" />
        </div>
        <div>
          <label>Varighed (sek.)</label>
          <input id="s_duration" type="number" value="12" min="3" />
        </div>
      </div>

      <!-- Tekst -->
      <div id="box_text" class="">
        <label>Tekstindhold (én eller flere linjer/afsnit)</label>
        <textarea id="s_content" placeholder="Afsnit 1&#10;&#10;Afsnit 2"></textarea>
      </div>

      <!-- Billede -->
      <div id="box_image" class="hide">
        <label>Billede URL</label>
        <input id="s_image" placeholder="https://… eller /media/fil.jpg" />
        <label>Valgfri sidetekst (giver 2-kolonne layout)</label>
        <textarea id="s_sideText" placeholder="Overskrift på første linje&#10;Efterfulgt af almindelig tekst…"></textarea>
      </div>

      <div class="inline" style="gap:10px;margin-top:10px">
        <button class="btn" id="addSlide">Tilføj slide</button>
        <button class="btn sub" id="clearSlides">Tøm alle slides</button>
        <span class="hint">Husk: Gem (API) eller Download data.json.</span>
      </div>

      <table>
        <thead><tr><th style="width:42px">#</th><th>Type</th><th>Titel</th><th>Detaljer</th><th style="width:220px">Handling</th></tr></thead>
        <tbody id="slidesTable"></tbody>
      </table>
    </section>

    <!-- Tømmeplan -->
    <section id="emptiesTab" class="hide">
      <h2>Affaldstømning – rotation</h2>
      <div class="row g2">
        <div>
          <label>Startdato</label>
          <input id="emptiesStart" type="date">
        </div>
        <div>
          <label>Horisont (antal kommende linjer)</label>
          <input id="emptiesHorizon" type="number" min="4" max="40" value="8">
        </div>
      </div>

      <label>Ugedage</label>
      <div class="inline" style="gap:16px;flex-wrap:wrap">
        <label><input type="checkbox" class="wd" value="1"> Man</label>
        <label><input type="checkbox" class="wd" value="2"> Tir</label>
        <label><input type="checkbox" class="wd" value="3"> Ons</label>
        <label><input type="checkbox" class="wd" value="4"> Tor</label>
        <label><input type="checkbox" class="wd" value="5"> Fre</label>
      </div>

      <label>Navne (rækkefølge — én pr. linje)</label>
      <textarea id="emptiesNames" placeholder="Per&#10;Louise&#10;Max"></textarea>

      <label>Ekskluder datoer (én pr. linje – dd.mm.yyyy)</label>
      <textarea id="emptiesSkip" placeholder="25.12.2025&#10;01.01.2026"></textarea>

      <label>Kolonner i visning</label>
      <select id="emptiesCols"><option value="1">1 kolonne</option><option value="2" selected>2 kolonner</option></select>
    </section>

    <!-- Fødselsdage -->
    <section id="birthdaysTab" class="hide">
      <h2>Fødselsdage</h2>
      <label>Standard-besked (vises på slide)</label>
      <input id="bdayMsg" placeholder="Tillykke med fødselsdagen!">

      <div id="bdayList"></div>
      <div class="inline" style="gap:10px;margin-top:8px">
        <button class="btn sub" id="bd_add">+ Tilføj person</button>
      </div>
      <div class="hint">Dato kan være <b>dd.mm</b> eller <b>dd.mm.yyyy</b>. Alder vises, hvis årstal er med.</div>
    </section>

    <!-- Indstillinger -->
    <section id="settingsTab" class="hide">
      <h2>Indstillinger</h2>
      <div class="row g2">
        <div>
          <label>Brand (vises nederst på skærmen)</label>
          <input id="brand" placeholder="Bredsgaard • Infoskærm" />
        </div>
        <div>
          <label>Logo URL (valgfrit)</label>
          <input id="logoUrl" placeholder="/media/logo.png" />
        </div>
      </div>

      <div class="row g2">
        <div>
          <label>Baggrund 1</label>
          <input id="bg1" placeholder="#0d4952" />
        </div>
        <div>
          <label>Baggrund 2</label>
          <input id="bg2" placeholder="#0b6a74" />
        </div>
      </div>

      <div class="row g2">
        <div>
          <label>Accentfarve</label>
          <input id="accent" placeholder="#a7d0c9" />
        </div>
        <div>
          <label>Auto-opdatering (ms)</label>
          <input id="refreshMs" type="number" min="60000" step="1000" value="300000" />
        </div>
      </div>

      <div>
        <label>Kalender ICS (valgfrit – bruges på separat kalenderside)</label>
        <input id="calendarUrl" placeholder="https://.../calendar.ics" />
      </div>
    </section>

    <!-- Datakilde -->
    <section id="sourceTab" class="hide">
      <h2>Datakilde</h2>
      <label>Adresse til <code>data.json</code></label>
      <input id="dataUrl" placeholder="/data.json" />
      <div class="inline" style="gap:10px;margin-top:10px">
        <button class="btn sub" id="setUrlBtn">Brug denne adresse</button>
        <button class="btn sub" id="openPreview">Åbn index (ny fane)</button>
      </div>
      <div class="hint">Tip: Adressen gemmes i denne browser. Standard er <code>/data.json</code> (rod i projektet).</div>
    </section>
  </div>

  <!-- Modal-skabelon (scrollbar er aktiv ved stor højde) -->
  <div class="modal" id="genericModal" aria-hidden="true">
    <div class="sheet">
      <div class="bar">
        <strong id="modalTitle">Modal</strong>
        <button class="btn sub" id="modalClose">Luk</button>
      </div>
      <div id="modalBody">Indhold…</div>
    </div>
  </div>

  <script>
    // ====== Utils ======
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const esc = s => String(s ?? '').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    function toLines(v){ return String(v||'').split(/\r?\n/).map(x=>x.trim()).filter(Boolean); }
    function fromLines(a){ return (a||[]).join('\\n'); }

    // ====== State ======
    const state = {
      dataUrl: '/data.json',
      data: {
        brand:'Bredsgaard • Infoskærm',
        logoUrl:'',
        theme:{ bg1:'#0d4952', bg2:'#0b6a74', accent:'#a7d0c9' },
        settings:{ refreshMs:300000 },
        calendar:{ url:'', daysAhead:60, maxEvents:50 },
        empties:{ startDate:'', horizon:8, weekdays:[1], names:[], skipDates:[], columns:2 },
        birthdays:{ message:'Tillykke med fødselsdagen!', people:[] },
        slides:[]
      }
    };

    // ====== Tabs ======
    function showTab(tabId){
      $$('.tabbtn').forEach(b=> b.classList.toggle('active', b.dataset.tab===tabId));
      const map={slidesTab:'slidesTab', emptiesTab:'emptiesTab', birthdaysTab:'birthdaysTab', settingsTab:'settingsTab', sourceTab:'sourceTab'};
      Object.values(map).forEach(id=> $('#'+id).classList.toggle('hide', id!==tabId));
    }
    $$('.tabbtn').forEach(b=> b.addEventListener('click', ()=> showTab(b.dataset.tab)));
    showTab('slidesTab');

    // ====== Render helpers ======
    function renderSlides(){
      const tbody = $('#slidesTable'); tbody.innerHTML='';
      (state.data.slides||[]).forEach((s,idx)=>{
        const detail =
          s.type==='image' ? (s.image||'(intet)') :
          s.type==='text' ? (s.content||'').split(/\\n+/).slice(0,1).join(' ').slice(0,60) :
          s.type==='empties' ? 'Tømningstabel' :
          s.type==='birthday' ? 'Fødselsdage (uge)' : '';
        const tr=document.createElement('tr');
        tr.innerHTML = \`
          <td>\${idx+1}</td>
          <td>\${esc(s.type)}</td>
          <td><input data-k="title" value="\${esc(s.title||'')}" style="width:100%"></td>
          <td>\${esc(detail)}</td>
          <td>
            <div class="inline" style="gap:6px;flex-wrap:wrap">
              <input data-k="duration" type="number" value="\${s.duration||12}" style="width:90px">
              <button class="btn small sub" data-up>Op</button>
              <button class="btn small sub" data-down>Ned</button>
              <button class="btn small danger" data-del>Slet</button>
            </div>
          </td>\`;
        // bind
        tr.querySelector('[data-k="title"]').addEventListener('input',e=>{ s.title=e.target.value; });
        tr.querySelector('[data-k="duration"]').addEventListener('input',e=>{ s.duration=Math.max(3, Number(e.target.value||12)); });
        tr.querySelector('[data-up]').onclick=()=>{ if(idx>0){ const t=state.data.slides[idx-1]; state.data.slides[idx-1]=state.data.slides[idx]; state.data.slides[idx]=t; renderSlides(); } };
        tr.querySelector('[data-down]').onclick=()=>{ if(idx<state.data.slides.length-1){ const t=state.data.slides[idx+1]; state.data.slides[idx+1]=state.data.slides[idx]; state.data.slides[idx]=t; renderSlides(); } };
        tr.querySelector('[data-del]').onclick=()=>{ state.data.slides.splice(idx,1); renderSlides(); };
        tbody.appendChild(tr);
      });
    }
    function renderBirthdays(){
      const host = $('#bdayList'); host.innerHTML='';
      (state.data.birthdays?.people||[]).forEach((p,i)=>{
        const idImg = 'bd_img_'+i;
        const row = document.createElement('div');
        row.className='row g3';
        row.innerHTML = \`
          <div><label>Navn</label><input data-k="name" value="\${esc(p.name||'')}"></div>
          <div><label>Dato (dd.mm eller dd.mm.yyyy)</label><input data-k="date" value="\${esc(p.date||'')}"></div>
          <div><label>Billede URL (valgfrit)</label><input id="\${idImg}" data-k="image" value="\${esc(p.image||'')}" placeholder="/medarbejdere/Per.jpg"></div>\`;
        row.addEventListener('input', e=>{ const k=e.target.dataset.k; if(k) p[k]=e.target.value; });
        host.appendChild(row);
      });
    }
    function renderAll(){
      // Settings
      $('#brand').value = state.data.brand||'';
      $('#logoUrl').value = state.data.logoUrl||'';
      $('#bg1').value = state.data.theme?.bg1||'#0d4952';
      $('#bg2').value = state.data.theme?.bg2||'#0b6a74';
      $('#accent').value = state.data.theme?.accent||'#a7d0c9';
      $('#refreshMs').value = state.data.settings?.refreshMs||300000;
      $('#calendarUrl').value = state.data.calendar?.url||'';

      // Empties
      $('#emptiesStart').value = state.data.empties?.startDate||'';
      $('#emptiesHorizon').value = state.data.empties?.horizon||8;
      $$('.wd').forEach(cb=> cb.checked = (state.data.empties?.weekdays||[]).includes(Number(cb.value)));
      $('#emptiesNames').value = fromLines(state.data.empties?.names||[]);
      $('#emptiesSkip').value  = fromLines(state.data.empties?.skipDates||[]);
      $('#emptiesCols').value  = String(state.data.empties?.columns||2);

      // Birthdays
      $('#bdayMsg').value = state.data.birthdays?.message||'';
      renderBirthdays();

      // Slides
      renderSlides();

      // data-url visning
      $('#dataUrl').value = state.dataUrl;
      $('#dataUrlView').textContent = state.dataUrl;
    }

    // ====== Load / Save ======
    async function load(){
      try{
        $('#status').textContent='Henter…';
        const res = await fetch(state.dataUrl + '?v=' + Date.now());
        if(!res.ok) throw new Error('HTTP '+res.status);
        const j = await res.json();
        // migrate defaults
        const base = JSON.parse(JSON.stringify(state.data));
        state.data = Object.assign(base, j||{});
        // sikre struktur
        state.data.theme ||= { bg1:'#0d4952', bg2:'#0b6a74', accent:'#a7d0c9' };
        state.data.settings ||= { refreshMs:300000 };
        state.data.calendar ||= { url:'', daysAhead:60, maxEvents:50 };
        state.data.empties ||= { startDate:'', horizon:8, weekdays:[1], names:[], skipDates:[], columns:2 };
        state.data.birthdays ||= { message:'', people:[] };
        state.data.slides ||= [];
        // gamle bullets → text
        state.data.slides.forEach(s=>{
          if(s.type==='bullets'){ s.type='text'; s.content = Array.isArray(s.lines) ? s.lines.join('\\n') : (s.lines||''); delete s.lines; }
        });

        renderAll();
        $('#status').innerHTML = '<span class="ok">Data hentet</span>';
      }catch(e){
        $('#status').innerHTML = '<span class="err">Kunne ikke hente – starter tomt</span>';
        // behold tom default
        renderAll();
      }
    }

    async function saveViaApi(){
      try{
        $('#status').textContent='Gemmer (API)…';
        const pin = $('#adminPin').value.trim();
        const res = await fetch('/api/save', {
          method:'POST',
          headers:{ 'Content-Type':'application/json', ...(pin?{'x-admin-pin':pin}:{}) },
          body: JSON.stringify(state.data)
        });
        const txt = await res.text();
        if(!res.ok){
          let msg = txt; try{ const j=JSON.parse(txt); msg=j.error||j.detail||txt; }catch{}
          throw new Error('HTTP '+res.status+' – '+msg);
        }
        $('#status').innerHTML = '<span class="ok">✅ Gemt via API</span>';
        alert('Gemt via API ✔');
      }catch(e){
        $('#status').innerHTML = '<span class="err">Gem (API) fejlede</span>';
        alert('Gem (API) fejlede:\\n\\n'+(e.message||e));
      }
    }

    function downloadData(){
      const blob = new Blob([JSON.stringify(state.data,null,2)],{type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'data.json'; a.click();
      $('#status').innerHTML = '<span class="ok">Download klar</span>';
    }

    // ====== Slide-creator UI toggle ======
    function toggleTypeUI(){
      const t = $('#s_type').value;
      $('#box_text').classList.toggle('hide', t!=='text');
      $('#box_image').classList.toggle('hide', t!=='image');
    }

    // ====== Events ======
    $('#setUrlBtn').onclick = ()=>{ state.dataUrl = ($('#dataUrl').value||'/data.json').trim(); $('#dataUrlView').textContent = state.dataUrl; localStorage.setItem('admin_data_url', state.dataUrl); };
    $('#openPreview').onclick = ()=>{ window.open('/index.html', '_blank'); };
    $('#loadBtn').onclick = load;
    $('#saveBtn').onclick = saveViaApi;
    $('#downloadBtn').onclick = downloadData;

    $('#s_type').addEventListener('change', toggleTypeUI);
    toggleTypeUI();

    $('#addImgBtn').onclick = ()=>{ state.data.slides.push({type:'image', title:'Kampagne', image:'', sideText:'', duration:12}); renderSlides(); };
    $('#addTxtBtn').onclick  = ()=>{ state.data.slides.push({type:'text', title:'Info', content:'', duration:12}); renderSlides(); };
    $('#addEmptyBtn').onclick= ()=>{ state.data.slides.push({type:'empties', title:'TØMNINGS DAGE', duration:12}); renderSlides(); };
    $('#addBdayBtn').onclick = ()=>{ state.data.slides.push({type:'birthday', title:'FØDSELSDAG', duration:12}); renderSlides(); };

    $('#addSlide').onclick = ()=>{
      const t = $('#s_type').value;
      const s = { type:t, title:($('#s_title').value||'').trim(), duration:Math.max(3, +$('#s_duration').value||12) };
      if(t==='text'){ s.content = ($('#s_content').value||'').trim(); if(!s.content) return alert('Skriv noget tekst.'); }
      if(t==='image'){
        const img = ($('#s_image').value||'').trim();
        if(!img) return alert('Angiv billede-URL.');
        s.image = img;
        s.sideText = ($('#s_sideText').value||'').trim();
      }
      // empties/birthday kræver ikke ekstra felter
      state.data.slides.push(s);
      // reset inputs (kun for convenience)
      $('#s_title').value=''; $('#s_duration').value='12'; $('#s_content').value=''; $('#s_image').value=''; $('#s_sideText').value='';
      renderSlides();
    };

    $('#clearSlides').onclick = ()=>{ if(confirm('Slet alle slides?')){ state.data.slides=[]; renderSlides(); } };

    $('#bd_add').onclick = ()=>{
      state.data.birthdays ||= { message:'', people:[] };
      state.data.birthdays.people ||= [];
      state.data.birthdays.people.push({ name:'', date:'', image:'' });
      renderBirthdays();
    };

    // Empties inputs -> state samles først ved GEM/download
    function syncFromInputs(){
      // Settings
      state.data.brand = $('#brand').value.trim();
      state.data.logoUrl = $('#logoUrl').value.trim();
      state.data.theme = { bg1: $('#bg1').value.trim(), bg2: $('#bg2').value.trim(), accent: $('#accent').value.trim() };
      state.data.settings = { refreshMs: Math.max(60000, Number($('#refreshMs').value||300000)) };
      state.data.calendar = { url: $('#calendarUrl').value.trim(), daysAhead:60, maxEvents:50 };

      // Empties
      state.data.empties = {
        startDate: $('#emptiesStart').value || '',
        horizon: Math.max(4, Math.min(40, Number($('#emptiesHorizon').value||8))),
        weekdays: $$('.wd').filter(cb=>cb.checked).map(cb=>Number(cb.value)),
        names: toLines($('#emptiesNames').value),
        skipDates: toLines($('#emptiesSkip').value),
        columns: Number($('#emptiesCols').value||2)
      };

      // Birthdays
      const ppl=[];
      const list = $('#bdayList');
      list.querySelectorAll('.row.g3').forEach(r=>{
        ppl.push({
          name: r.querySelector('[data-k="name"]').value.trim(),
          date: r.querySelector('[data-k="date"]').value.trim(),
          image: r.querySelector('[data-k="image"]').value.trim(),
        });
      });
      state.data.birthdays = { message: $('#bdayMsg').value.trim(), people: ppl.filter(p=>p.name) };
    }

    // Hook save/download to sync inputs first
    $('#saveBtn').addEventListener('click', ()=>{ syncFromInputs(); });
    $('#downloadBtn').addEventListener('click', ()=>{ syncFromInputs(); });

    // ====== Init ======
    (function init(){
      const stored = localStorage.getItem('admin_data_url') || '';
      state.dataUrl = stored || '/data.json';
      $('#dataUrl').value = state.dataUrl;
      $('#dataUrlView').textContent = state.dataUrl;
      load();
    })();

    // ====== Modal demo (ikke i brug nu, men klar – med scroll) ======
    const modal = $('#genericModal'); const modalClose=$('#modalClose');
    modalClose.onclick = ()=> modal.classList.remove('open');
    // Åbn sådan her når/ hvis du vil bruge den:
    // function openModal(title, html){ $('#modalTitle').textContent=title; $('#modalBody').innerHTML=html; modal.classList.add('open'); }
  </script>
</body>
</html>
