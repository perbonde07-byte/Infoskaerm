<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <title>Admin • Infoskaerm</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b1220; --fg:#e8eefb; --muted:#9fb2d1; --acc:#5aa2ff; --card:#111a2d;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;
    }
    .wrap{
      max-width:1100px; margin: 28px auto; padding:0 14px;
    }
    h1{font-size:20px; margin:0 0 16px}
    .card{
      background:var(--card); border:1px solid rgba(255,255,255,.06);
      border-radius:12px; padding:16px; margin-bottom:18px;
    }
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    label{display:block; font-size:13px; color:var(--muted); margin:4px 0}
    input,select,textarea{
      width:100%; background:#0e172a; color:var(--fg); border:1px solid rgba(255,255,255,.08);
      border-radius:10px; padding:10px 12px; font-size:14px; outline:none;
    }
    textarea{min-height:110px; resize:vertical}
    button{
      background:var(--acc); color:white; border:0; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer;
    }
    .ghost{background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,.12)}
    .hint{font-size:13px; color:var(--muted)}
    table{width:100%; border-collapse:collapse; font-size:14px; margin-top:10px}
    th, td{padding:10px 8px; border-top:1px solid rgba(255,255,255,.06)}
    th{color:var(--muted); font-weight:600; text-align:left}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    .ok{color:#7ce38b}
    .err{color:#ff7f7f}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Admin • Infoskaerm</h1>

  <!-- DATASOURCE -->
  <div class="card">
    <div class="row">
      <div>
        <label for="data_url">Adresse til <b>data.json</b></label>
        <input id="data_url" value="https://perbonde07-byte.github.io/Infoskaerm/data.json" />
      </div>
    </div>
    <div class="actions" style="margin-top:12px">
      <button id="loadBtn" class="ghost">Hent data</button>
      <button id="downloadBtn" class="ghost">Download ny data.json</button>
      <button id="saveServerBtn">Gem til server</button>
      <span id="status" class="hint">Klar</span>
    </div>
  </div>

  <!-- SLIDES -->
  <div class="card">
    <h3 style="margin:4px 0 12px">Slides</h3>
    <div class="row">
      <div>
        <label>Type</label>
        <select id="s_type">
          <option value="bullets">bullets (punktliste)</option>
          <option value="image">image (fuldskærmsbillede)</option>
        </select>
      </div>
      <div>
        <label>Titel</label>
        <input id="s_title" placeholder="Titel…" />
      </div>
      <div>
        <label>Linjer (brug `|` til flere)</label>
        <textarea id="s_lines" placeholder="Punkt 1 | Punkt 2 | Punkt 3"></textarea>
      </div>
      <div>
        <label>Billede (URL) – kun for type=image</label>
        <div class="actions">
          <input id="s_image" placeholder="https://… (eller vælg fra liste)" style="flex:1" />
          <button id="mediaBtn" class="ghost" type="button">Hent medieliste</button>
        </div>
        <select id="media_list" style="margin-top:6px; display:none"></select>
      </div>
      <div>
        <label>Varighed (sek.)</label>
        <input id="s_duration" type="number" min="3" value="12" />
      </div>
    </div>
    <div class="actions" style="margin-top:12px">
      <button id="addSlide">Tilføj slide</button>
      <button id="clearSlides" class="ghost">Tøm alle slides</button>
    </div>

    <table id="slidesTable">
      <thead>
        <tr><th>#</th><th>Type</th><th>Titel</th><th>Forhåndsvisning</th><th></th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
  // === LILLE "GATE" MED ADMIN-NØGLE ===================================
  const ADMIN_KEY = "0705";
  (function gate(){
    const p = new URLSearchParams(location.search).get('admin');
    if (p === ADMIN_KEY) localStorage.setItem('admin_ok', '1');
    if (localStorage.getItem('admin_ok') !== '1') {
      document.body.innerHTML =
        '<div style="display:flex;align-items:center;justify-content:center;height:100vh;background:#0b1220;color:#e8eefb;font-family:system-ui">Ingen adgang – åbn med ?admin=0705</div>';
    }
  })();

  // === STATE ===========================================================
  const state = {
    dataUrl: document.getElementById('data_url').value,
    data: { brand: 'Bredsgaard Info', slides: [] }
  };

  const $ = s => document.querySelector(s);
  const statusEl = $('#status');
  const typeEl = $('#s_type');
  const imageEl = $('#s_image');

  // Skift aktivering af billed-URL hvis type= image
  function toggleImageInput(){
    const isImage = typeEl.value === 'image';
    imageEl.disabled = !isImage;
  }
  typeEl.addEventListener('change', toggleImageInput);
  toggleImageInput();

  // RENDER tabel
  function render(){
    const tbody = $('#slidesTable tbody'); tbody.innerHTML = '';
    state.data.slides.forEach((s, i) => {
      const tr = document.createElement('tr');
      const preview = s.type === 'image' ? (s.image || '') : (s.lines || []).join(' | ');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${s.type}</td>
        <td>${s.title || ''}</td>
        <td>${preview}</td>
        <td><button data-i="${i}" class="ghost del-slide">Slet</button></td>
      `;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll('.del-slide').forEach(b => b.onclick = e => {
      const idx = +e.target.dataset.i;
      state.data.slides.splice(idx, 1);
      render();
    });
    statusEl.textContent = 'Klar';
    statusEl.className = 'hint ok';
  }

  // HENT data.json
  async function load(){
    try {
      state.dataUrl = $('#data_url').value.trim();
      statusEl.textContent = 'Henter data…';
      const res = await fetch(state.dataUrl + '?v=' + Date.now());
      if (res.ok) {
        state.data = await res.json();
        render();
      } else {
        throw new Error('HTTP ' + res.status);
      }
    } catch (e) {
      statusEl.textContent = 'Ingen/ugyldig data.json – starter tomt';
      state.data = { brand: 'Bredsgaard Info', slides: [] };
      render();
    }
  }

  // GEM LOKAL KOPI (download)
  function downloadLocal(){
    const blob = new Blob([JSON.stringify(state.data, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'data.json';
    a.click();
  }

  // GEM TIL SERVER (GitHub via Vercel /api/save)
  async function saveToServer(){
    try{
      statusEl.textContent = 'Gemmer til server…';
      const res = await fetch('/api/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(state.data)
      });
      if (!res.ok) {
        const t = await res.text();
        alert('Fejl under gemning: ' + t);
        statusEl.textContent = 'Fejl';
        statusEl.className = 'hint err';
        return;
      }
      await res.json();
      statusEl.textContent = 'Gemt ✔';
      statusEl.className = 'hint ok';
    } catch (err) {
      alert('Fejl: ' + err.message);
      statusEl.textContent = 'Fejl';
      statusEl.className = 'hint err';
    }
  }

  // HENT MEDIELISTE
  async function loadMediaList(){
    try{
      const btn = $('#mediaBtn');
      btn.disabled = true; btn.textContent = 'Henter…';
      const res = await fetch('/api/media-list');
      const out = await res.json();
      const sel = $('#media_list');
      sel.innerHTML = '';
      (out.items || []).forEach(item => {
        const o = document.createElement('option');
        o.value = item.url;
        o.textContent = `${item.name} (${Math.round(item.size/1024)} KB)`;
        sel.appendChild(o);
      });
      sel.style.display = 'block';
      sel.onchange = () => { imageEl.value = sel.value; };
      btn.textContent = 'Hent medieliste';
      btn.disabled = false;
    } catch (e){
      alert('Kunne ikke hente medieliste: ' + e.message);
      const btn = $('#mediaBtn');
      btn.textContent = 'Hent medieliste';
      btn.disabled = false;
    }
  }

  // UI handlers
  $('#loadBtn').onclick = load;
  $('#downloadBtn').onclick = downloadLocal;
  $('#saveServerBtn').onclick = saveToServer;
  $('#mediaBtn').onclick = loadMediaList;

  $('#addSlide').onclick = () => {
    const s = {
      type: $('#s_type').value,
      title: $('#s_title').value.trim(),
      lines: ($('#s_lines').value || '')
        .split('|').map(x => x.trim()).filter(Boolean),
      image: $('#s_image').value.trim(),
      duration: +($('#s_duration').value) || 12
    };
    if (s.type === 'image' && !s.image) {
      alert('For "image" skal du vælge/angive et billed-URL');
      return;
    }
    if (s.type !== 'image') s.image = '';
    state.data.slides.push(s); render();
  };

  $('#clearSlides').onclick = () => {
    if (confirm('Slet alle slides?')) { state.data.slides = []; render(); }
  };

  // Init
  load();
</script>
</body>
</html>
