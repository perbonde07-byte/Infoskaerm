<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin • Infoskaerm</title>

  <!-- === ADMIN GATE === -->
  <script>
    const ADMIN_KEY = "0705";

    (function gate() {
      try {
        const Q = new URLSearchParams(location.search);
        const pinFromUrl = (Q.get("admin") || "").trim();

        if (pinFromUrl && pinFromUrl === ADMIN_KEY) {
          localStorage.setItem("admin_ok", "1");
          const url = new URL(location.href);
          url.searchParams.delete("admin");
          location.replace(url.toString());
          return;
        }

        if (localStorage.getItem("admin_ok") === "1") return;

        const html = `
          <style>
            html,body{height:100%;margin:0}
            body{background:#0b1220;color:#e8eefb;font-family:system-ui,Segoe UI,Roboto,Arial;
                 display:flex;align-items:center;justify-content:center}
            .card{width:min(92vw,420px);background:#111a2d;border:1px solid rgba(255,255,255,.1);
                  border-radius:16px;padding:24px;text-align:center}
            h1{font-size:22px;margin:0 0 8px}
            p{opacity:.8;margin:0 0 16px}
            input{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #243147;
                  background:#0f172a;color:#e8eefb;font-size:16px;letter-spacing:0.2em;text-align:center}
            button{margin-top:12px;width:100%;padding:12px 14px;border:0;border-radius:10px;
                   background:#5aa2ff;color:#061022;font-weight:600;font-size:15px;cursor:pointer}
            .hint{margin-top:10px;font-size:12px;opacity:.7}
          </style>
          <div class="card">
            <h1>Ingen adgang</h1>
            <p>Indtast kode for at åbne admin.</p>
            <input id="pin" placeholder="Kode" inputmode="numeric" autocomplete="one-time-code" />
            <button id="ok">Log ind</button>
            <div class="hint">Tip: du kan også åbne med <code>?admin=${ADMIN_KEY}</code></div>
          </div>
        `;
        document.documentElement.innerHTML = html;

        addEventListener("click", (e) => {
          if (e.target && e.target.id === "ok") tryLogin();
        });
        addEventListener("keydown", (e) => {
          if (e.key === "Enter") tryLogin();
        });

        function tryLogin() {
          const val = (document.getElementById("pin").value || "").trim();
          if (val === ADMIN_KEY) {
            localStorage.setItem("admin_ok", "1");
            location.reload();
          } else {
            alert("Forkert kode");
          }
        }
      } catch (err) {
        console.error("Admin-gate fejl:", err);
      }
    })();
  </script>
  <!-- === /ADMIN GATE === -->

  <style>
    body {
      background: #0b1220;
      color: #e8eefb;
      font-family: system-ui, Segoe UI, Roboto, Arial;
      margin: 0;
      padding: 20px;
    }
    h1 { text-align: center; margin-bottom: 20px; }
    section { background: #111a2d; border-radius: 12px; padding: 20px; margin-bottom: 25px; }
    label { display: block; margin-top: 10px; }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #243147;
      background: #0f172a;
      color: #e8eefb;
      font-size: 15px;
    }
    button {
      margin-top: 10px;
      background: #5aa2ff;
      color: #061022;
      border: 0;
      border-radius: 8px;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 600;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    td, th { border-bottom: 1px solid #243147; padding: 6px 8px; }
    th { text-align: left; opacity: 0.8; }
    #status { margin-top: 10px; font-size: 14px; opacity: 0.8; }
  </style>
</head>

<body>
  <h1>Admin • Infoskaerm</h1>

  <section>
    <h3>Datakilde</h3>
    <p>Adresse til data.json</p>
    <input id="dataUrl" value="https://perbonde07-byte.github.io/Infoskaerm/data.json" />
    <button id="loadBtn">Hent data</button>
    <button id="downloadBtn">Download ny data.json</button>
    <button id="saveServerBtn">Gem til server</button>
    <div id="status"></div>
  </section>

  <section>
    <h3>Slides</h3>
    <label>Type</label>
    <select id="s_type">
      <option value="bullets">bullets (punktliste)</option>
      <option value="image">image (fuldskærmsbillede)</option>
    </select>

    <label>Titel</label>
    <input id="s_title" placeholder="Titel..." />

    <label>Linjer (brug | til flere)</label>
    <textarea id="s_lines" rows="3" placeholder="Punkt 1 | Punkt 2 | Punkt 3"></textarea>

    <label>Billede (URL eller upload)</label>
    <input id="s_image" placeholder="https://..." />
    <input type="file" id="imgUpload" accept="image/*" />
    <button id="uploadBtn">Upload billede</button>

    <label>Varighed (sek.)</label>
    <input id="s_duration" type="number" value="12" />

    <button id="addSlide">Tilføj slide</button>
    <button id="clearSlides">Tøm alle slides</button>

    <table id="slidesTable">
      <thead><tr><th>#</th><th>Type</th><th>Titel</th><th>Forhåndsvisning</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <script>
    const state = {
      dataUrl: document.getElementById('dataUrl').value,
      data: { brand: "Bredsgaard Info", slides: [] }
    };
    const $ = (s) => document.querySelector(s);
    const status = $('#status');

    function render() {
      const tbody = $('#slidesTable tbody');
      tbody.innerHTML = '';
      state.data.slides.forEach((s, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${s.type}</td>
          <td>${s.title}</td>
          <td>${s.type === 'image' ? (s.image || '(intet)') : (s.lines || []).join(' | ')}</td>
          <td><button data-i="${i}" class="del-slide">Slet</button></td>
        `;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('.del-slide').forEach(b => b.onclick = e => {
        const i = +e.target.dataset.i;
        state.data.slides.splice(i, 1);
        render();
      });
    }

    async function load() {
      try {
        status.textContent = 'Henter data...';
        const res = await fetch(state.dataUrl + '?v=' + Date.now());
        if (res.ok) {
          state.data = await res.json();
          render();
          status.textContent = 'Data hentet';
        } else throw new Error('HTTP ' + res.status);
      } catch (e) {
        state.data = { brand: 'Bredsgaard Info', slides: [] };
        render();
        status.textContent = 'Ingen eksisterende data.json – starter tomt';
      }
    }

    $('#loadBtn').onclick = load;
    $('#addSlide').onclick = () => {
      const s = {
        type: $('#s_type').value,
        title: $('#s_title').value.trim(),
        lines: ($('#s_lines').value || '').split('|').map(x => x.trim()).filter(Boolean),
        image: $('#s_image').value.trim(),
        duration: +$('#s_duration').value || 12
      };
      state.data.slides.push(s);
      render();
    };
    $('#clearSlides').onclick = () => { if (confirm('Slet alt?')) { state.data.slides = []; render(); } };
    $('#downloadBtn').onclick = () => {
      const blob = new Blob([JSON.stringify(state.data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'data.json';
      a.click();
    };

    $('#saveServerBtn').onclick = async () => {
      try {
        status.textContent = 'Gemmer til server...';
        const res = await fetch('/api/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(state.data)
        });
        const text = await res.text();
        if (!res.ok) throw new Error(text);
        status.textContent = '✅ Data gemt på GitHub!';
      } catch (err) {
        status.textContent = 'Fejl under gemning: ' + err.message;
      }
    };

    $('#uploadBtn').onclick = async () => {
      const file = $('#imgUpload').files[0];
      if (!file) return alert('Vælg et billede først.');
      const reader = new FileReader();
      reader.onload = async (e) => {
        const base64 = e.target.result.split(',')[1];
        const res = await fetch('/api/upload-image', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: file.name, data: base64 })
        });
        const r = await res.json();
        if (r.ok) {
          $('#s_image').value = r.cdnUrl;
          alert('✅ Upload gennemført!');
        } else alert('Fejl: ' + (r.error || 'ukendt'));
      };
      reader.readAsDataURL(file);
    };

    load();
  </script>
</body>
</html>
