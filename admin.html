<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin • Infoscreen</title>
<style>
  /* =================== PB-DESIGN: KLASSISK LAYOUT =================== */
  :root{
    --bg:#0d4952; --panel:#0c2d33; --muted:#0f3b44; --ink:#e9fbff; --dim:#a8d7de; --ok:#1f9d68; --bad:#d35a5a;
    --gap:14px; --radius:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{max-width:1100px;margin:18px auto 10px;padding:0 18px;display:flex;align-items:center;justify-content:space-between}
  h1{margin:0;font-weight:800;letter-spacing:.02em}
  .top-actions{display:flex;gap:8px}
  .btn{background:#173c43;border:1px solid #0a2328;color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer}
  .btn:hover{filter:brightness(1.08)}
  .btn.ok{background:var(--ok)}
  .btn.bad{background:#5a1f1f;border-color:#411515}
  .wrap{max-width:1100px;margin:0 auto 80px;padding:0 18px;display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .panel{background:var(--panel);border:1px solid #0a2328;border-radius:var(--radius);padding:18px;box-shadow:0 0 0 1px #0003 inset}
  .panel h2{margin:0 0 10px 0;font-size:18px;letter-spacing:.03em}
  label{display:block;font-size:13px;color:var(--dim);margin:10px 0 6px}
  input[type=text],input[type=number],input[type=date],textarea,select{
    width:100%;border-radius:10px;border:1px solid #18424a;background:#0a2328;color:var(--ink);padding:10px 12px
  }
  textarea{min-height:90px;resize:vertical}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .row>*{flex:1}
  .pill{padding:6px 10px;border-radius:999px;background:#113942;border:1px solid #0d2e35;color:#c5ecf2;font-size:12px}
  .footer{position:sticky;bottom:0;background:linear-gradient(180deg,#0c2d33cc,#0c2d33);backdrop-filter:blur(6px);border-top:1px solid #0a2328;padding:10px 18px;display:flex;justify-content:flex-end;gap:10px}
  @media (max-width:900px){ .wrap{grid-template-columns:1fr} }

  /* =================== PB-DESIGN: MODAL TIL FILER =================== */
  .modal{position:fixed;inset:0;background:#0007;display:none;align-items:center;justify-content:center;padding:24px}
  .modal.open{display:flex}
  .sheet{max-width:1100px;width:100%;background:#092b30;border:1px solid #0a2328;border-radius:14px;padding:18px}
  .sheet h3{margin:0 0 10px}
  .sheet .bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .tabbar{display:flex;gap:6px}
  .tab{padding:8px 12px;border-radius:999px;border:1px solid #0a2328;background:#0b2a30;color:#bfe3e8;cursor:pointer}
  .tab.active{background:#14505a;color:white}
  .list{border:1px solid #0a2328;border-radius:12px;overflow:hidden}
  .list table{width:100%;border-collapse:collapse}
  .list th,.list td{border-bottom:1px solid #0a2328;padding:10px 12px;text-align:left}
  .list th{background:#0b2a30;color:#a6c6cb;font-weight:700;letter-spacing:.06em;font-size:12px}
  .fit{width:1%}
  .thumb{width:64px;height:64px;border-radius:10px;object-fit:cover;border:1px solid #0a2328;background:#062026}
  .soft{opacity:.85}
</style>
</head>
<body>
  <header>
    <h1>Admin • Infoscreen</h1>
    <div class="top-actions">
      <button class="btn" id="openFiles">Filer (medarb & media)</button>
    </div>
  </header>

  <div class="wrap">

    <!-- Brand / Tema -->
    <section class="panel">
      <h2>Brand</h2>
      <label>Brand</label>
      <input id="brand" type="text" placeholder="Bredsgaard • Infoskærm"/>
      <label>Logo URL</label>
      <div class="row">
        <input id="logoUrl" type="text" placeholder="/media/Bredsgaard-logo transparnt.png"/>
        <button class="btn" data-pick="#logoUrl">Vælg fra filer</button>
      </div>
      <div style="height:1px;background:#0a2328;margin:16px -18px"></div>
      <h2>Tema</h2>
      <div class="row">
        <div><label>Baggrund 1</label><input id="bg1" type="text" placeholder="#0f2b8a"></div>
        <div><label>Baggrund 2</label><input id="bg2" type="text" placeholder="#0a1e66"></div>
        <div><label>Accent</label><input id="accent" type="text" placeholder="#2bb673"></div>
      </div>
      <label>Opdaterings-interval (ms)</label>
      <input id="refreshMs" type="number" min="60000" step="1000" value="300000"/>
    </section>

    <!-- Affaldstømning -->
    <section class="panel">
      <h2>Affaldstømning (automatisk plan)</h2>
      <div class="row">
        <div>
          <label>Startdato</label>
          <input id="emptiesStart" type="date">
        </div>
        <div>
          <label>Horizon (antal kommende linjer)</label>
          <input id="emptiesHorizon" type="number" min="2" max="20" value="8">
        </div>
      </div>
      <label>Ugedage</label>
      <div class="row">
        <label class="pill"><input type="checkbox" class="wd" value="1" checked> MAN</label>
        <label class="pill"><input type="checkbox" class="wd" value="2"> TIR</label>
        <label class="pill"><input type="checkbox" class="wd" value="3"> ONS</label>
        <label class="pill"><input type="checkbox" class="wd" value="4"> TOR</label>
        <label class="pill"><input type="checkbox" class="wd" value="5"> FRE</label>
      </div>
      <label>Navne (rækkefølge — en pr. linje)</label>
      <textarea id="emptiesNames" placeholder="Per&#10;Louise&#10;Max"></textarea>
      <label>Ekskluder datoer (en pr. linje — dd.mm.yyyy)</label>
      <textarea id="emptiesSkip" placeholder="25.12.2025&#10;01.01.2026"></textarea>
      <label>Antal kolonner i visning</label>
      <select id="emptiesCols">
        <option value="1">1 kolonne</option>
        <option value="2" selected>2 kolonner</option>
      </select>
    </section>

    <!-- Fødselsdage -->
    <section class="panel" style="grid-column:1 / -1">
      <h2>Fødselsdage</h2>
      <label>Standard-besked (bruges i alarm-slides)</label>
      <input id="bdayMsg" type="text" placeholder="Tillykke med fødselsdagen - Håber du har dig en god uge.">
      <div id="bdayList"></div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="addBday">+ Tilføj person</button>
      </div>
      <small style="color:#99cbd1;display:block;margin-top:8px">Dato kan være dd.mm eller dd.mm.yyyy. Visningen viser både fødselsdato og alder (PB-DESIGN).</small>
    </section>

  </div>

  <div class="footer">
    <input id="adminPin" type="password" placeholder="PIN (ADMIN_PIN)" style="max-width:200px">
    <button class="btn ok" id="saveBtn">Gem ændringer</button>
  </div>

  <!-- =================== PB-DESIGN: MODAL – FILER =================== -->
  <div class="modal" id="fileModal" aria-hidden="true">
    <div class="sheet">
      <div class="bar">
        <h3>Filer</h3>
        <div>
          <button class="btn" data-tab="medarbejdere">/medarbejdere</button>
          <button class="btn" data-tab="media">/media</button>
          <button class="btn bad" id="closeFiles">Luk</button>
        </div>
      </div>

      <div class="row">
        <div class="pill">Ny fil</div>
        <input id="upName" type="text" placeholder="Navn.jpg" style="flex:0 0 220px">
        <input id="upFile" type="file" accept="image/*" style="flex:1">
        <button class="btn ok" id="btnUpload" style="flex:0 0 130px">Upload</button>
        <span id="upHint" class="soft"></span>
      </div>

      <div class="list" style="margin-top:10px">
        <table id="fileTable">
          <thead>
            <tr>
              <th class="fit"></th>
              <th>Navn</th>
              <th>Sti</th>
              <th class="fit">Brug</th>
              <th class="fit">Omdøb</th>
              <th class="fit">Slet</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="opStatus" class="soft" style="margin-top:8px"></div>
    </div>
  </div>

<script>
/* ======================================================================
   PB-DESIGN: ADMIN-LOGIK
   - Loader/saver data.json (Brand/Tema/Affald/Fødselsdage)
   - Modal: filhåndtering (CRUD) for /medarbejdere og /media
   - “Vælg fra filer” kan udfylde et input (fx logo eller fødselsdagsbillede)
   ====================================================================== */

const $  = (q, el=document) => el.querySelector(q);
const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));

// ---------- API helper ----------
async function api(action, payload){
  const r = await fetch("/api/data", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ action, ...(payload||{}) })
  });
  const j = await r.json();
  if(!j.ok) throw new Error(j.error || "Ukendt fejl");
  return j;
}
async function loadData(){
  const r = await fetch("/api/data");
  const j = await r.json();
  if(!j.ok) throw new Error(j.error || "Kunne ikke hente data.json");
  return j.content;
}
function toLines(el){ return (el.value||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean) }
function fromLines(arr){ return (arr||[]).join("\n") }

// ---------- Fødselsdage – repeater ----------
function renderBdays(bdays){
  const host = $("#bdayList");
  host.innerHTML = "";
  (bdays||[]).forEach((p, idx) => {
    const row = document.createElement("div");
    row.className = "row";
    row.style.marginTop = "8px";
    const id = "img_"+idx;
    row.innerHTML = `
      <input type="text" placeholder="Navn" value="${p.name||""}" data-k="name">
      <input type="text" placeholder="dd.mm eller dd.mm.yyyy" value="${p.date||""}" data-k="date" style="max-width:220px">
      <input id="${id}" type="text" placeholder="/medarbejdere/Per.jpg" value="${p.image||""}" data-k="image">
      <button class="btn" data-pick="#${id}">Vælg fra filer</button>
      <button class="btn bad" data-del>&times; Fjern</button>`;
    row.addEventListener("input", e=>{
      const k = e.target.dataset.k;
      if(!k) return;
      p[k] = e.target.value.trim();
    });
    row.querySelector("[data-del]").onclick = ()=>{
      bdays.splice(idx,1); renderBdays(bdays);
    };
    row.querySelector("[data-pick]").onclick = (ev)=>{
      const target = ev.currentTarget.getAttribute("data-pick");
      openFileModal("medarbejdere", target);
    };
    host.appendChild(row);
  });
  $("#addBday").onclick = ()=>{ bdays.push({name:"",date:"",image:""}); renderBdays(bdays); };
}

// ---------- Init: load data.json ----------
let DATA = null;
let ACTIVE_DIR = "medarbejdere";
let FILE_TARGET = null;      // PB-DESIGN: input-felt der skal udfyldes når man trykker "Brug"

(async function init(){
  DATA = await loadData();

  // Brand/Tema
  $("#brand").value  = DATA.brand || "";
  $("#logoUrl").value= DATA.logoUrl || "";
  $("#bg1").value    = DATA.theme?.bg1 || "#0d4952";
  $("#bg2").value    = DATA.theme?.bg2 || "#0b6a74";
  $("#accent").value = DATA.theme?.accent || "#a7d0c9";
  $("#refreshMs").value = DATA.settings?.refreshMs ?? 300000;

  // Affald
  $("#emptiesStart").value   = DATA.empties?.startDate || "";
  $("#emptiesHorizon").value = DATA.empties?.horizon || 8;
  (DATA.empties?.weekdays || [1]).forEach(v=>{
    $$(".wd").forEach(cb=>{ if(Number(cb.value)===Number(v)) cb.checked=true; });
  });
  $("#emptiesNames").value = fromLines(DATA.empties?.names || []);
  $("#emptiesSkip").value  = fromLines(DATA.empties?.skipDates || []);
  $("#emptiesCols").value  = String(DATA.empties?.columns || 2);

  // Fødselsdage
  $("#bdayMsg").value = DATA.birthdays?.message || "";
  renderBdays(DATA.birthdays?.people || []);

  // Knapper
  $("#saveBtn").onclick = onSave;
  $("#openFiles").onclick = ()=>openFileModal("medarbejdere");
  $$("[data-pick]").forEach(b=> b.addEventListener("click", (ev)=>{
    const target = ev.currentTarget.getAttribute("data-pick");
    openFileModal("media", target);
  }));

  // Modal events
  $("#closeFiles").onclick = closeFileModal;
  $$(".sheet [data-tab]").forEach(b=>{
    b.onclick = async ()=>{ ACTIVE_DIR = b.getAttribute("data-tab"); await refreshDir(); };
  });

})().catch(e=>alert(e.message||e));

async function onSave(){
  DATA.brand = $("#brand").value.trim();
  DATA.logoUrl = $("#logoUrl").value.trim();
  DATA.theme = { bg1: $("#bg1").value.trim(), bg2: $("#bg2").value.trim(), accent: $("#accent").value.trim() };
  DATA.settings = { refreshMs: Number($("#refreshMs").value||300000) };

  const weekdays = $$(".wd").filter(cb=>cb.checked).map(cb=>Number(cb.value));
  DATA.empties = {
    startDate: $("#emptiesStart").value,
    horizon: Number($("#emptiesHorizon").value||8),
    weekdays,
    names: toLines($("#emptiesNames")),
    skipDates: toLines($("#emptiesSkip")),
    columns: Number($("#emptiesCols").value||2)
  };

  const people = [];
  $$("#bdayList .row").forEach(r=>{
    const p = {
      name : $("[data-k=name]", r).value.trim(),
      date : $("[data-k=date]", r).value.trim(),
      image: $("[data-k=image]", r).value.trim()
    };
    if (p.name) people.push(p);
  });
  DATA.birthdays = { message: $("#bdayMsg").value.trim(), people };

  const pin = $("#adminPin").value.trim();
  if (!pin) { alert("Indtast PIN (ADMIN_PIN) før gem."); return; }

  await api("saveDataJson", { data: DATA, message: `PB-DESIGN: admin gem (pin:${pin.slice(0,2)}**)` });
  alert("Gemt ✔");
}

// ===================== PB-DESIGN: FIL-MODAL (CRUD) =====================
function openFileModal(dir="medarbejdere", targetInputSelector=null){
  ACTIVE_DIR = dir;
  FILE_TARGET = targetInputSelector;
  $("#fileModal").classList.add("open");
  refreshDir().catch(err=>$("#opStatus").textContent = err.message||err);
}
function closeFileModal(){
  $("#fileModal").classList.remove("open");
  FILE_TARGET = null;
}

async function refreshDir(){
  $("#opStatus").textContent = "Henter…";
  const { items } = await api("listDir", { path: ACTIVE_DIR });
  const tbody = $("#fileTable tbody");
  tbody.innerHTML = "";
  (items||[]).filter(x=>x.type==="file").sort((a,b)=>a.name.localeCompare(b.name,"da",{numeric:true}))
  .forEach(it=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="fit"><img class="thumb" src="${it.raw}" alt=""></td>
      <td>${it.name}</td>
      <td>${it.path}</td>
      <td class="fit"><button class="btn" data-use>Brug</button></td>
      <td class="fit"><button class="btn" data-rename>Omdøb</button></td>
      <td class="fit"><button class="btn bad" data-del>Slet</button></td>
    `;
    // Brug -> udfyld inputfelt hvis FILE_TARGET er sat
    $("[data-use]", tr).onclick = ()=>{
      if (FILE_TARGET) {
        const el = document.querySelector(FILE_TARGET);
        if (el) el.value = `/${it.path}`;          // sæt absolut sti /medarbejdere/Per.jpg
        closeFileModal();
      } else {
        alert(`Sti: /${it.path}`);
      }
    };
    // Omdøb
    $("[data-rename]", tr).onclick = async ()=>{
      const nn = prompt("Nyt navn (inkl. .jpg/.png):", it.name);
      if (!nn || !/^[\w.\- ]+\.(jpg|jpeg|png)$/i.test(nn)) return;
      const newPath = `${ACTIVE_DIR}/${nn}`;
      await api("renamePath", { oldPath: it.path, newPath, message:`PB-DESIGN: rename ${it.path} -> ${newPath}` });
      await refreshDir();
    };
    // Slet
    $("[data-del]", tr).onclick = async ()=>{
      if (!confirm(`Slet ${it.path}?`)) return;
      await api("deletePath", { path: it.path, message:`PB-DESIGN: delete ${it.path}` });
      await refreshDir();
    };
    tbody.appendChild(tr);
  });
  $("#opStatus").textContent = `${ACTIVE_DIR}: ${items?.length||0} filer`;
}

$("#btnUpload").onclick = async ()=>{
  const f = $("#upFile").files[0];
  const name = ($("#upName").value||"").trim();
  if (!f || !name) { $("#upHint").textContent="Vælg fil + navn"; return; }
  if (!/^[\w.\- ]+\.(jpg|jpeg|png)$/i.test(name)) { $("#upHint").textContent="Navn skal slutte på .jpg/.jpeg/.png"; return; }
  const base64 = await fileToBase64(f);
  $("#upHint").textContent = "Uploader…";
  await api("uploadBase64", { path: `${ACTIVE_DIR}/${name}`, base64, message:`PB-DESIGN: upload ${ACTIVE_DIR}/${name}` });
  $("#upHint").textContent = "Uploadet ✔";
  $("#upFile").value=""; $("#upName").value="";
  await refreshDir();
};

function fileToBase64(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=>resolve(String(r.result||""));
    r.onerror = e=>reject(e);
    r.readAsDataURL(file);
  });
}
</script>
</body>
</html>

