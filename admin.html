<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Administration • Infoskærm</title>
  <style>
    :root{
      --bg:#0b1220;--panel:#111a2d;--muted:#243147;--text:#e8eefb;--accent:#5aa2ff;
      --ok:#33d17a;--err:#ff6b6b;--sub:#1a2440;
    }
    *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
    a{color:#9ec1ff} .hide{display:none}

    /* Topbar */
    .topbar{position:sticky;top:0;z-index:30;height:64px;background:rgba(15,23,42,.92);backdrop-filter:blur(6px);
      display:flex;align-items:center;gap:10px;padding:0 14px;border-bottom:1px solid rgba(255,255,255,.08)}
    .pill{padding:6px 10px;border-radius:999px;background:#0f1b34;border:1px solid #203258;font-size:12px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;background:var(--accent);color:#061022;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.sub{background:var(--sub);color:#d6e4ff}.btn.small{padding:7px 10px}.btn.danger{background:#aa3c3c;color:#150909}
    .ok{color:var(--ok)} .err{color:var(--err)}
    .wrap{max-width:1100px;margin:18px auto;padding:0 16px 40px}
    section{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:16px;margin:14px 0}
    h1{margin:0 0 6px 2px} h2{margin:0 0 12px} label{display:block;margin:10px 0 6px}
    input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--muted);background:#0f172a;color:var(--text);font-size:15px}
    textarea{min-height:92px}
    .row{display:grid;gap:12px}.g2{grid-template-columns:1fr 1fr}.g3{grid-template-columns:repeat(3,1fr)} .inline{display:flex;gap:8px;align-items:flex-start}
    .tabs{display:flex;gap:10px;margin:6px 0 14px}
    .tabbtn{background:#0f1b34;border:1px solid #203258;color:#cfe1ff;padding:8px 12px;border-radius:999px;cursor:pointer}
    .tabbtn.active{background:#27406e;color:white}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px 10px;border-bottom:1px solid var(--muted);text-align:left}
    th{opacity:.85}
    .hint{font-size:12px;opacity:.75;margin-top:4px}

    /* PIN overlay */
    .gate{
      position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(6px);
      display:flex;align-items:center;justify-content:center;z-index:1000
    }
    .gate .card{
      width:min(420px,92vw);background:#0f172a;border:1px solid #203258;border-radius:16px;padding:20px;
      box-shadow:0 10px 35px rgba(0,0,0,.35)
    }
    .gate h3{margin:0 0 8px} .gate p{margin:0 0 14px;opacity:.85}
  </style>
</head>
<body>
  <!-- PIN overlay -->
  <div class="gate" id="pinGate">
    <div class="card">
      <h3>Adgangskode påkrævet</h3>
      <p>Indtast koden for at åbne administrationen.</p>
      <label>Kode</label>
      <input id="pinInput" type="password" placeholder="••••" />
      <div class="inline" style="margin-top:12px">
        <button class="btn" id="pinOk">Åbn admin</button>
        <span id="pinMsg" class="pill" style="margin-left:auto">Klar</span>
      </div>
      <div class="hint" style="margin-top:10px">Koden gemmes midlertidigt i denne browsers session for at kunne gemme ændringer.</div>
    </div>
  </div>

  <!-- Topbar -->
  <div class="topbar">
    <strong>Infoskærm • Admin</strong>
    <span class="pill">Data: <code id="dataUrlView"></code></span>
    <button class="btn sub" id="loadBtn">Hent data</button>
    <div class="spacer"></div>
    <span id="status" class="pill">Klar</span>
    <button class="btn" id="saveBtn">Gem ændringer</button>
  </div>

  <div class="wrap">
    <div class="tabs">
      <button class="tabbtn active" data-tab="slidesTab">Slides</button>
      <button class="tabbtn" data-tab="emptiesTab">Tømmeplan</button>
      <button class="tabbtn" data-tab="birthdaysTab">Fødselsdage</button>
      <button class="tabbtn" data-tab="settingsTab">Indstillinger</button>
      <button class="tabbtn" data-tab="sourceTab">Datakilde</button>
    </div>

    <!-- Slides -->
    <section id="slidesTab">
      <h2>Slides</h2>
      <div class="row g3">
        <div>
          <label>Type</label>
          <select id="s_type">
            <option value="bullets">Bullets (tekst)</option>
            <option value="image">Billede (fuldskærm)</option>
            <option value="empties">Tømningstabel</option>
            <option value="birthday">Fødselsdage (uge)</option>
          </select>
        </div>
        <div>
          <label>Titel</label>
          <input id="s_title" placeholder="Titel…" />
        </div>
        <div>
          <label>Varighed (sek.)</label>
          <input id="s_duration" type="number" value="12" min="3" />
        </div>
      </div>

      <div id="box_bullets">
        <label>Linjer (én pr. linje)</label>
        <div class="inline">
          <textarea id="s_lines" placeholder="Punkt 1&#10;Punkt 2&#10;Punkt 3"></textarea>
          <div class="inline" style="flex-direction:column;gap:6px">
            <button class="btn small sub" id="addLineBtn" type="button">+ Tilføj punkt</button>
            <button class="btn small sub" id="clearLinesBtn" type="button">Ryd</button>
          </div>
        </div>
      </div>

      <div id="box_image" class="hide">
        <label>Billede URL eller filnavn</label>
        <div class="inline">
          <input id="s_image" placeholder="https://… eller fx billede.jpg" />
          <input type="file" id="s_imgfile" accept="image/*" />
          <button class="btn small sub" id="uploadBtn" type="button">Upload</button>
        </div>
        <div class="hint">Upload kræver, at <code>/api/upload-image</code> er sat op + ENV (<code>MEDIA_DIR</code> osv.).</div>
      </div>

      <div class="inline" style="gap:10px;margin-top:10px">
        <button class="btn" id="addSlide">Tilføj slide</button>
        <button class="btn sub" id="clearSlides">Tøm alle slides</button>
        <span class="hint">Husk: Tryk “Gem ændringer” øverst for at gemme til server.</span>
      </div>

      <table>
        <thead><tr><th style="width:42px">#</th><th>Type</th><th>Titel</th><th>Forhåndsvisning</th><th style="width:100px"></th></tr></thead>
        <tbody id="slidesTable"></tbody>
      </table>
    </section>

    <!-- Tømmeplan -->
    <section id="emptiesTab" class="hide">
      <h2>Tømmeplan</h2>
      <div class="row g2">
        <div>
          <label>Ugedage</label>
          <div class="inline" style="gap:16px">
            <label><input type="checkbox" class="wd" value="mon"> Man</label>
            <label><input type="checkbox" class="wd" value="tue"> Tir</label>
            <label><input type="checkbox" class="wd" value="wed"> Ons</label>
            <label><input type="checkbox" class="wd" value="thu"> Tor</label>
            <label><input type="checkbox" class="wd" value="fri"> Fre</label>
          </div>
          <label>Spring over datoer (YYYY-MM-DD – komma eller linjeskift)</label>
          <textarea id="skipDates" placeholder="2025-12-24, 2025-12-31"></textarea>
        </div>
        <div>
          <label>Navne (rotation – ét pr. linje eller komma)</label>
          <textarea id="emptyNames" placeholder="Per&#10;Martin&#10;Kasper"></textarea>
          <div class="hint">Viewer viser næste ~10 forekomster og markerer den næste.</div>
        </div>
      </div>
    </section>

    <!-- Fødselsdage -->
    <section id="birthdaysTab" class="hide">
      <h2>Fødselsdage</h2>
      <div class="row g3">
        <div>
          <label>Navn</label>
          <input id="bd_name" placeholder="Navn" />
        </div>
        <div>
          <label>Fødselsdag (YYYY-MM-DD)</label>
          <input id="bd_date" placeholder="1986-05-07" />
        </div>
        <div>
          <label>Foto URL (valgfrit)</label>
          <input id="bd_photo" placeholder="https://… eller fx per.jpg" />
        </div>
      </div>
      <div class="inline" style="gap:10px;margin-top:8px">
        <button class="btn" id="bd_add">Tilføj</button>
      </div>

      <table>
        <thead><tr><th>Navn</th><th>Dato</th><th>Foto</th><th style="width:100px"></th></tr></thead>
        <tbody id="bd_table"></tbody>
      </table>
      <div class="hint">Viewer viser automatisk dem, der falder i den aktuelle uge (man–søn).</div>
    </section>

    <!-- Indstillinger -->
    <section id="settingsTab" class="hide">
      <h2>Indstillinger</h2>
      <div class="row g2">
        <div>
          <label>Brand (vises i bunden på skærm)</label>
          <input id="brand" placeholder="Bredsgaard • Infoskærm" />
        </div>
        <div>
          <label>Kalender-link (Outlook/ics/embeds – bruges af kalenderskærm)</label>
          <input id="calendarUrl" placeholder="https://…" />
        </div>
      </div>

      <div class="row g2">
        <div>
          <label>Logo URL (valgfrit)</label>
          <input id="logoUrl" placeholder="https://…/logo.png" />
        </div>
        <div>
          <label>Logo placering</label>
          <select id="logoPos">
            <option value="top-right">Øverst højre</option>
            <option value="top-left">Øverst venstre</option>
            <option value="bottom-right">Nederst højre</option>
            <option value="bottom-left">Nederst venstre</option>
          </select>
        </div>
      </div>

      <div class="row g2">
        <div>
          <label>Media base-URL (OneDrive/Dropbox/GitHub/CDN)</label>
          <input id="mediaBase" placeholder="https://delt-mappe/…/media/" />
          <div class="hint">Hvis udfyldt, kan du i slides kun skrive fx <code>billede.jpg</code> — så bygges fuld URL automatisk.</div>
        </div>
        <div>
          <label>Media-nøgle/kode (valgfrit)</label>
          <input id="mediaKey" placeholder="adgangskode eller note" />
        </div>
      </div>
    </section>

    <!-- Datakilde -->
    <section id="sourceTab" class="hide">
      <h2>Datakilde</h2>
      <label>Adresse til <code>data.json</code></label>
      <input id="dataUrl" placeholder="https://USERNAME.github.io/REPO/data.json" />
      <div class="inline" style="gap:10px;margin-top:10px">
        <button class="btn sub" id="setUrlBtn">Brug denne adresse</button>
        <button class="btn sub" id="downloadBtn">Download ny data.json</button>
        <button class="btn" id="saveBtn2">Gem til server</button>
      </div>
      <div class="hint">Tip: adressen gemmes lokalt i denne browser.</div>
    </section>
  </div>

  <script>
    /* ===== PIN gate ===== */
    const pinGate = document.getElementById('pinGate');
    const pinInput = document.getElementById('pinInput');
    const pinOk = document.getElementById('pinOk');
    const pinMsg = document.getElementById('pinMsg');

    // gem PIN i sessionStorage (ikke i URL)
    function setPin(pin){ sessionStorage.setItem('admin_pin', pin); }
    function getPin(){ return sessionStorage.getItem('admin_pin') || ''; }

    pinOk.onclick = ()=>{
      const p = (pinInput.value||'').trim();
      if(!p){ pinMsg.textContent='Indtast kode'; return; }
      setPin(p);
      pinGate.classList.add('hide');
    };

    /* ===== resten af admin (samme funktionalitet som før) ===== */

    const $ = s => document.querySelector(s);
    const els = {
      status: $('#status'), saveBtn: $('#saveBtn'),
      dataUrlView: $('#dataUrlView'),
      tabButtons: Array.from(document.querySelectorAll('.tabbtn')),
      tabs: { slides: $('#slidesTab'), empties: $('#emptiesTab'), birthdays: $('#birthdaysTab'), settings: $('#settingsTab'), source: $('#sourceTab') },
      dataUrl: $('#dataUrl'), setUrlBtn: $('#setUrlBtn'), loadBtn: $('#loadBtn'), downloadBtn: $('#downloadBtn'), saveBtn2: $('#saveBtn2'),
      brand: $('#brand'), logoUrl: $('#logoUrl'), logoPos: $('#logoPos'),
      mediaBase: $('#mediaBase'), mediaKey: $('#mediaKey'), calendarUrl: $('#calendarUrl'),
      s_type: $('#s_type'), s_title: $('#s_title'), s_duration: $('#s_duration'),
      s_lines: $('#s_lines'), addLineBtn: $('#addLineBtn'), clearLinesBtn: $('#clearLinesBtn'),
      s_image: $('#s_image'), s_imgfile: $('#s_imgfile'), uploadBtn: $('#uploadBtn'),
      addSlide: $('#addSlide'), clearSlides: $('#clearSlides'), slidesTable: $('#slidesTable'),
      box_bullets: $('#box_bullets'), box_image: $('#box_image'),
      wd: Array.from(document.querySelectorAll('.wd')), skipDates: $('#skipDates'), emptyNames: $('#emptyNames'),
      bd_name: $('#bd_name'), bd_date: $('#bd_date'), bd_photo: $('#bd_photo'), bd_add: $('#bd_add'), bd_table: $('#bd_table'),
    };

    const defaultData = () => ({
      brand:'Bredsgaard • Infoskærm',
      logoUrl:'', logoPos:'top-right',
      media:{ baseUrl:'', key:'' },
      settings:{ calendarUrl:'', empties:{weekdays:[],skip:[],names:[]}, birthdays:[] },
      slides:[]
    });

    const state = { dataUrl:'', data: defaultData() };

    function fmtDa(iso){ if(!iso) return ''; const d=new Date(iso); if(Number.isNaN(d.getTime())) return iso;
      return d.toLocaleDateString('da-DK',{day:'2-digit',month:'2-digit',year:'numeric'});}
    function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]);}

    function showTab(name){
      els.tabButtons.forEach(b=>b.classList.toggle('active', b.dataset.tab===name));
      const map={slides:'slides',empties:'empties',birthdays:'birthdays',settings:'settings',source:'source'};
      Object.entries(els.tabs).forEach(([k,el])=> el.classList.toggle('hide', k!==map[name]));
    }
    els.tabButtons.forEach(b=> b.addEventListener('click', ()=> showTab(b.dataset.tab)));
    showTab('slidesTab');

    function renderBirthdays(){
      els.bd_table.innerHTML='';
      (state.data.settings.birthdays||[]).forEach((b,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${escapeHtml(b.name||'')}</td><td>${fmtDa(b.date)}</td>
                      <td>${b.photo?`<a href="${escapeHtml(b.photo)}" target="_blank">link</a>`:''}</td>
                      <td><button class="btn small danger" data-delbd="${i}">Slet</button></td>`;
        els.bd_table.appendChild(tr);
      });
      els.bd_table.querySelectorAll('[data-delbd]').forEach(b=>{
        b.onclick=()=>{ state.data.settings.birthdays.splice(+b.dataset.delbd,1); renderBirthdays(); };
      });
    }

    function renderSlides(){
      els.slidesTable.innerHTML='';
      (state.data.slides||[]).forEach((s,idx)=>{
        const prev = s.type==='image' ? (s.image||'(intet)') :
                     s.type==='empties' ? 'Tømningstabel' :
                     s.type==='birthday' ? 'Fødselsdage (uge)' :
                     (s.lines||[]).join(' • ');
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${idx+1}</td><td>${escapeHtml(s.type)}</td><td>${escapeHtml(s.title||'')}</td>
                        <td>${escapeHtml(prev)}</td>
                        <td><button class="btn small danger" data-del="${idx}">Slet</button></td>`;
        els.slidesTable.appendChild(tr);
      });
      els.slidesTable.querySelectorAll('[data-del]').forEach(b=>{
        b.onclick = ()=>{ state.data.slides.splice(+b.dataset.del,1); renderSlides(); };
      });
    }

    function renderAll(){
      els.brand.value=state.data.brand||''; els.logoUrl.value=state.data.logoUrl||''; els.logoPos.value=state.data.logoPos||'top-right';
      els.mediaBase.value=state.data.media?.baseUrl||''; els.mediaKey.value=state.data.media?.key||'';
      els.calendarUrl.value=state.data.settings?.calendarUrl||'';

      const e=state.data.settings?.empties||{weekdays:[],skip:[],names:[]};
      const set=new Set(e.weekdays||[]); els.wd.forEach(cb=> cb.checked=set.has(cb.value));
      els.skipDates.value=(e.skip||[]).join(', '); els.emptyNames.value=(e.names||[]).join(', ');

      renderBirthdays(); renderSlides();
      els.dataUrl.value=state.dataUrl; els.dataUrlView.textContent=state.dataUrl;
    }

    async function load(){
      try{
        els.status.textContent='Henter…';
        const res=await fetch(state.dataUrl + '?v=' + Date.now());
        if(!res.ok) throw new Error('HTTP '+res.status);
        const j=await res.json();
        const base=defaultData(); state.data=Object.assign(base,j);
        (state.data.slides||[]).forEach(s=>{
          if(s.type==='bullets'){
            if(Array.isArray(s.lines)){} else if(typeof s.lines==='string'){s.lines=s.lines.split('|').map(x=>x.trim()).filter(Boolean);} else {s.lines=[];}
          }
        });
        renderAll(); els.status.innerHTML='<span class="ok">Data hentet</span>';
      }catch(e){
        state.data=defaultData(); renderAll(); els.status.innerHTML='<span class="err">Ingen data fundet – starter tomt</span>';
      }
    }

    async function save(){
      // inputs -> state
      state.data.brand=els.brand.value.trim(); state.data.logoUrl=els.logoUrl.value.trim(); state.data.logoPos=els.logoPos.value;
      state.data.media={ baseUrl:els.mediaBase.value.trim(), key:els.mediaKey.value.trim() };
      state.data.settings ||= {}; state.data.settings.calendarUrl=els.calendarUrl.value.trim();
      const weekdays=els.wd.filter(cb=>cb.checked).map(cb=>cb.value);
      const skip=(els.skipDates.value||'').split(/[\s,]+/).map(x=>x.trim()).filter(Boolean);
      const names=(els.emptyNames.value||'').split(/[\s,]+/).map(x=>x.trim()).filter(Boolean);
      state.data.settings.empties={weekdays,skip,names};

      try{
        els.status.textContent='Gemmer…'; els.saveBtn.disabled=true;
        const res=await fetch('/api/save',{method:'POST',headers:{
          'Content-Type':'application/json','x-admin-pin': getPin() || ''
        },body:JSON.stringify(state.data)});
        const txt=await res.text();
        if(!res.ok){ let msg=txt; try{const j=JSON.parse(txt); msg=j.error||j.detail||txt;}catch{}; throw new Error(`HTTP ${res.status} – ${msg}`);}
        els.status.innerHTML='<span class="ok">✅ Data gemt</span>';
      }catch(e){
        els.status.innerHTML='<span class="err">Fejl: '+(e.message||e)+'</span>'; alert('Gemning fejlede:\n\n'+(e.message||e));
      }finally{ els.saveBtn.disabled=false; }
    }

    function toggleTypeUI(){
      const t=els.s_type.value;
      els.box_bullets.classList.toggle('hide', t!=='bullets');
      els.box_image.classList.toggle('hide', t!=='image' && t!=='birthday');
    }
    els.s_type.addEventListener('change', toggleTypeUI); toggleTypeUI();

    els.addLineBtn.onclick=()=>{ els.s_lines.value=(els.s_lines.value?els.s_lines.value+'\n':''); els.s_lines.focus(); };
    els.clearLinesBtn.onclick=()=>{ els.s_lines.value=''; };

    els.addSlide.onclick=()=>{
      const t=els.s_type.value;
      const s={ type:t, title:(els.s_title.value||'').trim(), duration:Math.max(3,+els.s_duration.value||12) };
      if(t==='bullets'){
        s.lines=(els.s_lines.value||'').split('\n').map(x=>x.trim()).filter(Boolean);
        if(!s.lines.length) return alert('Tilføj mindst ét punkt.');
      }
      if(t==='image'||t==='birthday'){
        let img=(els.s_image.value||'').trim();
        if(!img) return alert('Angiv billede-URL eller filnavn.');
        if(!/^https?:\/\//i.test(img) && state.data.media?.baseUrl){
          img=state.data.media.baseUrl.replace(/\/+$/,'')+'/'+img.replace(/^\/+/,'');
        }
        s.image=img;
      }
      state.data.slides.push(s);
      els.s_title.value=''; els.s_lines.value=''; els.s_image.value='';
      renderSlides();
    };

    els.clearSlides.onclick=()=>{ if(confirm('Slet alle slides?')){ state.data.slides=[]; renderSlides(); } };

    els.bd_add.onclick=()=>{
      state.data.settings ||= {}; state.data.settings.birthdays ||= [];
      const name=els.bd_name.value.trim(); const date=els.bd_date.value.trim(); let photo=els.bd_photo.value.trim();
      if(!name || !/^\d{4}-\d{2}-\d{2}$/.test(date)) return alert('Udfyld navn og dato (YYYY-MM-DD).');
      if(photo && !/^https?:\/\//i.test(photo) && state.data.media?.baseUrl){
        photo=state.data.media.baseUrl.replace(/\/+$/,'')+'/'+photo.replace(/^\/+/,'');
      }
      state.data.settings.birthdays.push({name,date,photo});
      els.bd_name.value=els.bd_date.value=els.bd_photo.value=''; renderBirthdays();
    };

    els.uploadBtn.onclick=async ()=>{
      const f=els.s_imgfile.files?.[0]; if(!f) return alert('Vælg et billede først.');
      els.status.textContent='Uploader billede…';
      const r=new FileReader();
      r.onload=async e=>{
        try{
          const data=e.target.result.split(',')[1];
          const resp=await fetch('/api/upload-image',{method:'POST',headers:{'Content-Type':'application/json','x-admin-pin': getPin()||''},body:JSON.stringify({name:f.name,data})});
          const j=await resp.json(); if(!resp.ok||!j.ok) throw new Error(j.error||'Upload fejlede');
          els.s_image.value=j.cdnUrl||j.rawUrl||''; els.status.textContent='✅ Upload OK';
        }catch(err){ els.status.innerHTML='<span class="err">Upload fejl: '+(err.message||err)+'</span>'; }
      };
      r.readAsDataURL(f);
    };

    els.setUrlBtn.onclick=()=>{ state.dataUrl=els.dataUrl.value.trim(); els.dataUrlView.textContent=state.dataUrl; localStorage.setItem('admin_data_url',state.dataUrl); };
    els.loadBtn.onclick=load;
    els.downloadBtn.onclick=()=>{
      const blob=new Blob([JSON.stringify(state.data,null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='data.json'; a.click();
    };
    els.saveBtn.onclick=save; els.saveBtn2.onclick=save;

    (function init(){
      const stored=localStorage.getItem('admin_data_url')||'';
      state.dataUrl = stored || 'https://perbonde07-byte.github.io/Infoskaerm/data.json';
      els.dataUrl.value=state.dataUrl; els.dataUrlView.textContent=state.dataUrl;
      load();
    })();
  </script>
</body>
</html>
