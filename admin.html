<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin · Infoskærm</title>
<style>
  :root{ --bg:#0b0b0b; --panel:#111; --muted:#aaa; --fg:#fff; --accent:#4caf50; --danger:#ff5555; }
  html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--fg)}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  h1{font-size:24px;margin:0 0 12px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:var(--panel);border:1px solid #222;border-radius:14px;padding:16px}
  label{display:block;font-size:12px;text-transform:uppercase;letter-spacing:.06em;color:var(--muted);margin:10px 0 6px}
  input,textarea,select{width:100%;box-sizing:border-box;padding:10px;background:#0e0e0e;border:1px solid #222;border-radius:10px;color:var(--fg)}
  textarea{min-height:84px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .slides{display:grid;gap:10px}
  .slide{background:#0e0e0e;border:1px solid #222;border-radius:12px;padding:12px;position:relative}
  .slide h3{margin:0 0 10px;font-size:14px;letter-spacing:.02em}
  .btn{display:inline-flex;align-items:center;gap:6px;padding:10px 14px;border-radius:12px;border:1px solid #222;background:#161616;color:#fff;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:transparent;color:#000;font-weight:700}
  .btn.danger{background:transparent;border-color:#333;color:#ff9a9a}
  .btn.small{padding:8px 10px;border-radius:10px;font-size:12px}
  .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:14px 0}
  .muted{color:var(--muted);font-size:12px}
  .hr{height:1px;background:#222;margin:16px -16px}
  .list{display:flex;gap:8px;flex-wrap:wrap}
  .bd-list{display:grid;gap:10px}
  .bd-item{display:grid;grid-template-columns:1.2fr 1fr 1.2fr auto auto;gap:8px;align-items:center}
  .bd-item .remove{height:40px}
  .weekdays{display:flex;gap:8px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #333;border-radius:10px;background:#0e0e0e}
  .chip input{margin:0}
  .auto-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .auto-grid .col{display:flex;flex-direction:column;gap:6px}
  .auto-grid .col.full{grid-column:1 / -1}
  input[type="file"]{display:none}
</style>
</head>
<body>
<div class="wrap">
  <h1>Admin · Infoskærm</h1>
  <div class="toolbar">
    <div class="muted" id="status">Indlæser…</div>
    <div class="list">
      <input id="pin" placeholder="PIN (ADMIN_PIN)" style="width:130px"/>
      <button class="btn" id="add-image">+ Billede</button>
      <button class="btn" id="add-text">+ Tekst</button>
      <button class="btn" id="add-empties">+ Tømning</button>
      <button class="btn" id="add-birthday">+ Fødselsdage</button>
      <button class="btn primary" id="save">Gem ændringer</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Branding & faste indstillinger</h2>
      <label>Brand</label>
      <input id="brand" placeholder="Bredsgaard • Infoskærm"/>
      <label>Logo URL</label>
      <input id="logoUrl" placeholder="/media/logo.png"/>

      <div class="hr"></div>
      <h3>Tema</h3>
      <div class="row">
        <div><label>Baggrund 1 (bg1)</label><input id="theme-bg1" placeholder="#0d4b59"/></div>
        <div><label>Baggrund 2 (bg2) – valgfri</label><input id="theme-bg2" placeholder="#134d60"/></div>
      </div>
      <label>Accentfarve</label><input id="theme-accent" placeholder="#e8b15c"/>
      <label>Opdaterings-interval (ms) – min. 300000</label><input id="refreshMs" type="number" placeholder="300000" value="300000"/>

      <div class="hr"></div>
      <h3>Affaldstømning (automatisk plan)</h3>
      <label><input type="checkbox" id="auto-enabled" checked/> Brug automatisk plan</label>

      <div id="auto-panel">
        <div class="auto-grid">
          <div class="col">
            <label>Startdato</label>
            <input id="auto-start" type="date"/>
          </div>

          <div class="col">
            <label>Horizon (antal kommende linjer der vises)</label>
            <input id="auto-horizon" type="number" value="12"/>
          </div>

          <div class="col full">
            <label>Ugedage (vælg de dage hvor tømning kan ligge)</label>
            <div class="weekdays">
              <label class="chip"><input type="checkbox" value="mon"/> Man</label>
              <label class="chip"><input type="checkbox" value="tue"/> Tir</label>
              <label class="chip"><input type="checkbox" value="wed"/> Ons</label>
              <label class="chip"><input type="checkbox" value="thu"/> Tor</label>
              <label class="chip"><input type="checkbox" value="fri"/> Fre</label>
              <label class="chip"><input type="checkbox" value="sat"/> Lør</label>
              <label class="chip"><input type="checkbox" value="sun"/> Søn</label>
            </div>
          </div>

          <div class="col">
            <label>Navne (rækkefølge — én pr. linje)</label>
            <textarea id="auto-names" placeholder="Per&#10;Louise&#10;Max"></textarea>
          </div>

          <div class="col">
            <label>Ekskluder datoer (én pr. linje — dd.mm.yyyy)</label>
            <textarea id="auto-exclude" placeholder="25.12.2025&#10;01.01.2026"></textarea>
          </div>

          <div class="col">
            <label>Antal kolonner i visning</label>
            <select id="empties-columns">
              <option value="1">1 kolonne</option>
              <option value="2">2 kolonner</option>
              <option value="3">3 kolonner</option>
            </select>
          </div>
        </div>
      </div>

      <div class="hr"></div>
      <h3>Fødselsdage</h3>
      <label>Standard-besked (bruges i alarm-slides)</label>
      <input id="birthdays-msg" placeholder="Tillykke!"/>
      <div class="muted" style="margin:8px 0 12px">Tilføj personer (Navn, Dato, Billede). Dato kan være dd.mm eller dd.mm.yyyy.</div>
      <div id="bd-list" class="bd-list"></div>
      <button class="btn" id="bd-add">+ Tilføj person</button>
    </div>

    <div class="card">
      <h2>Slides (rækkefølge = visningsrækkefølge)</h2>
      <div id="slides" class="slides"></div>
    </div>
  </div>
</div>

<template id="tpl-slide">
  <div class="slide">
    <h3></h3>
    <div class="row">
      <div>
        <label>Type</label>
        <select class="type">
          <option value="image">image</option>
          <option value="text">text</option>
          <option value="empties">empties</option>
          <option value="birthday">birthday</option>
        </select>
      </div>
      <div>
        <label>Varighed (sek.)</label>
        <input class="duration" type="number" min="3" value="8"/>
      </div>
    </div>
    <label>Titel</label>
    <input class="title" placeholder="Titel"/>
    <div class="content-fields"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
      <span class="muted"></span>
      <button class="btn danger remove">Fjern</button>
    </div>
  </div>
</template>

<template id="tpl-bd-item">
  <div class="bd-item">
    <input class="bd-name"  placeholder="Navn"/>
    <input class="bd-date"  placeholder="dd.mm eller dd.mm.yyyy"/>
    <input class="bd-image" placeholder="(valgfrit) Per-Bonde  •  eller fuld URL/sti"/>
    <button class="btn small" data-action="bd-upload">Upload</button>
    <button class="btn danger remove">Fjern</button>
  </div>
</template>

<input type="file" id="file-picker" accept="image/*"/>

<script>
const $=(s,e=document)=>e.querySelector(s);
const $$=(s,e=document)=>Array.from(e.querySelectorAll(s));
const state={sha:null,data:null};

function slugBase(s){
  return String(s||'')
    .trim()
    .normalize('NFKD').replace(/[\u0300-\u036f]/g,'')   // fjern diakritik
    .replace(/[^A-Za-z0-9\s\-_.]/g,'')                  // whitelist
    .replace(/\s+/g,'-')                                // mellemrum -> -
    .replace(/-+/g,'-')
    .replace(/^-|-$/g,'');
}

/* ---------- Upload helper ---------- */
async function uploadImage(file, baseName, folder){
  if(!file) throw new Error('Ingen fil valgt');
  const ext = (file.name.match(/\.(jpg|jpeg|png|gif|webp)$/i)||['','.jpg'])[0].toLowerCase();
  const safeBase = slugBase(baseName || file.name.replace(/\.[^.]+$/,'') || 'billede');
  const filename = safeBase + ext;

  const b64 = await new Promise((resolve,reject)=>{
    const r=new FileReader();
    r.onload=()=>resolve(String(r.result));
    r.onerror=()=>reject(new Error('Kunne ikke læse fil'));
    r.readAsDataURL(file); // data:*;base64,...
  });

  const pin=$('#pin').value.trim();
  const headers={'Content-Type':'application/json'}; if(pin) headers['x-admin-pin']=pin;
  const res = await fetch('/api/save',{
    method:'POST', headers,
    body:JSON.stringify({ upload:{ folder, filename, dataUrl:b64 } })
  });
  const out = await res.json();
  if(!res.ok) throw new Error(out?.message||'Upload fejlede');
  return out.path; // den endelige sti i repoet
}

/* ---------- Slides UI ---------- */
function renderSlides(container, slides){
  container.innerHTML='';
  slides.forEach((s,idx)=>container.appendChild(makeSlide(s,idx)));
}
function makeSlide(s, idx){
  const t=$('#tpl-slide'), node=t.content.firstElementChild.cloneNode(true);
  node.querySelector('h3').textContent=`Slide #${idx+1}`;
  node.querySelector('.type').value=s.type||'text';
  node.querySelector('.duration').value=s.duration??8;
  node.querySelector('.title').value=s.title||'';
  node.querySelector('.muted').textContent=`type: ${s.type||'text'}`;
  const cf=node.querySelector('.content-fields'); fillContentFields(cf,s,node);

  node.querySelector('.type').addEventListener('change',e=>{ s.type=e.target.value; node.querySelector('.muted').textContent=`type: ${s.type}`; fillContentFields(cf,s,node); });
  node.querySelector('.duration').addEventListener('input',e=>s.duration=Number(e.target.value));
  node.querySelector('.title').addEventListener('input',e=>s.title=e.target.value);
  node.querySelector('.remove').addEventListener('click',()=>{ const i=state.data.slides.indexOf(s); if(i>=0){ state.data.slides.splice(i,1); renderSlides($('#slides'),state.data.slides);} });
  return node;
}
function fillContentFields(cf,s,node){
  cf.innerHTML='';
  if(s.type==='image'){
    const i=document.createElement('input'); 
    i.placeholder="Per-Bonde  •  eller /media/fil.jpg  •  eller fuld URL";
    i.value=s.image||''; 
    i.addEventListener('input',e=>s.image=e.target.value);

    const upBtn=document.createElement('button'); upBtn.className='btn small'; upBtn.textContent='Upload';
    upBtn.addEventListener('click', async ()=>{
      const picker=$('#file-picker'); picker.value='';
      picker.onchange=async()=>{
        try{
          const path = await uploadImage(picker.files[0], slugBase(s.title||'billede'), 'media');
          i.value = s.image = path;
        }catch(err){ alert(err.message); }
      };
      picker.click();
    });

    const a=document.createElement('textarea'); a.placeholder='(valgfri) tekst ved siden af billedet'; a.value=s.sideText||''; a.addEventListener('input',e=>s.sideText=e.target.value);
    const sel=document.createElement('select'); sel.innerHTML=`<option value="right">Billede til højre</option><option value="left">Billede til venstre</option>`; sel.value=s.imageAlign||'right'; sel.addEventListener('change',e=>s.imageAlign=e.target.value);

    cf.appendChild(label('Billede (navn/sti/URL)')); 
    const row=document.createElement('div'); row.style.display='grid'; row.style.gridTemplateColumns='1fr auto'; row.style.gap='8px';
    row.appendChild(i); row.appendChild(upBtn); cf.appendChild(row);

    cf.appendChild(label('Sidetekst (valgfri)')); cf.appendChild(a);
    cf.appendChild(label('Placering når der er tekst')); cf.appendChild(sel);
  }else if(s.type==='text'){
    const a=document.createElement('textarea'); a.placeholder='Din tekst…'; a.value=s.text||''; a.addEventListener('input',e=>s.text=e.target.value);
    cf.appendChild(label('Tekst')); cf.appendChild(a);
  }else{
    cf.appendChild(spanMuted('Denne slide bruger indstillinger fra venstre panel.'));
  }
}
function label(t){ const l=document.createElement('label'); l.textContent=t; return l; }
function spanMuted(t){ const s=document.createElement('div'); s.className='muted'; s.textContent=t; return s; }

/* ---------- Fødselsdage UI ---------- */
function renderBirthdaysList(items){
  const listEl = $('#bd-list'); listEl.innerHTML='';
  (items||[]).forEach((b)=> listEl.appendChild(makeBdItem(b)));
}
function makeBdItem(b){
  const t=$('#tpl-bd-item'), node=t.content.firstElementChild.cloneNode(true);
  const nameEl = node.querySelector('.bd-name');
  const dateEl = node.querySelector('.bd-date');
  const imgEl  = node.querySelector('.bd-image');
  const upBtn  = node.querySelector('[data-action="bd-upload"]');

  nameEl.value = b.name || ''; dateEl.value = b.date || ''; imgEl.value  = b.image || '';
  nameEl.addEventListener('input',e=>b.name=e.target.value);
  dateEl.addEventListener('input',e=>b.date=e.target.value);
  imgEl.addEventListener('input',e=>b.image=e.target.value);

  upBtn.addEventListener('click', ()=>{
    const picker=$('#file-picker'); picker.value='';
    picker.onchange=async()=>{
      try{
        const path = await uploadImage(picker.files[0], slugBase(nameEl.value||'person'), 'medarbejdere');
        imgEl.value = b.image = path; // gem stien i feltet
      }catch(err){ alert(err.message); }
    };
    picker.click();
  });

  node.querySelector('.remove').addEventListener('click',()=>{
    const arr = state.data.settings.birthdays || [];
    const i = arr.indexOf(b);
    if(i>=0){ arr.splice(i,1); renderBirthdaysList(arr); }
  });
  return node;
}
$('#bd-add').addEventListener('click', ()=>{
  state.data.settings = state.data.settings || {};
  state.data.settings.birthdays = state.data.settings.birthdays || [];
  const obj = { name:'', date:'', image:'' };
  state.data.settings.birthdays.push(obj);
  renderBirthdaysList(state.data.settings.birthdays);
});

/* ---------- LOAD / COLLECT / SAVE ---------- */
async function load(){
  $('#status').textContent='Indlæser…';
  const r=await fetch('/api/data',{cache:'no-store'});
  if(!r.ok) throw new Error('Fejl ved hentning');
  const { sha, data } = await r.json();
  state.sha=sha; state.data=data;

  $('#brand').value   = data.brand||'';
  $('#logoUrl').value = data.logoUrl||'';
  $('#theme-bg1').value = data.settings?.theme?.bg1 || '';
  $('#theme-bg2').value = data.settings?.theme?.bg2 || '';
  $('#theme-accent').value = data.settings?.theme?.accent || '';
  $('#refreshMs').value = data.settings?.refreshMs ?? 300000;

  const empties = data.settings?.empties || {};
  const auto = empties.auto || {};
  $('#auto-enabled').checked = !!auto.enabled;
  $('#auto-start').value = auto.startDate || '';
  const set = new Set(auto.weekdays||[]);
  $$('.weekdays input').forEach(cb=> cb.checked = set.has(cb.value));
  $('#auto-names').value = (auto.names||[]).join('\n');
  $('#auto-exclude').value = (auto.exclude||[]).join('\n');
  $('#auto-horizon').value = auto.horizon ?? 12;
  $('#empties-columns').value = String(empties.columns || 1);

  $('#birthdays-msg').value = data.settings?.birthdaysMessage || 'Tillykke!';
  renderBirthdaysList(data.settings?.birthdays || []);

  data.slides = Array.isArray(data.slides) ? data.slides : [];
  renderSlides($('#slides'), data.slides);

  $('#pin').value = localStorage.getItem('ADMIN_PIN') || '';
  $('#status').textContent='Klar';
}

function collect(){
  const data=structuredClone(state.data||{});
  data.brand   = $('#brand').value.trim();
  data.logoUrl = $('#logoUrl').value.trim();

  const theme = { bg1: $('#theme-bg1').value.trim(), bg2: $('#theme-bg2').value.trim(), accent: $('#theme-accent').value.trim() };
  const refreshMs = Math.max(300000, Number($('#refreshMs').value||0) || 300000);

  data.settings = data.settings || {};
  data.settings.theme = theme;
  data.settings.refreshMs = refreshMs;

  const auto = {
    enabled: $('#auto-enabled').checked,
    startDate: $('#auto-start').value.trim(),
    weekdays: $$('.weekdays input:checked').map(cb=>cb.value),
    names: $('#auto-names').value.split(/\n+/).map(s=>s.trim()).filter(Boolean),
    exclude: $('#auto-exclude').value.split(/\n+/).map(s=>s.trim()).filter(Boolean),
    horizon: Math.max(1, Number($('#auto-horizon').value || 12))
  };
  data.settings.empties = data.settings.empties || {};
  data.settings.empties.auto = auto;
  data.settings.empties.columns = Math.max(1, Math.min(3, Number($('#empties-columns').value||1)));

  const list = [];
  document.querySelectorAll('#bd-list .bd-item').forEach(row=>{
    const name=row.querySelector('.bd-name').value.trim();
    const date=row.querySelector('.bd-date').value.trim();
    const image=row.querySelector('.bd-image').value.trim();
    if(name && date) list.push({ name, date, image });
  });
  data.settings.birthdays = list;
  data.settings.birthdaysMessage = $('#birthdays-msg').value.trim() || 'Tillykke!';

  return data;
}

async function save(){
  $('#status').textContent='Gemmer…';
  const pin=$('#pin').value.trim(); localStorage.setItem('ADMIN_PIN', pin);
  const headers={'Content-Type':'application/json'}; if(pin) headers['x-admin-pin']=pin;
  const r=await fetch('/api/save',{method:'POST',headers,body:JSON.stringify({data:collect(),sha:state.sha})});
  const jr=await r.json();
  if(!r.ok){ if(r.status===409){ $('#status').textContent='Konflikt – genindlæser…'; await load(); return; } $('#status').textContent='Fejl: '+(jr?.message||jr?.error||r.status); return; }
  $('#status').textContent='Gemt!'; await load();
}

/* ---------- Init ---------- */
$('#add-image').addEventListener('click',()=>{ state.data.slides.push({type:'image',title:'Kampagne',image:'/media/Slide1.jpg',sideText:'',imageAlign:'right',duration:8}); renderSlides($('#slides'),state.data.slides); });
$('#add-text').addEventListener('click',()=>{ state.data.slides.push({type:'text',title:'Info',text:'',duration:8}); renderSlides($('#slides'),state.data.slides); });
$('#add-empties').addEventListener('click',()=>{ state.data.slides.push({type:'empties',title:'TØMNINGS DAGE',duration:12}); renderSlides($('#slides'),state.data.slides); });
$('#add-birthday').addEventListener('click',()=>{ state.data.slides.push({type:'birthday',title:'Fødselsdage',duration:12}); renderSlides($('#slides'),state.data.slides); });

$('#save').addEventListener('click',save);
load().catch(e=>$('#status').textContent='Fejl: '+e.message);
</script>
</body>
</html>
