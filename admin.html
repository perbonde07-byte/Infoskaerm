<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin · Infoskærm</title>
<style>
  :root{ --bg:#0b0b0b; --panel:#111; --muted:#aaa; --fg:#fff; --accent:#4caf50; --danger:#ff5555; }
  html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--fg)}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  h1{font-size:24px;margin:0 0 12px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:var(--panel);border:1px solid #222;border-radius:14px;padding:16px}
  label{display:block;font-size:12px;text-transform:uppercase;letter-spacing:.06em;color:var(--muted);margin:10px 0 6px}
  input,textarea,select{width:100%;box-sizing:border-box;padding:10px;background:#0e0e0e;border:1px solid #222;border-radius:10px;color:var(--fg)}
  textarea{min-height:84px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .slides{display:grid;gap:10px}
  .slide{background:#0e0e0e;border:1px solid #222;border-radius:12px;padding:12px;position:relative}
  .slide h3{margin:0 0 10px;font-size:14px;letter-spacing:.02em}
  .btn{display:inline-flex;align-items:center;gap:6px;padding:10px 14px;border-radius:12px;border:1px solid #222;background:#161616;color:#fff;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:transparent;color:#000;font-weight:700}
  .btn.danger{background:transparent;border-color:#333;color:#ff9a9a}
  .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:14px 0}
  .muted{color:var(--muted);font-size:12px}
  .hr{height:1px;background:#222;margin:16px -16px}
  .list{display:flex;gap:8px;flex-wrap:wrap}
  .bd-list{display:grid;gap:10px}
  .bd-item{display:grid;grid-template-columns:1.2fr 1fr 1.4fr auto;gap:8px;align-items:center}
  .bd-item .remove{height:40px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Admin · Infoskærm</h1>
  <div class="toolbar">
    <div class="muted" id="status">Indlæser…</div>
    <div class="list">
      <input id="pin" placeholder="PIN (ADMIN_PIN)" style="width:130px"/>
      <button class="btn" id="add-image">+ Billede</button>
      <button class="btn" id="add-text">+ Tekst</button>
      <button class="btn" id="add-empties">+ Tømning</button>
      <button class="btn" id="add-birthday">+ Fødselsdage</button>
      <button class="btn primary" id="save">Gem ændringer</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Branding & faste indstillinger</h2>
      <label>Brand</label>
      <input id="brand" placeholder="Bredsgaard • Infoskærm"/>

      <label>Logo URL</label>
      <input id="logoUrl" placeholder="/media/logo.png"/>

      <div class="hr"></div>
      <h3>Tema</h3>
      <div class="row">
        <div>
          <label>Baggrund 1 (bg1)</label>
          <input id="theme-bg1" placeholder="#0f2b8a"/>
        </div>
        <div>
          <label>Baggrund 2 (bg2) – valgfri</label>
          <input id="theme-bg2" placeholder="#0a1e66"/>
        </div>
      </div>
      <label>Accentfarve</label>
      <input id="theme-accent" placeholder="#2bb673"/>

      <label>Opdaterings-interval (ms) – min. 300000</label>
      <input id="refreshMs" type="number" placeholder="300000" value="300000"/>

      <div class="hr"></div>
      <h3>Affaldstømning – plan</h3>
      <label>Liste (en pr. linje: Navn – dd.mm.åååå)</label>
      <textarea id="empties-plan" placeholder="Per – 03.11.2025&#10;Martin – 05.11.2025"></textarea>

      <div class="hr"></div>
      <h3>Fødselsdage</h3>
      <label>Standard-besked (bruges i alarm-slides)</label>
      <input id="birthdays-msg" placeholder="Tillykke!"/>
      <div class="muted" style="margin:8px 0 12px">Tilføj personer herunder (Navn, Dato, Billede). Dato kan være <code>dd.mm</code> eller <code>dd.mm.yyyy</code>.</div>
      <div id="bd-list" class="bd-list"></div>
      <button class="btn" id="bd-add">+ Tilføj person</button>
    </div>

    <div class="card">
      <h2>Slides (rækkefølge = visningsrækkefølge)</h2>
      <div id="slides" class="slides"></div>
    </div>
  </div>
</div>

<template id="tpl-slide">
  <div class="slide">
    <h3></h3>
    <div class="row">
      <div>
        <label>Type</label>
        <select class="type">
          <option value="image">image</option>
          <option value="text">text</option>
          <option value="empties">empties</option>
          <option value="birthday">birthday</option>
        </select>
      </div>
      <div>
        <label>Varighed (sek.)</label>
        <input class="duration" type="number" min="3" value="8"/>
      </div>
    </div>
    <label>Titel</label>
    <input class="title" placeholder="Titel"/>
    <div class="content-fields"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
      <span class="muted"></span>
      <button class="btn danger remove">Fjern</button>
    </div>
  </div>
</template>

<template id="tpl-bd-item">
  <div class="bd-item">
    <input class="bd-name"  placeholder="Navn"/>
    <input class="bd-date"  placeholder="dd.mm eller dd.mm.yyyy"/>
    <input class="bd-image" placeholder="/media/navn.jpg eller fuld URL"/>
    <button class="btn danger remove">Fjern</button>
  </div>
</template>

<script>
const $=(s,e=document)=>e.querySelector(s);
const state={sha:null,data:null};

async function load(){
  $('#status').textContent='Indlæser…';
  const r=await fetch('/api/data',{cache:'no-store'});
  if(!r.ok) throw new Error('Fejl ved hentning');
  const { sha, data } = await r.json();
  state.sha=sha; state.data=data;

  // settings
  $('#brand').value   = data.brand||'';
  $('#logoUrl').value = data.logoUrl||'';
  $('#theme-bg1').value = data.settings?.theme?.bg1 || '';
  $('#theme-bg2').value = data.settings?.theme?.bg2 || '';
  $('#theme-accent').value = data.settings?.theme?.accent || '';
  $('#refreshMs').value = data.settings?.refreshMs ?? 300000;

  $('#empties-plan').value = (data.settings?.empties?.plan||[]).map(p=>`${p.name} – ${p.date}`).join('\n');

  // Fødselsdage
  $('#birthdays-msg').value = data.settings?.birthdaysMessage || 'Tillykke!';
  renderBirthdaysList(data.settings?.birthdays || []);

  // slides
  data.slides = Array.isArray(data.slides) ? data.slides : [];
  renderSlides($('#slides'), data.slides);

  // PIN
  $('#pin').value = localStorage.getItem('ADMIN_PIN') || '';

  $('#status').textContent='Klar';
}

function renderSlides(container, slides){
  container.innerHTML='';
  slides.forEach((s,idx)=>container.appendChild(makeSlide(s,idx)));
}
function makeSlide(s, idx){
  const t=$('#tpl-slide'), node=t.content.firstElementChild.cloneNode(true);
  node.querySelector('h3').textContent=`Slide #${idx+1}`;
  node.querySelector('.type').value=s.type||'text';
  node.querySelector('.duration').value=s.duration??8;
  node.querySelector('.title').value=s.title||'';
  node.querySelector('.muted').textContent=`type: ${s.type||'text'}`;
  const cf=node.querySelector('.content-fields'); fillContentFields(cf,s);

  node.querySelector('.type').addEventListener('change',e=>{ s.type=e.target.value; node.querySelector('.muted').textContent=`type: ${s.type}`; fillContentFields(cf,s); });
  node.querySelector('.duration').addEventListener('input',e=>s.duration=Number(e.target.value));
  node.querySelector('.title').addEventListener('input',e=>s.title=e.target.value);
  node.querySelector('.remove').addEventListener('click',()=>{ const i=state.data.slides.indexOf(s); if(i>=0){ state.data.slides.splice(i,1); renderSlides($('#slides'),state.data.slides);} });
  return node;
}
function fillContentFields(cf,s){
  cf.innerHTML='';
  if(s.type==='image'){
    const i=document.createElement('input'); i.placeholder='/media/Slide1.jpg eller fuld URL'; i.value=s.image||''; i.addEventListener('input',e=>s.image=e.target.value);
    cf.appendChild(label('Billede-URL')); cf.appendChild(i);
  }else if(s.type==='text'){
    const a=document.createElement('textarea'); a.placeholder='Din tekst…'; a.value=s.text||''; a.addEventListener('input',e=>s.text=e.target.value);
    cf.appendChild(label('Tekst')); cf.appendChild(a);
  }else{
    cf.appendChild(spanMuted('Denne slide bruger indstillinger fra venstre panel.'));
  }
}
function label(t){ const l=document.createElement('label'); l.textContent=t; return l; }
function spanMuted(t){ const s=document.createElement('div'); s.className='muted'; s.textContent=t; return s; }

/* --- Fødselsdage UI --- */
function renderBirthdaysList(items){
  const listEl = $('#bd-list');
  listEl.innerHTML='';
  (items||[]).forEach((b,idx)=> listEl.appendChild(makeBdItem(b,idx)));
}
function makeBdItem(b, idx){
  const t=$('#tpl-bd-item'), node=t.content.firstElementChild.cloneNode(true);
  const nameEl = node.querySelector('.bd-name');
  const dateEl = node.querySelector('.bd-date');
  const imgEl  = node.querySelector('.bd-image');
  nameEl.value = b.name || '';
  dateEl.value = b.date || '';
  imgEl.value  = b.image || '';
  nameEl.addEventListener('input',e=>b.name=e.target.value);
  dateEl.addEventListener('input',e=>b.date=e.target.value);
  imgEl.addEventListener('input',e=>b.image=e.target.value);
  node.querySelector('.remove').addEventListener('click',()=>{
    const arr = state.data.settings.birthdays || [];
    const i = arr.indexOf(b);
    if(i>=0){ arr.splice(i,1); renderBirthdaysList(arr); }
  });
  return node;
}
$('#bd-add').addEventListener('click', ()=>{
  state.data.settings = state.data.settings || {};
  state.data.settings.birthdays = state.data.settings.birthdays || [];
  const obj = { name:'', date:'', image:'' };
  state.data.settings.birthdays.push(obj);
  renderBirthdaysList(state.data.settings.birthdays);
});

/* --- Saml & gem --- */
function parseEmptiesPlan(text){
  return text.split(/\n+/).map(l=>l.trim()).filter(Boolean).map(l=>{
    let name=l, date='';
    const m=l.split('–'); if(m.length>=2){name=m[0].trim(); date=m.slice(1).join('–').trim();}
    else{ const p=l.split('-'); if(p.length>=2){name=p[0].trim(); date=p.slice(1).join('-').trim();} }
    return { name, date };
  });
}
function collect(){
  const data=structuredClone(state.data||{});
  data.brand   = $('#brand').value.trim();
  data.logoUrl = $('#logoUrl').value.trim();
  const theme = { bg1: $('#theme-bg1').value.trim(), bg2: $('#theme-bg2').value.trim(), accent: $('#theme-accent').value.trim() };
  const refreshMs = Math.max(300000, Number($('#refreshMs').value||0) || 300000);
  const plan = parseEmptiesPlan($('#empties-plan').value);

  data.settings = data.settings || {};
  data.settings.theme = theme;
  data.settings.refreshMs = refreshMs;
  data.settings.empties = data.settings.empties || {};
  data.settings.empties.plan = plan;

  // fødselsdage
  const list = [];
  document.querySelectorAll('#bd-list .bd-item').forEach(row=>{
    const name=row.querySelector('.bd-name').value.trim();
    const date=row.querySelector('.bd-date').value.trim();
    const image=row.querySelector('.bd-image').value.trim();
    if(name && date) list.push({ name, date, image });
  });
  data.settings.birthdays = list;
  data.settings.birthdaysMessage = $('#birthdays-msg').value.trim() || 'Tillykke!';

  return data;
}

async function save(){
  $('#status').textContent='Gemmer…';
  const pin=$('#pin').value.trim(); localStorage.setItem('ADMIN_PIN', pin);
  const r=await fetch('/api/save',{method:'POST',headers:{'Content-Type':'application/json','x-admin-pin':pin},body:JSON.stringify({data:collect(),sha:state.sha})});
  const jr=await r.json();
  if(!r.ok){ if(r.status===409){ $('#status').textContent='Konflikt – genindlæser…'; await load(); return; } $('#status').textContent='Fejl: '+(jr?.message||jr?.error||r.status); return; }
  $('#status').textContent='Gemt!'; await load();
}

/* --- Slide-knapper --- */
$('#add-image').addEventListener('click',()=>{ state.data.slides.push({type:'image',title:'Kampagne',image:'/media/Slide1.jpg',duration:8}); renderSlides($('#slides'),state.data.slides); });
$('#add-text').addEventListener('click',()=>{ state.data.slides.push({type:'text',title:'Info',text:'',duration:8}); renderSlides($('#slides'),state.data.slides); });
$('#add-empties').addEventListener('click',()=>{ state.data.slides.push({type:'empties',title:'TØMNINGS DAGE',duration:12}); renderSlides($('#slides'),state.data.slides); });
$('#add-birthday').addEventListener('click',()=>{ state.data.slides.push({type:'birthday',title:'Fødselsdage',duration:12}); renderSlides($('#slides'),state.data.slides); });

$('#save').addEventListener('click',save);
load().catch(e=>$('#status').textContent='Fejl: '+e.message);
</script>
</body>
</html>
