<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin • Infoskaerm</title>
  <style>
    :root{
      --bg:#0b1220;--panel:#111a2d;--muted:#243147;--text:#e8eefb;--brand:#5aa2ff;
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
    h1{margin:20px} h2{margin:8px 0 12px}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .panel{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:16px;margin:12px 0}
    label{display:block;margin:10px 0 6px}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid var(--muted);background:#0f172a;color:var(--text);font-size:15px}
    textarea{min-height:90px}
    .row{display:grid;gap:12px}
    .row.cols-2{grid-template-columns:1fr 1fr}
    .btn{display:inline-block;background:var(--brand);border:0;color:#061022;font-weight:700;padding:10px 14px;border-radius:8px;cursor:pointer}
    .btn.sub{background:#273955;color:#cfe1ff}
    .btn.small{padding:6px 10px;font-weight:600}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-bottom:1px solid var(--muted);padding:8px}
    th{text-align:left;opacity:.8}
    .right{display:flex;gap:10px;justify-content:flex-end}
    .muted{opacity:.8}
    .success{color:#81f69b} .error{color:#ff8c8c}
    .inline{display:flex;gap:8px;align-items:center}
    .hint{font-size:12px;opacity:.75;margin-top:4px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Admin • Infoskaerm</h1>

    <!-- Datakilde -->
    <section class="panel">
      <h2>Datakilde</h2>
      <label>Adresse til <code>data.json</code></label>
      <input id="dataUrl" value="https://perbonde07-byte.github.io/Infoskaerm/data.json" />
      <div class="actions">
        <button class="btn sub" id="loadBtn">Hent data</button>
        <button class="btn sub" id="downloadBtn">Download ny data.json</button>
        <button class="btn" id="saveBtn">Gem ændringer</button>
        <span id="status" class="muted"></span>
      </div>
    </section>

    <!-- Indstillinger -->
    <section class="panel">
      <h2>Indstillinger</h2>
      <label>Brand (vises i bunden)</label>
      <input id="brand" placeholder="Bredsgaard • Infoskaerm" />

      <div class="row cols-2">
        <div>
          <label>Logo URL (valgfrit)</label>
          <input id="logoUrl" placeholder="https://.../logo.png"/>
        </div>
        <div>
          <label>Logo placering</label>
          <select id="logoPos">
            <option value="top-right">Øverst højre</option>
            <option value="top-left">Øverst venstre</option>
            <option value="bottom-right">Nederst højre</option>
            <option value="bottom-left">Nederst venstre</option>
          </select>
        </div>
      </div>

      <div class="row cols-2">
        <div>
          <label>Media-mappe (OneDrive/GitHub/CDN) – base-URL (valgfrit)</label>
          <input id="mediaBase" placeholder="https://.../media/"/>
          <div class="hint">Hvis angivet, kan du nøjes med blot filnavn til billeder.</div>
        </div>
        <div>
          <label>Nøgle/kode til delt mappe (valgfrit)</label>
          <input id="mediaKey" placeholder="fx adgangskode"/>
        </div>
      </div>
    </section>

    <!-- Slides -->
    <section class="panel">
      <h2>Slides</h2>

      <div class="row cols-2">
        <div>
          <label>Type</label>
          <select id="s_type">
            <option value="bullets">Bullets (punktliste)</option>
            <option value="image">Billede (fuldskærm)</option>
          </select>
        </div>
        <div>
          <label>Titel</label>
          <input id="s_title" placeholder="Titel…"/>
        </div>
      </div>

      <div id="bulletsBox">
        <label>Linjer (én pr. linje)</label>
        <div class="inline">
          <textarea id="s_lines" placeholder="Punkt 1&#10;Punkt 2&#10;Punkt 3"></textarea>
          <button class="btn small sub" id="addLineBtn" type="button">+ Tilføj punkt</button>
        </div>
      </div>

      <div id="imageBox" style="display:none">
        <label>Billede URL</label>
        <input id="s_image" placeholder="https://…  eller kun filnavn hvis du har sat Media-base"/>
      </div>

      <div class="row cols-2">
        <div>
          <label>Varighed (sek.)</label>
          <input id="s_duration" type="number" value="12"/>
        </div>
        <div class="right" style="align-items:flex-end">
          <button class="btn" id="addSlide">Tilføj slide</button>
          <button class="btn sub" id="clearSlides">Tøm alle slides</button>
        </div>
      </div>

      <table id="slidesTable">
        <thead>
          <tr><th>#</th><th>Type</th><th>Titel</th><th>Forhåndsvisning</th><th></th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <p class="muted">Tip: Hvis “Gem ændringer” fejler, åbn <code>/api/debug-env</code> på Vercel-domænet for at se ENV’er.</p>
  </div>

  <script>
    // --- STATE & DOM refs -----------------------------------------------------
    const $  = s => document.querySelector(s);
    const els = {
      dataUrl:   $('#dataUrl'),
      status:    $('#status'),
      saveBtn:   $('#saveBtn'),

      brand:     $('#brand'),
      logoUrl:   $('#logoUrl'),
      logoPos:   $('#logoPos'),
      mediaBase: $('#mediaBase'),
      mediaKey:  $('#mediaKey'),

      s_type:    $('#s_type'),
      s_title:   $('#s_title'),
      s_lines:   $('#s_lines'),
      addLineBtn:$('#addLineBtn'),
      s_image:   $('#s_image'),
      s_duration:$('#s_duration'),

      bulletsBox:$('#bulletsBox'),
      imageBox:  $('#imageBox'),

      slidesTable:$('#slidesTable tbody'),
      loadBtn:   $('#loadBtn'),
      downloadBtn:$('#downloadBtn'),
      addSlide:  $('#addSlide'),
      clearSlides:$('#clearSlides')
    };

    const state = {
      dataUrl: els.dataUrl.value,
      data: {
        brand: 'Bredsgaard • Infoskaerm',
        logoUrl: '',
        logoPos: 'top-right',
        media: { baseUrl: '', key: '' },
        slides: []
      }
    };

    // --- UI helpers ----------------------------------------------------------
    function render(){
      // indstillinger
      els.brand.value     = state.data.brand || '';
      els.logoUrl.value   = state.data.logoUrl || '';
      els.logoPos.value   = state.data.logoPos || 'top-right';
      els.mediaBase.value = state.data.media?.baseUrl || '';
      els.mediaKey.value  = state.data.media?.key || '';

      // slides
      els.slidesTable.innerHTML = '';
      state.data.slides.forEach((s, i) => {
        const tr = document.createElement('tr');
        const preview = s.type === 'image'
          ? (s.image || '(intet)')
          : (s.lines || []).join(' • ');
        tr.innerHTML =
          `<td>${i+1}</td>
           <td>${s.type}</td>
           <td>${s.title || ''}</td>
           <td>${preview}</td>
           <td><button class="btn small sub" data-i="${i}">Slet</button></td>`;
        els.slidesTable.appendChild(tr);
      });
      els.slidesTable.querySelectorAll('button[data-i]').forEach(b=>{
        b.onclick = e => { const i = +e.target.dataset.i; state.data.slides.splice(i,1); render(); };
      });
    }

    function toggleTypeUI(){
      const t = els.s_type.value;
      els.bulletsBox.style.display = (t === 'bullets') ? '' : 'none';
      els.imageBox.style.display   = (t === 'image')   ? '' : 'none';
    }

    // --- LOAD / SAVE ----------------------------------------------------------
    async function load(){
      try{
        els.status.textContent = 'Henter data…';
        const res = await fetch(state.dataUrl + '?v=' + Date.now());
        if(!res.ok) throw new Error('HTTP '+res.status);
        const json = await res.json();

        // migration fra pipe -> newline, hvis nødvendigt
        (json.slides||[]).forEach(s=>{
          if(s.type==='bullets' && Array.isArray(s.lines)){
            // ok som array
          } else if (s.type==='bullets' && typeof s.lines==='string'){
            s.lines = s.lines.split('|').map(x=>x.trim()).filter(Boolean);
          }
        });

        state.data = Object.assign({
          brand:'Bredsgaard • Infoskaerm',
          logoUrl:'', logoPos:'top-right',
          media:{ baseUrl:'', key:'' },
          slides:[]
        }, json);

        render();
        els.status.textContent = 'Data hentet';
      }catch(e){
        state.data = { brand:'Bredsgaard • Infoskaerm', logoUrl:'', logoPos:'top-right', media:{baseUrl:'',key:''}, slides:[] };
        render();
        els.status.textContent = 'Ingen eksisterende data.json – starter tomt';
      }
    }

    async function save(){
      // sync inputs -> state
      state.data.brand               = els.brand.value.trim();
      state.data.logoUrl             = els.logoUrl.value.trim();
      state.data.logoPos             = els.logoPos.value;
      state.data.media.baseUrl       = els.mediaBase.value.trim();
      state.data.media.key           = els.mediaKey.value.trim();

      try{
        els.status.textContent = 'Gemmer…';
        els.saveBtn.disabled = true;

        const res = await fetch('/api/save',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(state.data)
        });
        const txt = await res.text();
        if(!res.ok){
          let msg = txt;
          try { const j = JSON.parse(txt); msg = j.error || j.detail || txt; } catch {}
          throw new Error(`HTTP ${res.status} – ${msg}`);
        }
        els.status.textContent = '✅ Data gemt på GitHub!';
      }catch(e){
        els.status.textContent = 'Fejl: ' + (e.message || e);
        alert('Gemning fejlede:\n\n' + (e.message||e));
      }finally{
        els.saveBtn.disabled = false;
      }
    }

    // --- EVENTS ---------------------------------------------------------------
    els.dataUrl.oninput = () => (state.dataUrl = els.dataUrl.value);
    els.loadBtn.onclick = load;
    els.saveBtn.onclick = save;
    $('#downloadBtn').onclick = () => {
      const blob = new Blob([JSON.stringify(state.data,null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'data.json'; a.click();
    };

    els.s_type.onchange = toggleTypeUI;
    toggleTypeUI();

    els.addLineBtn.onclick = () => {
      const v = els.s_lines.value;
      els.s_lines.value = (v.endsWith('\n') || v==='' ? v : v+'\n');
      els.s_lines.value += '';
      els.s_lines.focus();
    };

    els.addSlide.onclick = () => {
      const type = els.s_type.value;
      const title= els.s_title.value.trim();
      const dur  = Math.max(1, +els.s_duration.value || 12);

      const slide = { type, title, duration: dur };

      if(type==='bullets'){
        slide.lines = (els.s_lines.value||'')
          .split('\n')
          .map(x=>x.trim())
          .filter(Boolean);
        if(slide.lines.length===0){ alert('Tilføj mindst ét punkt.'); return; }
      }
      if(type==='image'){
        let img = els.s_image.value.trim();
        if(!img){ alert('Angiv billede-URL eller filnavn.'); return; }
        // hvis der bare står filnavn og der er baseUrl, sæt fuld sti
        if(!/^https?:\/\//i.test(img) && state.data.media.baseUrl){
          img = state.data.media.baseUrl.replace(/\/+$/,'') + '/' + img.replace(/^\/+/,'');
        }
        slide.image = img;
      }

      state.data.slides.push(slide);
      els.s_title.value=''; els.s_lines.value=''; els.s_image.value='';
      render();
    };

    els.clearSlides.onclick = () => {
      if(confirm('Slet alle slides?')){
        state.data.slides = [];
        render();
      }
    };

    load(); // initial
  </script>
</body>
</html>



