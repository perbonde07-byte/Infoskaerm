<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin – Infoskærm</title>
<style>
  :root{ --bg:#0f0f12; --panel:#17181c; --muted:#aab; --border:#262832; --accent:#37c97b; }
  html,body{margin:0;background:var(--bg);color:#e9eef6;font-family:system-ui,Segoe UI,Roboto,sans-serif}
  .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
  h1{margin:0 0 18px 0}
  h2{margin:32px 0 12px 0}
  h3{margin:24px 0 10px 0}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;margin:12px 0}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input,select,textarea{width:100%;box-sizing:border-box;background:#0e0f12;border:1px solid var(--border);border-radius:10px;padding:10px;color:#e9eef6}
  textarea{min-height:100px;font-family:ui-monospace,monospace}
  .row{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:8px;align-items:end;margin-bottom:8px}
  .btn{background:#13151a;border:1px solid var(--border);border-radius:10px;color:#fff;padding:10px 14px;cursor:pointer}
  .btn.green{background:var(--accent);border-color:#28b268;color:#04150c;font-weight:700}
  .slides{display:grid;gap:10px}
  .slidebox{border:1px solid var(--border);border-radius:12px;padding:12px}
  .right{display:flex;gap:8px;justify-content:flex-end}
  .muted{color:var(--muted);font-size:12px}
  .filegrid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:12px}
  .filecard{background:#101115;border:1px solid var(--border);border-radius:10px;padding:10px;display:grid;gap:6px}
  .filecard img{width:100%;height:120px;object-fit:cover;border-radius:6px;background:#0b0b0d}
  .filetop{display:flex;align-items:center;gap:8px}
  .path{font-size:12px;color:#cbd3e1;word-break:break-all}
</style>
</head>
<body>
<div class="wrap">
  <h1>Admin • Infoskærm</h1>

  <div class="panel">
    <div class="grid2">
      <div>
        <label>PIN (ADMIN_PIN)</label>
        <input id="pin" type="password" placeholder="****"/>
      </div>
      <div>
        <label>Opdaterings-interval (ms) – min. 300000</label>
        <input data-bind="settings.refreshMs" type="number" min="300000" step="1000" placeholder="300000"/>
      </div>
    </div>
  </div>

  <div class="panel">
    <h2>Brand</h2>
    <div class="grid2">
      <div>
        <label>Brand</label>
        <input data-bind="brand" placeholder="Bredsgaard • Infoskærm"/>
      </div>
      <div>
        <label>Logo URL</label>
        <input data-bind="logoUrl" placeholder="/media/logo.png"/>
      </div>
    </div>
  </div>

  <div class="panel">
    <h2>Tema</h2>
    <div class="grid2">
      <div>
        <label>Baggrund 1 (BG1)</label>
        <input data-bind="settings.theme.bg1" placeholder="#0d4b59"/>
      </div>
      <div>
        <label>Baggrund 2 (BG2)</label>
        <input data-bind="settings.theme.bg2" placeholder="#134d60"/>
      </div>
      <div>
        <label>Accentfarve</label>
        <input data-bind="settings.theme.accent" placeholder="#e8b15c"/>
      </div>
    </div>
  </div>

  <div class="panel">
    <h2>Stil (global)</h2>
    <div class="grid2">
      <label>Tekst skalering
        <input type="number" step="0.1" min="0.6" max="2" data-bind="settings.style.textScale" placeholder="1.0">
      </label>
      <label>Overskrift skalering
        <input type="number" step="0.1" min="0.6" max="2" data-bind="settings.style.titleScale" placeholder="1.0">
      </label>
      <label>Max billedhøjde – Billede+Tekst (vh)
        <input type="number" step="1" min="30" max="95" data-bind="settings.style.imageMaxVh" placeholder="80">
      </label>
      <label>Max billedhøjde – Fødselsdag (vh)
        <input type="number" step="1" min="30" max="95" data-bind="settings.style.birthdayImageMaxVh" placeholder="65">
      </label>
      <label>Billede fit
        <select data-bind="settings.style.imageFit">
          <option value="contain">contain (hele billedet)</option>
          <option value="cover">cover (fylder mere)</option>
        </select>
      </label>
    </div>
  </div>

  <div class="panel">
    <h2>Affaldstømning (automatisk plan)</h2>
    <div class="grid2">
      <label>Brug automatisk plan
        <input type="checkbox" data-bind="settings.empties.auto.enabled">
      </label>
      <label>Horizon (antal kommende linjer der vises)
        <input type="number" data-bind="settings.empties.auto.horizon" placeholder="12">
      </label>
      <label>Startdato
        <input type="date" data-bind="settings.empties.auto.startDate" placeholder="2025-01-01">
      </label>
      <label>Preview-dato (test) dd.mm.åååå
        <input type="text" data-bind="settings.empties.previewDate" placeholder="15.12.2025">
      </label>
    </div>

    <h3>Ugedage (vælg de dage hvor tømning kan ligge)</h3>
    <div class="grid2">
      <label><input type="checkbox" data-array="settings.empties.auto.weekdays" value="mon"> Man</label>
      <label><input type="checkbox" data-array="settings.empties.auto.weekdays" value="tue"> Tir</label>
      <label><input type="checkbox" data-array="settings.empties.auto.weekdays" value="wed"> Ons</label>
      <label><input type="checkbox" data-array="settings.empties.auto.weekdays" value="thu"> Tor</label>
      <label><input type="checkbox" data-array="settings.empties.auto.weekdays" value="fri"> Fre</label>
      <label><input type="checkbox" data-array="settings.empties.auto.weekdays" value="sat"> Lør</label>
      <label><input type="checkbox" data-array="settings.empties.auto.weekdays" value="sun"> Søn</label>
    </div>

    <h3>Navne (rækkefølge — én pr. linje)</h3>
    <textarea data-list="settings.empties.auto.names" placeholder="Per&#10;Louise&#10;Max"></textarea>

    <h3>Ekskluder datoer (én pr. linje — dd.mm.yyyy)</h3>
    <textarea data-list="settings.empties.auto.exclude" placeholder="25.12.2025&#10;01.01.2026"></textarea>

    <h3>Antal kolonner i visning</h3>
    <select data-bind="settings.empties.columns">
      <option value="1">1 kolonne</option>
      <option value="2" selected>2 kolonner</option>
      <option value="3">3 kolonner</option>
    </select>
    <div class="muted" style="margin-top:6px">Tabel-siden skifter først når markeringen har passeret sidste række.</div>
  </div>

  <div class="panel">
    <h2>Fødselsdage</h2>
    <label>Standard-besked (bruges i alarm-slides)</label>
    <input data-bind="settings.birthdaysMessage" placeholder="Tillykke med fødselsdagen - Håber du har dig en god uge.">

    <div id="bds" class="panel" style="background:#111; margin-top:12px">
      <div id="bdList"></div>
      <div class="right"><button class="btn" id="addBd">+ Tilføj person</button></div>
    </div>
  </div>

  <div class="panel">
    <h2>Slides</h2>
    <div id="slidesBox" class="slides"></div>
    <div class="right">
      <button class="btn" id="addImage">+ Billede</button>
      <button class="btn" id="addText">+ Tekst</button>
      <button class="btn" id="addEmpties">+ Tømning</button>
    </div>
  </div>

  <!-- Pb-desigen: Filhåndtering -->
  <div class="panel">
    <h2>Filer (medarbejdere / media)</h2>
    <div class="grid2">
      <div>
        <label>Mappe</label>
        <select id="dirSel">
          <option value="medarbejdere">/medarbejdere</option>
          <option value="media">/media</option>
        </select>
      </div>
      <div class="right">
        <button id="reloadFiles" class="btn">Genindlæs liste</button>
        <button id="deleteSel" class="btn" style="background:#a53636;border-color:#8b2d2d">Slet valgte filer</button>
      </div>
    </div>
    <div id="filesBox" class="filegrid"></div>
    <div class="muted">Pb-desigen: Sletning committer direkte til GitHub på BRANCH. (Ingen upload her – kun slet.)</div>
  </div>

  <div class="right" style="margin:18px 0 40px 0">
    <button id="saveBtn" class="btn green">Gem ændringer</button>
  </div>
</div>

<script>
/* Pb-desigen: state + helpers */
let MODEL = null;
function by(sel,root=document){return root.querySelector(sel)}
function all(sel,root=document){return Array.from(root.querySelectorAll(sel))}
function get(obj,path){return path.split('.').reduce((o,k)=>o&&o[k],obj)}
function set(obj,path,value){const keys=path.split('.');let o=obj;keys.slice(0,-1).forEach(k=>{if(!o[k]) o[k]={};o=o[k]});o[keys.at(-1)]=value}
function ensure(obj,path,def){if(get(obj,path)==null)set(obj,path,def)}
function create(tag,attrs={},children=[]){const el=document.createElement(tag);Object.entries(attrs).forEach(([k,v])=>{if(k==='class')el.className=v;else if(k==='text')el.textContent=v;else el.setAttribute(k,v)});children.forEach(c=>el.appendChild(c));return el}

/* Data ind/ud */
async function fetchData(){const r=await fetch('/api/data',{cache:'no-store'});const j=await r.json();return j.data}
function applyBindings(){
  all('[data-bind]').forEach(inp=>{
    const path=inp.getAttribute('data-bind');
    const val=get(MODEL,path);
    if(inp.type==='checkbox') inp.checked=!!val; else inp.value = (val??'');
    inp.addEventListener('input',()=>{
      const v = (inp.type==='checkbox') ? inp.checked : (inp.type==='number'? Number(inp.value) : inp.value);
      set(MODEL,path,v);
    });
  });
  all('[data-array]').forEach(inp=>{
    const path=inp.getAttribute('data-array');
    ensure(MODEL,path,[]);
    const arr=get(MODEL,path);
    inp.checked = arr.includes(inp.value);
    inp.addEventListener('change',()=>{
      const list=new Set(get(MODEL,path) || []);
      if(inp.checked) list.add(inp.value); else list.delete(inp.value);
      set(MODEL,path,[...list]);
    });
  });
  all('[data-list]').forEach(ta=>{
    const path=ta.getAttribute('data-list');
    const arr=get(MODEL,path) || [];
    ta.value = arr.join('\n');
    ta.addEventListener('input',()=>{
      set(MODEL,path, ta.value.split(/\n+/).map(s=>s.trim()).filter(Boolean));
    });
  });
}

/* Fødselsdage UI */
function renderBirthdays(){
  const box=by('#bdList'); box.innerHTML='';
  ensure(MODEL,'settings.birthdays',[]);
  const list=MODEL.settings.birthdays;
  list.forEach((p,idx)=>{
    const row=create('div',{class:'row'},[
      create('div',{},[create('label',{text:'Navn'}), create('input',{value:p.name||''})]),
      create('div',{},[create('label',{text:'Dato (dd.mm.yyyy)'}), create('input',{value:p.date||''})]),
      create('div',{},[create('label',{text:'Billede (valgfri)'}), create('input',{value:p.image||'',placeholder:'/medarbejdere/Per-Bonde.jpg'})]),
      create('div',{},[create('button',{class:'btn',text:'Fjern'})])
    ]);
    const [iName,iDate,iImg,btn] = all('input,button',row);
    iName.addEventListener('input',()=>{p.name=iName.value});
    iDate.addEventListener('input',()=>{p.date=iDate.value});
    iImg.addEventListener('input',()=>{p.image=iImg.value});
    btn.addEventListener('click',()=>{list.splice(idx,1);renderBirthdays();});
    box.appendChild(row);
  });
}
by('#addBd').addEventListener('click',()=>{ensure(MODEL,'settings.birthdays',[]); MODEL.settings.birthdays.push({name:'',date:'',image:''}); renderBirthdays();});

/* Slides UI */
function renderSlides(){
  const box=by('#slidesBox'); box.innerHTML='';
  ensure(MODEL,'slides',[]);
  MODEL.slides.forEach((s,idx)=>{
    const sb=create('div',{class:'slidebox'});
    const head=create('div',{class:'grid2'},[
      create('div',{},[
        create('label',{text:'Type'}),
        (()=>{const sel=create('select');['image','text','empties','birthday'].forEach(t=>{const o=create('option',{text:t});o.value=t; if(s.type===t) o.selected=true; sel.appendChild(o)}); sel.addEventListener('change',()=>{s.type=sel.value;renderSlides()}); return sel})()
      ]),
      create('div',{},[
        create('label',{text:'Varighed (sek.)'}),
        create('input',{type:'number',value:s.duration||8})
      ])
    ]);
    const [selType,inpDur] = all('select,input',head);
    inpDur.addEventListener('input',()=>{s.duration=Number(inpDur.value)});

    const body=create('div');
    if(s.type==='image'){
      body.appendChild(create('div',{class:'grid2'},[
        create('div',{},[create('label',{text:'Titel'}),create('input',{value:s.title||''})]),
        create('div',{},[create('label',{text:'Billede URL'}),create('input',{value:s.image||'',placeholder:'/media/slide.jpg'})])
      ]));
      body.appendChild(create('div',{class:'grid2'},[
        create('div',{},[create('label',{text:'Side-tekst (valgfri)'}),create('textarea',{text:s.sideText||''})]),
        create('div',{},[
          create('label',{text:'Billede til venstre/højre'}),
          (()=>{const sel=create('select');[['right','Billede til højre'],['left','Billede til venstre']].forEach(([v,t])=>{const o=create('option',{text:t});o.value=v; if(s.imageAlign===v) o.selected=true; sel.appendChild(o)}); sel.addEventListener('change',()=>{s.imageAlign=sel.value}); return sel})()
        ])
      ]));
      body.appendChild(create('div',{class:'grid2'},[
        create('div',{},[create('label',{text:'Slide-billede skalering (×)'}),create('input',{type:'number',step:'0.1',min:'0.5',max:'2',value:s.imageScale||1})]),
        create('div',{},[create('label',{text:'Slide-tekst skalering (×)'}),create('input',{type:'number',step:'0.1',min:'0.5',max:'2',value:s.textScale||1})])
      ]));
      const [iTitle,iImg] = all('input',body);
      const iSide = body.querySelector('textarea');
      const [iImageScale,iTextScale] = all('input',body).slice(-2);
      iTitle.addEventListener('input',()=>{s.title=iTitle.value});
      iImg.addEventListener('input',()=>{s.image=iImg.value});
      iSide.addEventListener('input',()=>{s.sideText=iSide.value});
      body.querySelector('select').addEventListener('change',e=>{s.imageAlign=e.target.value});
      iImageScale.addEventListener('input',()=>{s.imageScale=Number(iImageScale.value)});
      iTextScale.addEventListener('input',()=>{s.textScale=Number(iTextScale.value)});
    }
    else if(s.type==='text'){
      body.appendChild(create('div',{class:'grid2'},[
        create('div',{},[create('label',{text:'Titel'}),create('input',{value:s.title||''})]),
        create('div',{},[create('label',{text:'(pr. slide) Tekst-skalering (×)'}),create('input',{type:'number',step:'0.1',min:'0.5',max:'2',value:s.textScale||1})])
      ]));
      body.appendChild(create('div',{},[create('label',{text:'Tekst'}),create('textarea',{text:s.text||''})]));
      const [iTitle,iTxtScale]=all('input',body);
      const ta=body.querySelector('textarea');
      iTitle.addEventListener('input',()=>{s.title=iTitle.value});
      iTxtScale.addEventListener('input',()=>{s.textScale=Number(iTxtScale.value)});
      ta.addEventListener('input',()=>{s.text=ta.value});
    }
    else if(s.type==='empties'){
      body.appendChild(create('div',{},[create('label',{text:'Titel'}),create('input',{value:s.title||'TØMNINGS DAGE'})]));
      const inp=body.querySelector('input'); inp.addEventListener('input',()=>{s.title=inp.value});
    }
    else if(s.type==='birthday'){
      body.appendChild(create('div',{},[create('label',{text:'Titel'}),create('input',{value:s.title||'Fødselsdage'})]));
      const inp=body.querySelector('input'); inp.addEventListener('input',()=>{s.title=inp.value});
    }

    const foot=create('div',{class:'right'},[
      create('button',{class:'btn',text:'Fjern slide'})
    ]);
    foot.querySelector('button').addEventListener('click',()=>{MODEL.slides.splice(idx,1);renderSlides()});

    sb.append(head,body,foot);
    box.appendChild(sb);
  });
}
by('#addImage').addEventListener('click',()=>{ensure(MODEL,'slides',[]); MODEL.slides.push({type:'image',title:'',image:'',sideText:'',imageAlign:'right',duration:12}); renderSlides();});
by('#addText').addEventListener('click',()=>{ensure(MODEL,'slides',[]); MODEL.slides.push({type:'text',title:'',text:'',duration:10}); renderSlides();});
by('#addEmpties').addEventListener('click',()=>{ensure(MODEL,'slides',[]); MODEL.slides.push({type:'empties',title:'TØMNINGS DAGE',duration:12}); renderSlides();});

/* Filhåndtering (liste + slet) */
async function loadFiles(dir){
  const r = await fetch(`/api/data?action=list&dir=${encodeURIComponent(dir)}`,{cache:'no-store'});
  if(!r.ok){ alert('Kunne ikke hente fil-liste'); return []; }
  const j = await r.json();
  return j.files||[];
}
function renderFiles(dir, files){
  const box = by('#filesBox'); box.innerHTML='';
  files.forEach(f=>{
    const card=create('div',{class:'filecard'});
    const top=create('div',{class:'filetop'},[
      create('input',{type:'checkbox','data-path':f.path}),
      create('div',{class:'path',text:f.path})
    ]);
    let thumb;
    if(/\.(png|jpe?g|gif|webp)$/i.test(f.path)){
      thumb=create('img'); thumb.src=f.raw||'#';
    }else{
      thumb=create('div',{class:'muted',text:'(ingen preview)'});
    }
    card.append(thumb,top);
    box.appendChild(card);
  });
}
async function refreshFiles(){
  const dir=by('#dirSel').value;
  const files=await loadFiles(dir);
  renderFiles(dir,files);
}
by('#reloadFiles').addEventListener('click',refreshFiles);

by('#deleteSel').addEventListener('click',async ()=>{
  const pin=by('#pin').value.trim();
  const checks=all('#filesBox input[type="checkbox"]:checked');
  if(!checks.length){ alert('Vælg mindst én fil'); return; }
  if(!confirm('Slet valgte filer? Dette kan ikke fortrydes.')) return;
  const deletePaths = checks.map(c=>c.getAttribute('data-path'));
  const r = await fetch('/api/save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({pin,deletePaths})});
  const j = await r.json().catch(()=>({}));
  if(!r.ok){ alert('Fejl ved sletning: '+(j?.error||r.statusText)); return; }
  alert('Slettet ✔');
  refreshFiles();
});

/* Load + defaults + knapper */
(async()=>{
  MODEL = await fetchData();
  ensure(MODEL,'settings.theme',{});
  ensure(MODEL,'settings.style',{textScale:1,titleScale:1,imageMaxVh:80,birthdayImageMaxVh:65,imageFit:'contain'});
  ensure(MODEL,'settings.empties.auto',{enabled:true,startDate:'2025-01-01',weekdays:['mon'],names:[],exclude:[],horizon:12});
  ensure(MODEL,'settings.empties.columns',2);
  ensure(MODEL,'settings.birthdaysMessage','Tillykke med fødselsdagen - Håber du har dig en god uge.');
  applyBindings(); renderBirthdays(); renderSlides(); refreshFiles();
})();

by('#saveBtn').addEventListener('click', async ()=>{
  const pin=by('#pin').value.trim();
  const r = await fetch('/api/save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({pin,data:MODEL})});
  const j = await r.json().catch(()=>({}));
  if(r.ok){ alert('Gemt ✅'); } else { alert('Fejl: '+(j?.error||r.statusText)); }
});
by('#dirSel').addEventListener('change', refreshFiles);
</script>
</body>
</html>

