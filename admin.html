<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin • Infoscreen</title>

<style>
  /* PB-DESIGN: klassisk admin UI */
  :root{
    --bg:#0d4952; --panel:#0c2d33; --ink:#e9fbff; --dim:#a8d7de;
    --ok:#1f9d68; --bad:#d35a5a; --stroke:#0a2328; --radius:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{max-width:1200px;margin:18px auto 10px;padding:0 18px;display:flex;align-items:center;justify-content:space-between}
  h1{margin:0;font-weight:800}
  .head-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{background:#173c43;border:1px solid var(--stroke);color:var(--ink);padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn.ok{background:var(--ok)}
  .btn.bad{background:#5a1f1f;border-color:#411515}

  .wrap{max-width:1200px;margin:0 auto 80px;padding:0 18px;display:grid;grid-template-columns:1fr 420px;gap:14px}
  .panel{background:var(--panel);border:1px solid var(--stroke);border-radius:var(--radius)}
  .footer{position:sticky;bottom:0;background:#0c2d33;border-top:1px solid var(--stroke);padding:10px 18px;display:flex;justify-content:flex-end;gap:10px}

  /* Loader placeholder til moduler */
  [data-include] { display:block; min-height:20px; }
  [data-include].loading::before{
    content:"Indlæser…"; display:block; padding:18px; color:var(--dim); font-size:14px;
  }
  [data-include].error::before{
    content:attr(data-error); display:block; padding:18px; color:#ffd9d9; background:#4b1f1f; border-radius:10px; margin:6px;
  }
</style>
</head>
<body>

<header>
  <h1>Admin • Infoscreen</h1>
  <div class="head-actions">
    <button class="btn" id="openFiles">Filer (medarb & media)</button>
    <button class="btn" id="addImage">+ Billede</button>
    <button class="btn" id="addText">+ Tekst</button>
    <button class="btn" id="addEmpties">+ Tømning</button>
    <button class="btn" id="addBirth">+ Fødselsdage</button>
  </div>
</header>

<!-- Venstre kolonne -->
<div class="wrap">
  <div class="left-col" style="display:flex;flex-direction:column;gap:14px">

    <!-- Brand & Tema -->
    <div class="panel" data-include="/admin/brand_tema.html"></div>

    <!-- Tømning (automatisk plan) -->
    <div class="panel" data-include="/admin/tomme.html"></div>

    <!-- Fødselsdage -->
    <div class="panel" data-include="/admin/foedselsdage.html"></div>

    <!-- Kalender (ICS) -->
    <div class="panel" data-include="/admin/kalender.html"></div>

  </div>

  <!-- Højre kolonne: Slides -->
  <div class="panel" data-include="/admin/slides.html"></div>
</div>

<div class="footer">
  <input id="adminPin" type="password" placeholder="PIN (ADMIN_PIN)" style="max-width:220px;border-radius:10px;border:1px solid var(--stroke);background:#0a2328;color:var(--ink);padding:10px 12px">
  <button class="btn ok" id="saveBtn">Gem ændringer</button>
</div>

<script>
/* ===========================================================
   PB-DESIGN • Admin kerne
   - Robust include loader (virker på Vercel + GitHub Pages)
   - Globalt API + data-hjælpere som modulerne kan bruge
   =========================================================== */

/* --- Repo-base detektion (så /Infoskaerm/... virker på GitHub Pages) --- */
const REPO_BASE = (function(){
  // Eksempel: https://perbonde07-byte.github.io/Infoskaerm/admin.html
  // pathname: /Infoskaerm/admin.html  -> base = /Infoskaerm
  const parts = location.pathname.split('/').filter(Boolean);
  if (location.hostname.endsWith('github.io') && parts.length > 1) {
    return '/' + parts[0]; // "/Infoskaerm"
  }
  return ''; // Vercel eller egen host: rod = ""
})();

/* --- Include loader --- */
async function loadIncludes() {
  const blocks = Array.from(document.querySelectorAll('[data-include]'));
  for (const el of blocks) {
    const src = el.getAttribute('data-include'); // starter med /admin/...
    const url = REPO_BASE + src;                 // tilpas til GitHub Pages
    el.classList.add('loading');
    try {
      const res = await fetch(url, {cache:'no-store'});
      if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
      const html = await res.text();

      // Indsæt HTML
      el.innerHTML = html;
      el.classList.remove('loading');

      // Eksekver <script>-tags i fragmentet
      Array.from(el.querySelectorAll('script')).forEach(old => {
        const s = document.createElement('script');
        if (old.src) s.src = (old.src.startsWith('/') ? (REPO_BASE + old.src) : old.src);
        s.type = old.type || 'text/javascript';
        s.defer = old.defer || false;
        s.async = false;
        s.text = old.textContent;
        old.replaceWith(s);
      });
    } catch (err) {
      el.classList.remove('loading');
      el.classList.add('error');
      el.setAttribute('data-error', `Kunne ikke indlæse ${src} — ${err.message}`);
    }
  }
}

/* --- Globalt API mod /api/data (modulerne genbruger det) --- */
async function api(action, payload){
  const r = await fetch(REPO_BASE + "/api/data", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ action, ...(payload||{}) })
  });
  const j = await r.json();
  if(!j.ok) throw new Error(j.error||"Ukendt fejl");
  return j;
}
async function loadData(){
  const r = await fetch(REPO_BASE + "/api/data", {cache:"no-store"});
  const j = await r.json();
  if(!j.ok) throw new Error(j.error||"Ukendt fejl");
  return j.content;
}

/* --- Gør kerneobjekter tilgængelige for modulerne --- */
window.PB = {
  REPO_BASE,
  api, loadData,
  data: null,        // udfyldes efter load
  onSave: [],        // moduler kan pushe save-callbacks hertil
  onReady: []        // moduler kan pushe init-callbacks hertil
};

/* --- Global “Gem” knap koblet til alle modulers onSave --- */
document.getElementById('saveBtn').addEventListener('click', async () => {
  const pin = document.getElementById('adminPin').value.trim();
  if(!pin){ alert("Indtast PIN (ADMIN_PIN) før gem."); return; }

  // Kald alle modulers save-funktioner (de opdaterer PB.data in-place)
  for (const fn of PB.onSave) { try { await fn(PB.data); } catch(e){ console.error(e); } }

  await api("saveDataJson", { data: PB.data, message:"PB-DESIGN: admin gem via inkluderede moduler" });
  alert("Gemt ✔");
});

/* --- Indlæs data + includes, og init derefter modulerne --- */
(async function boot(){
  PB.data = await loadData();      // gør data tilgængelig for modulerne
  await loadIncludes();            // hent /admin/*.html og eksekver deres scripts
  // Når alle moduler er indsat, får de lov at initialisere sig
  for (const fn of PB.onReady) { try { await fn(PB.data); } catch(e){ console.error(e); } }
})();
</script>

</body>
</html>
