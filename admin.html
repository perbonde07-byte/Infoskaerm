<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin • Infoskaerm</title>

  <!-- ========== SIMPLE LOCK ========== -->
  <script>
    const ADMIN_KEY = "0705";
    (function gate() {
      try {
        const q = new URLSearchParams(location.search);
        const pin = (q.get("admin") || "").trim();
        if (pin && pin === ADMIN_KEY) {
          localStorage.setItem("admin_ok", "1");
          const url = new URL(location.href);
          url.searchParams.delete("admin");
          location.replace(url.toString());
          return;
        }
        if (localStorage.getItem("admin_ok") === "1") return;

        document.head.innerHTML = "";
        document.body.innerHTML = `
          <style>
            html,body{height:100%;margin:0}
            body{background:#0b1220;color:#e8eefb;font-family:system-ui,Segoe UI,Roboto,Arial;
                 display:flex;align-items:center;justify-content:center}
            .card{width:min(92vw,420px);background:#111a2d;border:1px solid rgba(255,255,255,.1);
                  border-radius:16px;padding:24px;text-align:center}
            .card h1{margin:0 0 10px;font-size:22px}
            input,button{width:100%;padding:12px;border-radius:10px;border:1px solid #243147;
                  background:#0f172a;color:#e8eefb;font-size:16px}
            button{margin-top:10px;background:#5aa2ff;color:#061022;border:0;font-weight:600;cursor:pointer}
            .hint{margin-top:8px;opacity:.7;font-size:12px}
          </style>
          <div class="card">
            <h1>Ingen adgang</h1>
            <p>Indtast kode for at åbne admin.</p>
            <input id="pin" placeholder="Kode" inputmode="numeric" />
            <button id="ok">Log ind</button>
            <div class="hint">Tip: åbne også via <code>?admin=${ADMIN_KEY}</code></div>
          </div>`;
        addEventListener("click", (e)=>{ if(e.target.id==="ok") tryLogin(); });
        addEventListener("keydown", (e)=>{ if(e.key==="Enter") tryLogin(); });
        function tryLogin(){
          const v=(document.getElementById("pin").value||"").trim();
          if(v===ADMIN_KEY){ localStorage.setItem("admin_ok","1"); location.reload(); }
          else alert("Forkert kode");
        }
      } catch(err){
        alert("Gate-fejl: "+err.message);
      }
    })();
  </script>
  <!-- ========== /SIMPLE LOCK ========== -->

  <style>
    :root{
      --bg:#0b1220; --panel:#111a2d; --muted:#243147; --text:#e8eefb; --brand:#5aa2ff;
      --ok:#33d17a; --warn:#ffcc66; --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 14px}
    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tabbtn{
      padding:10px 14px;border:1px solid var(--muted);background:#0f172a;color:var(--text);
      border-radius:10px;cursor:pointer;font-weight:600;
    }
    .tabbtn.active{background:var(--brand);color:#061022;border-color:transparent}
    .panel{background:var(--panel);border:1px solid var(--muted);border-radius:14px;padding:16px;margin-bottom:16px}
    label{display:block;margin:.6rem 0 .25rem .1rem;font-size:.95rem;opacity:.9}
    input,select,textarea{
      width:100%;padding:10px;border-radius:10px;border:1px solid var(--muted);
      background:#0f172a;color:var(--text);font-size:15px;
    }
    textarea{min-height:90px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .row-3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:10px 14px;border:0;border-radius:10px;
         background:var(--brand);color:#061022;font-weight:700;cursor:pointer}
    .btn.ghost{background:#0f172a;border:1px solid var(--muted);color:var(--text)}
    .btn.danger{background:var(--danger)}
    .status{margin-left:10px;font-size:.92rem;opacity:.9}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid var(--muted);text-align:left}
    .right{display:flex;gap:8px;justify-content:flex-end}
    .small{opacity:.8;font-size:.9rem}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#0f172a;border:1px solid var(--muted);font-size:.85rem}
    .hint{opacity:.7;font-size:.9rem}
    .hide{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Admin • Infoskaerm</h1>

    <!-- TOP TABS -->
    <div class="tabs">
      <button class="tabbtn active" data-tab="slides">Slides</button>
      <button class="tabbtn" data-tab="settings">Indstillinger</button>
      <button class="tabbtn" data-tab="data">Datakilde</button>
      <span id="globalStatus" class="status"></span>
    </div>

    <!-- ============== SLIDES (DEFAULT) ============== -->
    <section id="tab-slides" class="panel">
      <div class="row">
        <div>
          <label>Skabelon</label>
          <select id="s_type">
            <option value="bullets">Bullets (tekst)</option>
            <option value="image">Billede (fuldskærm)</option>
            <option value="empties">Tømningstabel</option>
            <option value="birthday">Fødselsdag</option>
          </select>
        </div>
        <div>
          <label>Titel</label>
          <input id="s_title" placeholder="Titel..." />
        </div>
      </div>

      <label>Linjer (brug | til flere)</label>
      <textarea id="s_lines" placeholder="Punkt 1 | Punkt 2 | Punkt 3"></textarea>

      <div class="row">
        <div>
          <label>Billede URL (ved skabelon = billede)</label>
          <input id="s_image" placeholder="https://..." />
        </div>
        <div>
          <label>Varighed (sek.)</label>
          <input id="s_duration" type="number" value="12" />
        </div>
      </div>

      <div class="right">
        <button id="addSlide" class="btn">Tilføj slide</button>
        <button id="clearSlides" class="btn ghost">Tøm alle slides</button>
      </div>

      <table id="slidesTable">
        <thead>
          <tr><th>#</th><th>Type</th><th>Titel</th><th>Forhåndsvisning</th><th class="right">Handling</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- ============== SETTINGS (HIDDEN) ============== -->
    <section id="tab-settings" class="panel hide">
      <h3 style="margin-top:0">Indstillinger</h3>
      <div class="row">
        <div>
          <label>Brand / navn (vises i bunden)</label>
          <input id="brand" placeholder="Bredsgaard • Infoskaerm" />
        </div>
        <div>
          <label>Logo URL</label>
          <input id="logoUrl" placeholder="https://.../logo.png" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Logo placering</label>
          <select id="logoPos">
            <option>Øverst højre</option>
            <option>Øverst venstre</option>
            <option>Nederst højre</option>
            <option>Nederst venstre</option>
          </select>
        </div>
        <div class="small" style="align-self:end">
          <span class="pill">Tip</span> Du kan bruge OneDrive/raw-links eller andre CDN-links som billedkilder.
        </div>
      </div>
      <div class="hint">Disse indstillinger gemmes sammen med dine slides, når du trykker “Gem til server” i Datakilde-fanen.</div>
    </section>

    <!-- ============== DATA SOURCE (HIDDEN) ============== -->
    <section id="tab-data" class="panel hide">
      <h3 style="margin-top:0">Datakilde</h3>
      <label>Adresse til <code>data.json</code></label>
      <input id="dataUrl" />
      <div class="right" style="margin-top:8px">
        <button id="loadBtn" class="btn ghost">Hent data</button>
        <button id="downloadBtn" class="btn ghost">Download ny data.json</button>
        <button id="saveServerBtn" class="btn">Gem til server</button>
      </div>
      <div id="status" class="status"></div>
    </section>

    <div class="small hint">Genveje: <span class="pill">1</span> Slides • <span class="pill">2</span> Indstillinger • <span class="pill">3</span> Datakilde</div>
  </div>

  <script>
    /* ---------- UI TABS ---------- */
    const tabBtns = document.querySelectorAll(".tabbtn");
    const tabs = {
      slides: document.getElementById("tab-slides"),
      settings: document.getElementById("tab-settings"),
      data: document.getElementById("tab-data"),
    };
    const globalStatus = document.getElementById("globalStatus");

    function showTab(name){
      Object.values(tabs).forEach(el=>el.classList.add("hide"));
      tabs[name].classList.remove("hide");
      tabBtns.forEach(b=>b.classList.toggle("active", b.dataset.tab===name));
      localStorage.setItem("admin_tab", name);
    }
    tabBtns.forEach(b=>b.addEventListener("click",()=>showTab(b.dataset.tab)));
    // hotkeys 1/2/3
    addEventListener("keydown",(e)=>{
      if(e.target.tagName.match(/INPUT|TEXTAREA|SELECT/)) return;
      if(e.key==="1") showTab("slides");
      if(e.key==="2") showTab("settings");
      if(e.key==="3") showTab("data");
    });
    showTab(localStorage.getItem("admin_tab") || "slides");

    /* ---------- STATE ---------- */
    const state = {
      dataUrl: 'https://perbonde07-byte.github.io/Infoskaerm/data.json',
      data: { brand:'Bredsgaard • Infoskaerm', logoUrl:'', logoPos:'Øverst højre', slides:[] }
    };
    const $ = (s)=>document.querySelector(s);
    const status = $('#status');

    /* ---------- RENDER ---------- */
    function render(){
      // sync settings inputs
      $('#brand').value = state.data.brand || '';
      $('#logoUrl').value = state.data.logoUrl || '';
      $('#logoPos').value = state.data.logoPos || 'Øverst højre';
      $('#dataUrl').value = state.dataUrl;

      // table
      const tbody = $('#slidesTable tbody'); tbody.innerHTML = '';
      state.data.slides.forEach((s,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${s.type}</td>
          <td>${s.title||''}</td>
          <td>${s.type==='image' ? (s.image||'(intet)') : (s.lines||[]).join(' | ')}</td>
          <td class="right">
            <button class="btn ghost" data-ed="${i}">Redigér</button>
            <button class="btn danger" data-del="${i}">Slet</button>
          </td>`;
        tbody.appendChild(tr);
      });

      // handlers
      tbody.querySelectorAll('[data-del]').forEach(b=>b.onclick = e=>{
        const i = +e.currentTarget.dataset.del;
        if(confirm('Slet denne slide?')){
          state.data.slides.splice(i,1); render();
        }
      });
      tbody.querySelectorAll('[data-ed]').forEach(b=>b.onclick = e=>{
        const i = +e.currentTarget.dataset.ed;
        const s = state.data.slides[i];
        $('#s_type').value = s.type;
        $('#s_title').value = s.title || '';
        $('#s_lines').value = (s.lines||[]).join(' | ');
        $('#s_image').value = s.image || '';
        $('#s_duration').value = s.duration || 12;
        showTab('slides');
        globalStatus.textContent = 'Felt udfyldt fra valgt slide – redigér og “Tilføj slide” for at indsætte som ny.';
        setTimeout(()=>globalStatus.textContent='', 4000);
      });
    }

    /* ---------- LOAD/SAVE ---------- */
    async function load(){
      try{
        status.textContent='Henter data...';
        const res = await fetch(state.dataUrl+'?v='+Date.now());
        if(!res.ok) throw new Error('HTTP '+res.status);
        state.data = await res.json();
        render();
        status.textContent='Data hentet.';
      }catch(err){
        state.data = { brand:'Bredsgaard • Infoskaerm', logoUrl:'', logoPos:'Øverst højre', slides:[] };
        render();
        status.textContent='Ingen eksisterende data.json – starter tomt.';
      }
    }

    async function saveToGithub(){
      try{
        status.textContent='Gemmer til server...';
        // sync settings ind før gem
        state.data.brand = $('#brand').value.trim() || 'Bredsgaard • Infoskaerm';
        state.data.logoUrl = $('#logoUrl').value.trim();
        state.data.logoPos = $('#logoPos').value;

        const res = await fetch('/api/save', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(state.data)
        });
        const txt = await res.text();
        if(!res.ok) throw new Error(txt);
        status.textContent='✅ Data gemt på GitHub!';
      }catch(err){
        status.textContent='Fejl under gemning: '+err.message;
      }
    }

    /* ---------- UI BINDINGS ---------- */
    $('#loadBtn').onclick = load;
    $('#saveServerBtn').onclick = saveToGithub;
    $('#downloadBtn').onclick = ()=>{
      const blob = new Blob([JSON.stringify(state.data,null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'data.json'; a.click();
    };

    $('#addSlide').onclick = ()=>{
      const s = {
        type: $('#s_type').value,
        title: $('#s_title').value.trim(),
        lines: ($('#s_lines').value||'').split('|').map(x=>x.trim()).filter(Boolean),
        image: $('#s_image').value.trim(),
        duration: +$('#s_duration').value || 12
      };
      state.data.slides.push(s); render();
      globalStatus.textContent = 'Slide tilføjet (ikke gemt endnu). Gå til Datakilde → “Gem til server”.';
      setTimeout(()=>globalStatus.textContent='', 3500);
    };

    $('#clearSlides').onclick = ()=>{
      if(confirm('Tøm alle slides?')){
        state.data.slides = []; render();
      }
    };

    // sync manual changes
    $('#dataUrl').addEventListener('change', (e)=>{ state.dataUrl = e.target.value.trim(); });

    // initial
    render();
    // hent eksisterende
    state.dataUrl = 'https://perbonde07-byte.github.io/Infoskaerm/data.json';
    load();
  </script>
</body>
</html>

