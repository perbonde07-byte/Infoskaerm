<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Kalender • Infoskærm</title>
<style>
  :root{
    --bg:#0b6a74; --bg2:#0d4952; --ink:#e9fbff; --line:rgba(255,255,255,.12);
    --accent:#a7d0c9;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(160deg,var(--bg),var(--bg2));color:var(--ink);font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{min-height:100%;padding:24px;display:grid;place-items:center}
  .card{width:min(1200px,95vw);background:rgba(0,0,0,.08);border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:20px}
  h1{margin:0 0 14px;font-weight:800;letter-spacing:.03em}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--line);padding:10px 12px;text-align:left;vertical-align:top}
  th{opacity:.85;font-size:13px;letter-spacing:.08em;text-transform:uppercase}
  .muted{opacity:.8}
  .brand{margin-top:12px;opacity:.8;font-size:12px}

  /* Visningsstile */
  .bullet::before{content:"•"; margin-right:.6em; color:var(--accent)}
  .arrow::before{content:"→"; margin-right:.6em; color:var(--accent)}
  .box{border:1px solid var(--line); border-radius:10px; padding:10px 12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1 id="title">Kalender</h1>
    <div id="msg" class="muted" style="margin-bottom:8px"></div>

    <!-- “boxes” style uses rows with bordered cells; bullets/arrows use list-look but we keep table to align dates -->
    <table>
      <thead>
        <tr><th>Dato</th><th id="thTime">Tid</th><th>Event</th><th>Sted</th></tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <div class="brand" id="brand"></div>
  </div>
</div>

<script>
const $=(q,el=document)=>el.querySelector(q);

function pad2(n){return String(n).padStart(2,"0")}
function fmtDate(d){return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${d.getFullYear()}`}
function fmtTime(d){return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`}

function parseICS(text){
  // simpel iCal-parser for VEVENT
  const events=[];
  const chunks=text.split(/BEGIN:VEVENT/gi).slice(1);
  for(const ch of chunks){
    const block=(ch.split(/END:VEVENT/i)[0]||"")+"\n";
    const pick=(re)=>{ const m=block.match(re); return m?m[1].trim():""; };

    const dtstart=pick(/DTSTART(?:;[^:\n]*)?:(.+)\r?\n/i);
    const dtend  =pick(/DTEND(?:;[^:\n]*)?:(.+)\r?\n/i);
    const summary=pick(/SUMMARY:(.+)\r?\n/i);
    const location=pick(/LOCATION:(.+)\r?\n/i);
    const description=pick(/DESCRIPTION:(.+)\r?\n/i);

    const parseDT=(s)=>{
      if(!s) return null;
      const m=s.match(/^(\d{4})(\d{2})(\d{2})(?:T(\d{2})(\d{2})(\d{2})Z?)?$/);
      if(!m) return null;
      const [_,Y,Mo,D,H,Mi,S]=m;
      if(H) return new Date(Number(Y),Number(Mo)-1,Number(D),Number(H),Number(Mi),Number(S));
      return new Date(Number(Y),Number(Mo)-1,Number(D),0,0,0);
    };
    const ds=parseDT(dtstart), de=parseDT(dtend);
    if(ds) events.push({start:ds,end:de,summary,location,description});
  }
  return events.sort((a,b)=>a.start-b.start);
}

async function loadData(){
  const r=await fetch("/api/data"); const j=await r.json();
  if(!j.ok) throw new Error(j.error||"Ingen data");
  return j.content;
}

(async function start(){
  const DATA=await loadData();
  const brand=DATA?.brand || "Infoskærm";
  const cal=DATA?.calendar || {};
  const showTimes = Boolean(cal.showTimes ?? true);
  const style = cal.style || "boxes";          // "bullets" | "arrows" | "boxes"
  const url = cal.url || "";
  const ahead = Number(cal.daysAhead || 60);
  const max = Number(cal.maxEvents || 50);

  $("#brand").textContent=brand;
  $("#title").textContent="Kalender";
  $("#thTime").style.display=showTimes?"":"none";

  if(!url){
    $("#msg").textContent="Ingen ICS-URL sat – viser ingen events.";
    return;
  }

  let txt="";
  try{
    const r=await fetch(url,{cache:"no-store"});
    if(!r.ok) throw new Error("Kunne ikke hente ICS (CORS eller URL?)");
    txt=await r.text();
  }catch(e){
    $("#msg").textContent="Fejl ved hentning af ICS: "+(e.message||e);
    return;
  }

  const all=parseICS(txt);
  const now=new Date();
  const lim=new Date(); lim.setDate(now.getDate()+ahead);

  const rows=all.filter(ev=>ev.start>=now && ev.start<=lim).slice(0,max);
  $("#msg").textContent = rows.length ? `${rows.length} kommende event${rows.length>1?"s":""}` : "Ingen kommende events i perioden.";

  const tbody=$("#rows"); tbody.innerHTML="";
  for(const ev of rows){
    const tr=document.createElement("tr");
    const dateStr=fmtDate(ev.start);
    const timeStr=fmtTime(ev.start);

    // marker stil
    let titleClass="";
    if(style==="bullets") titleClass="bullet";
    else if(style==="arrows") titleClass="arrow";
    else if(style==="boxes") titleClass="box";

    tr.innerHTML=`
      <td>${dateStr}</td>
      <td style="${showTimes?"":"display:none"}">${timeStr}</td>
      <td class="${titleClass}">${(ev.summary||"").replace(/\\n/g," ")}</td>
      <td>${ev.location||""}</td>`;
    tbody.appendChild(tr);
  }
})();
</script>
</body>
</html>

