<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Kalender • Infoskærm</title>
<style>
  :root{ --bg:#0b6a74; --bg2:#0d4952; --ink:#e9fbff; --line:rgba(255,255,255,.12); --accent:#a7d0c9; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(160deg,var(--bg),var(--bg2));color:var(--ink);font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{min-height:100%;padding:24px;display:grid;place-items:center}
  .card{width:min(1200px,95vw);background:rgba(0,0,0,.08);border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:20px}
  h1{margin:0 0 14px;font-weight:800;letter-spacing:.03em}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--line);padding:10px 12px;text-align:left;vertical-align:top}
  th{opacity:.85;font-size:13px;letter-spacing:.08em;text-transform:uppercase}
  .muted{opacity:.8}
  .brand{margin-top:12px;opacity:.8;font-size:12px}

  /* Visningsstile */
  .events.bullets li::marker{content:"• "}
  .events.arrows li::marker{content:"→ "}
  .events{margin:0;padding-left:1.2em}
  .cards{display:grid;gap:10px}
  .cardItem{border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:rgba(0,0,0,.06)}
  .dateBadge{display:inline-block;background:rgba(255,255,255,.08);border:1px solid var(--line);padding:2px 8px;border-radius:999px;margin-right:8px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1 id="title">Kalender</h1>
    <div id="msg" class="muted" style="margin-bottom:8px"></div>

    <!-- Liste/bokse – skifter efter style -->
    <div id="listWrap"></div>

    <div class="brand" id="brand"></div>
  </div>
</div>

<script>
const $ = (q,el=document)=>el.querySelector(q);

function pad2(n){return String(n).padStart(2,"0")}
function fmtDate(d){return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${d.getFullYear()}`}
function fmtTime(d){return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`}
function parseICS(text){
  const events=[];
  const chunks = text.split(/BEGIN:VEVENT/gi).slice(1);
  for(const ch of chunks){
    const block = ch.split(/END:VEVENT/i)[0] || "";
    const pick = re => (block.match(re)||[])[1]?.trim() || "";
    const dtstart = pick(/DTSTART(?:;[^:\n]*)?:(.+)\r?\n/i);
    const dtend   = pick(/DTEND(?:;[^:\n]*)?:(.+)\r?\n/i);
    const summary = pick(/SUMMARY:(.+)\r?\n/i);
    const location= pick(/LOCATION:(.+)\r?\n/i);

    function parseDT(s){
      if(!s) return null;
      const m = s.match(/^(\d{4})(\d{2})(\d{2})(?:T(\d{2})(\d{2})(\d{2})Z?)?$/);
      if(!m) return null;
      const [_,Y,Mo,D,H,Mi,S]=m;
      return H ? new Date(+Y,Mo-1,D,+H,+Mi,+S) : new Date(+Y,Mo-1,D,0,0,0);
    }
    const ds = parseDT(dtstart), de = parseDT(dtend);
    if(ds) events.push({start:ds, end:de, summary, location});
  }
  return events.sort((a,b)=>a.start-b.start);
}

async function loadData(){
  const r=await fetch("/api/data"); const j=await r.json();
  if(!j.ok) throw new Error(j.error||"Ingen data");
  return j.content;
}

(async function start(){
  const DATA = await loadData();
  const brand = DATA?.brand || "Infoskærm";
  const showTimes = (DATA?.calendar?.showTimes ?? true);
  const style = DATA?.calendar?.style || "bullets"; // bullets | arrows | boxes
  const url = DATA?.calendar?.url || "";
  const ahead = Number(DATA?.calendar?.daysAhead || 60);
  const max = Number(DATA?.calendar?.maxEvents || 50);

  $("#brand").textContent = brand;
  $("#title").textContent = "Kalender";

  if(!url){
    $("#msg").textContent = "Ingen ICS-URL sat – viser ingen events.";
    return;
  }

  let txt="";
  try{
    const r=await fetch(url);
    if(!r.ok) throw new Error("Kunne ikke hente ICS (CORS eller URL?)");
    txt = await r.text();
  }catch(e){
    $("#msg").textContent = "Fejl ved hentning af ICS: " + (e.message||e);
    return;
  }

  const all = parseICS(txt);
  const now = new Date();
  const lim = new Date(); lim.setDate(now.getDate()+ahead);

  const rows = all.filter(ev => ev.start >= now && ev.start <= lim).slice(0, max);
  $("#msg").textContent = rows.length ? `${rows.length} kommende event${rows.length>1?"s":""}` : "Ingen kommende events i perioden.";

  const wrap = $("#listWrap"); wrap.innerHTML="";
  if(style==="boxes"){
    const grid=document.createElement("div"); grid.className="cards";
    rows.forEach(ev=>{
      const item=document.createElement("div"); item.className="cardItem";
      item.innerHTML = `
        <div class="dateBadge">${fmtDate(ev.start)}${showTimes?` • ${fmtTime(ev.start)}`:""}</div>
        <div style="margin-top:6px;font-weight:600">${(ev.summary||"").replace(/\\n/g," ")}</div>
        ${ev.location?`<div class="muted" style="margin-top:4px">${ev.location}</div>`:""}
      `;
      grid.appendChild(item);
    });
    wrap.appendChild(grid);
  } else {
    const ul=document.createElement("ul"); ul.className=`events ${style}`;
    rows.forEach(ev=>{
      const li=document.createElement("li");
      li.innerHTML = `
        <strong>${fmtDate(ev.start)}</strong>${showTimes?` — ${fmtTime(ev.start)}`:""}:
        ${(ev.summary||"").replace(/\\n/g," ")}
        ${ev.location?`<span class="muted"> • ${ev.location}</span>`:""}
      `;
      ul.appendChild(li);
    });
    wrap.appendChild(ul);
  }
})();
</script>
</body>
</html>

