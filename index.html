<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Infosk√¶rm</title>
<style>
  :root{--bg:#0b1220;--card:#0e1526;--text:#e8eefb;--muted:#203258;--accent:#5aa2ff}
  html,body{margin:0;height:100%;background:linear-gradient(180deg,#0b1220,#0a1120);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
  .stage{position:relative;display:flex;align-items:center;justify-content:center;height:100%;padding:40px}
  .card{width:100%;height:100%;border-radius:22px;background:radial-gradient(1200px 800px at 70% 30%,#12203a 0%,#0e1526 60%);box-shadow:0 6px 30px rgba(0,0,0,.6);padding:34px;overflow:hidden}
  h1,h2,h3{margin:0 0 10px}
  .bullets ul{font-size:40px;list-style:disc;padding-left:28px;line-height:1.4}
  .imgwrap{display:flex;align-items:center;justify-content:center;height:100%}
  .imgwrap img{max-width:100%;max-height:100%;object-fit:contain;border-radius:12px}
  table{width:100%;border-collapse:collapse;font-size:22px;margin-top:10px}
  th,td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.1)}
  th{opacity:.85;text-align:left}
  .footer{position:absolute;left:24px;right:24px;bottom:14px;display:flex;justify-content:space-between;opacity:.8;font-size:14px}
  .logo{position:absolute;max-width:180px;max-height:120px;opacity:.9}
  .top-right{top:16px;right:16px}.top-left{top:16px;left:16px}.bottom-right{bottom:60px;right:16px}.bottom-left{bottom:60px;left:16px}
  .center{display:flex;align-items:center;justify-content:center;height:100%}
  .big{font-size:72px;font-weight:800;text-align:center}
  .muted{opacity:.7}
</style>
</head>
<body>
<div class="stage">
  <div class="card" id="root">
    <div class="center"><div class="big muted">Indl√¶ser‚Ä¶</div></div>
  </div>
</div>
<script>
  const qs = new URLSearchParams(location.search);
  const DATA = qs.get('data') || 'https://perbonde07-byte.github.io/Infoskaerm/data.json';

  const root = document.getElementById('root');
  let cfg = null, idx = -1, timer = null;

  const fmtDa = d => d.toLocaleDateString('da-DK',{day:'2-digit',month:'2-digit',year:'numeric'});
  const escapeHtml = s => (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

  function logoHtml(){
    if(!cfg.logoUrl) return '';
    const pos = cfg.logoPos || 'top-right';
    return `<img class="logo ${pos}" src="${escapeHtml(cfg.logoUrl)}" alt="logo"/>`;
    }

  function slideBullets(s){
    const lines = (s.lines||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join('');
    root.innerHTML = `
      ${logoHtml()}
      <h1>${escapeHtml(s.title||'')}</h1>
      <div class="bullets"><ul>${lines}</ul></div>
      <div class="footer"><span>${escapeHtml(cfg.brand||'')}</span><span>${fmtDa(new Date())}</span></div>`;
  }

  function slideImage(s){
    let src = s.image||'';
    if(src && !/^https?:\/\//i.test(src) && cfg.media?.baseUrl){
      src = cfg.media.baseUrl.replace(/\/+$/,'')+'/'+src.replace(/^\/+/,'');
    }
    root.innerHTML = `
      ${logoHtml()}
      <div class="imgwrap"><img src="${escapeHtml(src)}" alt=""/></div>
      <div class="footer"><span>${escapeHtml(cfg.brand||'')}</span><span>${fmtDa(new Date())}</span></div>`;
  }

  function slideEmpties(s){
    const e = cfg.settings?.empties || {weekdays:[],skip:[],names:[]};
    const out = [];
    if(!e.weekdays?.length || !e.names?.length){
      root.innerHTML = `${logoHtml()}<div class="center"><div class="big muted">T√∏mningstabel mangler ops√¶tning</div></div>`; return;
    }
    const today = new Date(); today.setHours(0,0,0,0);
    let i=0, nameIdx = 0;
    const skipSet = new Set((e.skip||[]));
    // find startnavn baseret p√• uge (simpel rotation)
    const baseWeek = Math.floor((today - new Date('2025-01-01'))/(7*864e5));
    nameIdx = ((baseWeek% e.names.length)+e.names.length)%e.names.length;

    for(let d=0; out.length<10; d++){
      const dt = new Date(today); dt.setDate(dt.getDate()+d);
      const wd = ['sun','mon','tue','wed','thu','fri','sat'][dt.getDay()];
      const iso = dt.toISOString().slice(0,10);
      if(e.weekdays.includes(wd) && !skipSet.has(iso)){
        out.push({date: dt, name: e.names[nameIdx]});
        nameIdx = (nameIdx+1)%e.names.length;
      }
    }
    const rows = out.map(r=>`<tr><td>${escapeHtml(r.name)}</td><td>${fmtDa(r.date)}</td></tr>`).join('');
    root.innerHTML = `
      ${logoHtml()}
      <h1>${escapeHtml(s.title||'T√∏mning')}</h1>
      <table><thead><tr><th>Navn</th><th>Dato</th></tr></thead><tbody>${rows}</tbody></table>
      <div class="footer"><span>${escapeHtml(cfg.brand||'')}</span><span>${fmtDa(new Date())}</span></div>`;
  }

  function slideBirthday(s){
    const list = (cfg.settings?.birthdays||[]).filter(b=>{
      const d = new Date(new Date().getFullYear()+'-'+b.date.slice(5));
      const now = new Date(); const start = new Date(now); start.setDate(now.getDate()-now.getDay()+1); start.setHours(0,0,0,0);
      const end = new Date(start); end.setDate(start.getDate()+6);
      return d>=start && d<=end;
    });
    if(!list.length){
      root.innerHTML = `${logoHtml()}<div class="center"><div class="big">Ingen f√∏dselsdage i denne uge üéâ</div></div>
        <div class="footer"><span>${escapeHtml(cfg.brand||'')}</span><span>${fmtDa(new Date())}</span></div>`;
      return;
    }
    const rows = list.map(b=>{
      const when = new Date(new Date().getFullYear()+'-'+b.date.slice(5));
      let img = b.photo||'';
      if(img && !/^https?:\/\//i.test(img) && cfg.media?.baseUrl){
        img = cfg.media.baseUrl.replace(/\/+$/,'')+'/'+img.replace(/^\/+/,'');
      }
      return `<tr><td>${escapeHtml(b.name)}</td><td>${fmtDa(when)}</td><td>${img?`<img src="${escapeHtml(img)}" style="height:64px;border-radius:8px">`:''}</td></tr>`;
    }).join('');
    root.innerHTML = `
      ${logoHtml()}
      <h1>${escapeHtml(s.title||'Tillykke!')}</h1>
      <table><thead><tr><th>Navn</th><th>Dato</th><th>Foto</th></tr></thead><tbody>${rows}</tbody></table>
      <div class="footer"><span>${escapeHtml(cfg.brand||'')}</span><span>${fmtDa(new Date())}</span></div>`;
  }

  function show(i){
    const slides = cfg.slides||[]; if(!slides.length){ root.innerHTML = `<div class="center"><div class="big muted">Ingen slides<br><br><span style="font-size:20px">Tilf√∏j i admin</span></div></div>`; return; }
    const s = slides[i]; const dur = Math.max(3, +s.duration || 12);
    if(s.type==='image') slideImage(s);
    else if(s.type==='empties') slideEmpties(s);
    else if(s.type==='birthday') slideBirthday(s);
    else slideBullets(s);
    clearTimeout(timer); timer = setTimeout(next, dur*1000);
  }
  function next(){ idx = (idx+1) % (cfg.slides?.length||1); show(idx); }

  async function boot(){
    try{
      const r = await fetch(DATA+'?v='+Date.now()); cfg = await r.json();
    }catch{ cfg = { brand:'Bredsgaard ‚Ä¢ Infosk√¶rm', slides:[] }; }
    document.title = (cfg.brand||'Infosk√¶rm');
    idx = -1; next();
    // auto-refresh hver 5. minut
    setInterval(async()=>{
      try{ const r = await fetch(DATA+'?v='+Date.now()); const fresh = await r.json(); cfg = fresh; }catch{}
    }, 5*60*1000);
  }
  boot();
</script>
</body>
</html>
