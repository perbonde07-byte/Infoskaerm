<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Infoskærm</title>
  <style>
    :root{--bg:#0b1220;--panel:#0f172a;--text:#e8eefb;--muted:#243147;--accent:#5aa2ff}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
    #root{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:32px}
    .card{width:100%;height:100%;background:linear-gradient(180deg,#0f172a 0%,#0b1220 100%);border-radius:18px;padding:28px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
    .logo{position:absolute;max-width:260px;max-height:90px;opacity:.95}
    .tr{top:22px;right:26px}.tl{top:22px;left:26px}.br{bottom:22px;right:26px}.bl{bottom:22px;left:26px}
    .title{font-size:44px;font-weight:800;margin:0 0 10px}
    .list{font-size:28px;line-height:1.45;margin:14px 0 0}
    .footer{position:absolute;left:26px;bottom:10px;font-size:12px;opacity:.65}
    .img{display:block;max-width:100%;max-height:68vh;margin:0 auto;border-radius:12px}
    table{width:70%;border-collapse:collapse;font-size:22px}
    td,th{border-bottom:1px solid var(--muted);padding:10px 12px;text-align:left}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:start}
    .muted{opacity:.8}
    .center{display:flex;align-items:center;justify-content:center}
  </style>
</head>
<body>
  <div id="root"><div class="card" id="card">
    <div id="logo"></div>
    <div id="content"></div>
    <div class="footer" id="footer"></div>
  </div></div>

  <script>
    const QS = s => document.querySelector(s);
    const content = QS('#content'), footer = QS('#footer'), logoBox = QS('#logo');

    const urlParam = new URLSearchParams(location.search).get('data');
    const DATA_URL = urlParam || 'https://perbonde07-byte.github.io/Infoskaerm/data.json';

    let DATA = null, idx = -1, timer = null;

    function setLogo(url,pos){
      logoBox.innerHTML = '';
      if(!url) return;
      const img = new Image();
      img.src = url; img.className = 'logo ' + (pos==='top-left'?'tl':pos==='bottom-right'?'br':pos==='bottom-left'?'bl':'tr');
      logoBox.appendChild(img);
    }
    function setFooter(brand){
      footer.textContent = brand ? brand : 'Infoskærm';
    }
    function fmtDa(iso){
      const d = new Date(iso);
      if(Number.isNaN(d.getTime())) return iso;
      return d.toLocaleDateString('da-DK',{day:'2-digit',month:'2-digit',year:'numeric'});
    }
    function withinWeek(d){
      const date = new Date(d); if(Number.isNaN(date)) return false;
      const now = new Date(); const monday = new Date(now); const sunday = new Date(now);
      const day = (now.getDay()+6)%7; // Mon=0
      monday.setDate(now.getDate()-day); monday.setHours(0,0,0,0);
      sunday.setDate(monday.getDate()+6); sunday.setHours(23,59,59,999);
      return date>=monday && date<=sunday;
    }

    function renderSlide(s){
      content.innerHTML = '';
      const wrap = document.createElement('div');

      if(s.type==='bullets'){
        wrap.innerHTML = `<h1 class="title">${s.title||''}</h1>`;
        const ul = document.createElement('ul'); ul.className='list';
        (s.lines||[]).forEach(line=>{
          const li = document.createElement('li'); li.textContent = line; ul.appendChild(li);
        });
        wrap.appendChild(ul);
      }
      else if(s.type==='image'){
        wrap.innerHTML = `<h1 class="title">${s.title||''}</h1>`;
        const img = new Image(); img.src = s.image; img.className='img'; wrap.appendChild(img);
      }
      else if(s.type==='empties'){
        wrap.innerHTML = `<h1 class="title">${s.title||'Tømning'}</h1>`;
        const grid = document.createElement('div'); grid.className='grid';
        const table = document.createElement('table');
        table.innerHTML = `<thead><tr><th class="muted">Navn</th><th class="muted">Dato</th></tr></thead>`;
        const tb = document.createElement('tbody');

        const names = DATA?.settings?.empties?.names||[];
        const weekdays = DATA?.settings?.empties?.weekdays||[];
        const skip = new Set((DATA?.settings?.empties?.skip||[]));

        // næste ~10 forekomster på angivne ugedage
        const out = [];
        const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
        const mapWD = {mon:1,tue:2,wed:3,thu:4,fri:5};
        let day = new Date(); day.setHours(0,0,0,0);
        for(let i=0; out.length<10 && i<200; i++){
          const d = addDays(day,i);
          const wd = d.getDay(); // 1..5
          const key = ['sun','mon','tue','wed','thu','fri','sat'][wd];
          if(weekdays.includes(key) && !skip.has(d.toISOString().slice(0,10))){
            out.push(new Date(d));
          }
        }
        out.forEach((d,i)=>{
          const tr = document.createElement('tr');
          const who = names[i % Math.max(1,names.length)] || '-';
          tr.innerHTML = `<td>${who}</td><td>${fmtDa(d.toISOString())}</td>`;
          tb.appendChild(tr);
        });
        table.appendChild(tb); grid.appendChild(table);
        wrap.appendChild(grid);
      }
      else if(s.type==='birthday'){
        wrap.innerHTML = `<h1 class="title">${s.title||'Fødselsdage'}</h1>`;
        const box = document.createElement('div'); box.className='list';
        const list = (DATA?.settings?.birthdays||[]).filter(b=>withinWeek(b.date));
        if(!list.length){
          box.innerHTML = `<div class="muted">Ingen fødselsdage i denne uge.</div>`;
        }else{
          list.forEach(b=>{
            const row = document.createElement('div');
            row.innerHTML = `<strong>${b.name}</strong> – ${fmtDa(b.date)}`;
            box.appendChild(row);
          });
        }
        wrap.appendChild(box);
      }
      else {
        wrap.innerHTML = `<h1 class="title">Ingen slides</h1><div class="list"><li>Tilføj slides i admin.</li></div>`;
      }

      content.appendChild(wrap);
    }

    function tick(){
      if(!DATA?.slides?.length){
        renderSlide({type:'none'});
        setLogo(DATA?.logoUrl, DATA?.logoPos);
        setFooter(DATA?.brand || 'Bredsgaard • Infoskaerm');
        return setTimeout(tick, 5000);
      }
      idx = (idx+1) % DATA.slides.length;
      const s = DATA.slides[idx];

      setLogo(DATA?.logoUrl, DATA?.logoPos);
      setFooter(DATA?.brand || 'Bredsgaard • Infoskaerm');
      renderSlide(s);

      clearTimeout(timer);
      const dur = Math.max(3, +s.duration || 12);
      timer = setTimeout(tick, dur*1000);
    }

    async function boot(){
      try{
        const r = await fetch(DATA_URL + '?v=' + Date.now());
        DATA = await r.json();
      }catch(e){
        DATA = {brand:'Bredsgaard • Infoskaerm', slides:[]};
      }
      tick();
      setInterval(async ()=>{
        try{
          const r2 = await fetch(DATA_URL + '?v=' + Date.now());
          const fresh = await r2.json();
          DATA = fresh;
        }catch{}
      }, 60000);
    }
    boot();
  </script>
</body>
</html>
