<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Infoskærm</title>
<style>
  /* PB-DESIGN: tema */
  :root{ --bg:#0d4952; --panel:#083d43; --accent:#a7d0c9; --ink:#e9fbff; --cardR:24px; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:20px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .outer{min-height:100vh;padding:28px}
  .frame{min-height:calc(100vh - 56px);border-radius:26px;border:1px solid #0a2b30;box-shadow:inset 0 0 0 2px #0a2b3040; padding:26px; display:flex;flex-direction:column}
  .slide{flex:1;display:flex;align-items:center;justify-content:center}
  .brand{position:fixed;left:20px;bottom:10px;opacity:.85;font-size:16px}
  h1{margin:0 0 16px;font-size:56px;letter-spacing:.03em}
  /* PB-DESIGN: affaldstabel */
  .grid{width:100%;display:grid;gap:16px}
  .t{width:100%;border-collapse:collapse}
  .t th,.t td{padding:16px 18px;border-bottom:1px solid #0a2b30}
  .t th{color:#bfe3e8;letter-spacing:.12em;font-size:22px}
  .rowHL{background:#5a6a60aa;border-radius:14px}
  .two{grid-template-columns:1fr 1fr}
  .one{grid-template-columns:1fr}
  .imgwrap{display:flex;align-items:center;justify-content:center}
  .imgwrap img{max-width:90%;max-height:74vh;border-radius:18px;box-shadow:0 6px 40px #0006}
</style>
</head>
<body>
<div class="outer">
  <div class="frame">
    <div id="slide" class="slide"></div>
    <div class="brand" id="brand">• Infoskærm</div>
  </div>
</div>

<script>
const $ = q => document.querySelector(q);

function applyTheme(cfg){
  const theme = (cfg && cfg.theme) || {};
  if (theme.bg1) document.documentElement.style.setProperty("--bg", theme.bg1);
  if (theme.bg2) document.documentElement.style.setProperty("--panel", theme.bg2);
  if (theme.accent) document.documentElement.style.setProperty("--accent", theme.accent);
  if (cfg && cfg.brand) $("#brand").textContent = cfg.brand;
}

// PB-DESIGN: hjælpere
const pad2 = n => String(n).padStart(2,"0");
const fmt = d => `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${d.getFullYear()}`;
const sameDay = (a,b)=>a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate();

// generér affaldstømning
function* genWorkdays(start, weekdays, skipSet){
  // weekdays: [1..5] -> Mon..Fri (Date.getDay: 0=Sun..6=Sat)
  // map til js-dage
  const map = new Set(weekdays.map(n=> (n%7) ));
  let d = new Date(start.getTime());
  // backtrack til i dag hvis start i fortiden
  while (true){
    const wd = d.getDay(); // 0-6
    const isWanted = map.has(wd);
    const key = fmt(d);
    if (isWanted && !skipSet.has(key)) yield new Date(d.getTime());
    d.setDate(d.getDate()+1);
  }
}

function buildEmpties(cfg){
  const e = cfg.empties || {};
  const names = (e.names||[]).filter(Boolean);
  if (!names.length) return `<div>Ingen navne angivet.</div>`;

  const start = e.startDate ? new Date(e.startDate) : new Date();
  const weekdays = (e.weekdays && e.weekdays.length) ? e.weekdays : [1];
  const skipSet = new Set((e.skipDates||[]).map(x=>x.trim()).filter(Boolean));
  const horizon = Math.max(1, Number(e.horizon||8));
  const cols = Math.max(1, Math.min(2, Number(e.columns||2)));

  // find næste relevante datoer og tilknyt navne i rotation
  const today = new Date(); today.setHours(0,0,0,0);
  const iter = genWorkdays(start, weekdays, skipSet);
  const rows = [];
  let i=0, got=0;
  while (got < horizon + 20) { // sikkerhedsbuffer
    const d = iter.next().value;
    if (!d) break;
    // kun fremtid fra i dag
    if (d < today) { i++; continue; }
    rows.push({ name: names[i % names.length], date: d });
    i++; got++;
    if (rows.length >= horizon*cols) break;
  }

  // split i kolonner
  const perCol = Math.ceil(rows.length / cols);
  const colsArr = [];
  for (let c=0;c<cols;c++) colsArr.push(rows.slice(c*perCol,(c+1)*perCol));

  // find highlight (første dato >= i dag)
  const hlIndex = rows.findIndex(r => r.date >= today);
  const HL = hlIndex < 0 ? null : rows[hlIndex];

  const th = `<tr><th>NAVN</th><th>DATO</th></tr>`;
  const table = list=> list.map(r=>{
    const isHL = HL && sameDay(r.date, HL.date) && r.name===HL.name;
    return `<tr class="${isHL?'rowHL':''}"><td><b>${r.name}</b></td><td><b>${fmt(r.date)}</b></td></tr>`;
  }).join("");

  const gridCls = cols===2 ? "two" : "one";
  return `
    <div>
      <h1>TØMNINGS DAGE</h1>
      <div class="grid ${gridCls}">
        ${colsArr.map(col=>`<table class="t">${th}${table(col)}</table>`).join("")}
      </div>
    </div>`;
}

function birthdaySlide(cfg){
  const msg = (cfg.birthdays?.message)||"";
  const people = (cfg.birthdays?.people)||[];
  const today = new Date(); today.setHours(0,0,0,0);

  // find hvis nogen har fødselsdag i dag (eller denne uge? -> vælg i dag for slide)
  const match = people.find(p=>{
    const [dd,mm,yyyy] = (p.date||"").split(".").map(x=>x.trim());
    if (!dd || !mm) return false;
    return (Number(dd)===today.getDate() && Number(mm)===today.getMonth()+1);
  });

  if (!match) return `<div class="imgwrap"><div><h1>FØDSELSDAG</h1><div>Ingen i dag.</div></div></div>`;

  // udregn alder hvis år kendt
  let ageTxt = "";
  const parts = (match.date||"").split(".");
  if (parts.length===3 && /^\d{4}$/.test(parts[2])) {
    const born = new Date(Number(parts[2]), Number(parts[1])-1, Number(parts[0]));
    const age = new Date().getFullYear() - born.getFullYear();
    ageTxt = ` (${age} år)`;
  }
  const showDate = (()=>{
    const d = new Date(); const dd=pad2(d.getDate()), mm=pad2(d.getMonth()+1);
    const year = parts.length===3 ? parts[2] : "";
    return year ? `${dd}.${mm}.${year}` : `${dd}.${mm}`;
  })();

  const img = (match.image||"").trim();
  return `
    <div style="text-align:center">
      <h1>FØDSELSDAG</h1>
      <div class="imgwrap" style="margin-bottom:12px">
        ${img ? `<img src="${img}" alt="" style="max-height:38vh">` : ``}
      </div>
      <div style="font-size:48px;font-weight:800;margin-bottom:12px">${match.name}${ageTxt}</div>
      <div style="font-size:28px">${msg ? `${msg} (${showDate})` : showDate}</div>
    </div>`;
}

function imageSlide(obj){
  const src = obj.image || "";
  const caption = obj.title || "";
  return `<div class="imgwrap"><figure style="margin:0;text-align:center">
    <img src="${src}" alt="">
    ${caption?`<figcaption style="margin-top:12px;opacity:.9">${caption}</figcaption>`:""}
  </figure></div>`;
}

function textSlide(obj){
  return `<div style="max-width:68ch"><h1>${obj.title||""}</h1><div style="font-size:28px;opacity:.95">${(obj.text||"").replace(/\n/g,"<br>")}</div></div>`;
}

function renderSlide(cfg, s){
  if (!s) return "";
  if (s.type==="empties") return buildEmpties(cfg);
  if (s.type==="birthday") return birthdaySlide(cfg);
  if (s.type==="image") return imageSlide(s);
  if (s.type==="text") return textSlide(s);
  return `<div>Ukendt slide-type.</div>`;
}

(async function init(){
  const r = await fetch("/api/data");
  const j = await r.json();
  const DATA = (j && j.ok && j.content) ? j.content : {};
  applyTheme(DATA);

  // PB-DESIGN: autorefresh
  const refreshMs = Number((DATA.settings && DATA.settings.refreshMs) || 300000);
  setTimeout(()=>location.reload(), Math.max(60000, refreshMs));

  // kør slides (eller fallback til empties)
  const slides = (DATA.slides && DATA.slides.length) ? DATA.slides : [{type:"empties"}];
  let i = 0;
  const show = ()=>{
    const s = slides[i % slides.length];
    $("#slide").innerHTML = renderSlide(DATA, s);
    const dur = Math.max(6, Number(s.duration || 12));
    i++; setTimeout(show, dur*1000);
  };
  show();
})();
</script>
</body>
</html>

