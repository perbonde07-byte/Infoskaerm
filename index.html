<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Infosk√¶rm</title>
<style>
  :root{
    --bg:#0b1220;--panel:#111a2d;--muted:#9fb0cb;--text:#e8eefb;--line:#243147;--accent:#5aa2ff;
  }
  html,body{height:100%;background:radial-gradient(1200px 800px at 60% 40%,#16314d 0%,#0b1220 60%);color:var(--text);margin:0;font-family:system-ui,Segoe UI,Roboto,Arial}
  .stage{position:relative;height:100%;display:flex;align-items:center;justify-content:center;padding:28px}
  .frame{width:100%;height:100%;border:1px solid #1b2740;border-radius:18px;background:rgba(17,26,45,.35);backdrop-filter: blur(2px);padding:28px;box-sizing:border-box}
  .logo{position:absolute;max-height:64px;max-width:300px;opacity:.9;filter:drop-shadow(0 2px 3px rgba(0,0,0,.4))}
  .tl{top:24px;left:24px}.tr{top:24px;right:24px}.bl{bottom:24px;left:24px}.br{bottom:24px;right:24px}
  h1{font-size:44px;margin:0 0 18px}
  ul{margin:0;padding:0 0 0 20px}
  .muted{color:var(--muted)}
  .footer{position:absolute;left:28px;right:28px;bottom:18px;font-size:12px;color:#b9c7e0;opacity:.85;display:flex;justify-content:space-between}
  .panel{background:rgba(8,12,24,.55);border:1px solid var(--line);border-radius:16px;padding:22px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
  table{border-collapse:collapse;width:100%}
  th,td{border-bottom:1px solid #1e2a42;padding:10px 12px;text-align:left}
  th{color:#b9c7e0;font-weight:600;letter-spacing:.02em}
  .green{background:#1f3a21;border:1px solid #2f5d32;border-radius:8px;padding:6px 10px;display:inline-block}
</style>
</head>
<body>
<div class="stage">
  <div class="frame panel" id="content">
    <!-- indhold kommer her -->
  </div>
  <img id="logo" class="logo tr" alt="">
  <div class="footer"><span id="brand"></span><span class="muted" id="clock"></span></div>
</div>

<script>
  // ========== Konfiguration ==========
  const DATA_URL = "https://perbonde07-byte.github.io/Infoskaerm/data.json";

  // ========== Utils ==========
  const $ = s => document.querySelector(s);
  const sleep = ms => new Promise(r=>setTimeout(r,ms));

  function fmtDa(iso){
    if(!iso) return '';
    const d = new Date(iso);
    if(Number.isNaN(d.getTime())) return iso;
    return d.toLocaleDateString('da-DK',{day:'2-digit',month:'2-digit',year:'numeric'});
  }
  const weekdayDa = ['s√∏n','man','tir','ons','tor','fre','l√∏r'];

  // uge-Mandag kl 00 ‚Üí S√∏ndag 23:59
  function weekSpan(d=new Date()){
    const x = new Date(d); // find mandag
    const day = (x.getDay()+6)%7; // 0=man .. 6=s√∏n
    x.setDate(x.getDate()-day); x.setHours(0,0,0,0);
    const start = new Date(x);
    const end = new Date(x); end.setDate(end.getDate()+6); end.setHours(23,59,59,999);
    return {start,end};
  }

  // n√¶ste t√∏mmedage ‚Üí rotation
  function buildEmptiesTable(settings){
    const {weekdays=[], skip=[], names=[]} = settings?.empties || {};
    if(!weekdays.length || !names.length) return {rows:[], highlight:-1};

    // find n√¶ste ~9 uger, skab liste af datoer for valgte weekdays, spring over "skip"
    const rows=[]; const now=new Date(); let highlight=-1;
    const map = {mon:1,tue:2,wed:3,thu:4,fri:5};
    const wanted = new Set(weekdays.map(w=>map[w]).filter(Boolean));

    // start fra denne uge
    let d = new Date(now); d.setHours(12,0,0,0);
    // rul tilbage til mandag
    const back = (d.getDay()+6)%7; d.setDate(d.getDate()-back);

    const skipSet = new Set(skip||[]);
    let personIdx = 0;

    for(let week=0; rows.length<9 && week<20; week++){
      for(let dow=1; dow<=5; dow++){
        const day = new Date(d); day.setDate(d.getDate() + week*7 + (dow-1));
        const iso = day.toISOString().slice(0,10);
        if(!wanted.has(dow)) continue;
        if(skipSet.has(iso)) continue;

        rows.push({ date: iso, name: names[personIdx%names.length] });
        // highlight f√∏rste kommende
        if(highlight<0 && day >= new Date(now.toDateString())) highlight = rows.length-1;
        personIdx++;
        if(rows.length>=10) break;
      }
    }
    return {rows, highlight};
  }

  // ========== Rendering ==========
  function renderLogo(d){
    const el = $('#logo');
    const url = d.logo?.url || '';
    el.src = url || '';
    el.style.display = url ? 'block' : 'none';
    el.className = 'logo ' + (
      d.logo?.pos==='top-left' ? 'tl' :
      d.logo?.pos==='bottom-left' ? 'bl' :
      d.logo?.pos==='bottom-right' ? 'br' : 'tr'
    );
  }

  function viewBullets(slide){
    return `
      <h1>${slide.title||''}</h1>
      <ul class="muted">${(slide.lines||[]).map(li=>`<li style="margin:8px 0;font-size:22px;color:#dce6f7">${li}</li>`).join('')}</ul>
    `;
  }

  function viewImage(slide){
    return `
      <h1>${slide.title||''}</h1>
      <div style="display:flex;align-items:center;justify-content:center;height:calc(100% - 80px)">
        ${slide.image ? `<img src="${slide.image}" alt="" style="max-width:100%;max-height:100%;border-radius:8px;box-shadow:0 10px 24px rgba(0,0,0,.35)">`
                       : `<div class="muted">Ingen billede-URL</div>`}
      </div>
    `;
  }

  function viewEmpties(d){
    const {rows,highlight} = buildEmptiesTable(d.settings);
    if(!rows.length) return `<h1>T√∏mning</h1><div class="muted">Konfigur√©r ugedage og navne i admin.</div>`;
    return `
      <h1>T√òMNINGS DAGE</h1>
      <table>
        <thead><tr><th>Navn</th><th>Dato</th></tr></thead>
        <tbody>
          ${rows.map((r,i)=>`
            <tr style="${i===highlight?'background:#142f18':''}">
              <td>${i===highlight?`<span class="green">${r.name}</span>`:r.name}</td>
              <td>${fmtDa(r.date)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }

  function viewBirthday(d){
    const list = d.settings?.birthdays||[];
    if(!list.length) return `<h1>F√∏dselsdage</h1><div class="muted">Tilf√∏j personer i admin.</div>`;
    const {start,end} = weekSpan();
    const weekItems = list.filter(b=>{
      const thisYear = new Date(`${new Date().getFullYear()}-${b.date.slice(5)}`);
      // h√•ndter 29/02: hvis ikke skud√•r ‚Üí flyt til 28/02
      if(isNaN(thisYear.getTime())) return false;
      return thisYear>=start && thisYear<=end;
    });
    if(!weekItems.length) return `<h1>F√∏dselsdage</h1><div class="muted">Ingen f√∏dselsdage i denne uge.</div>`;
    const it = weekItems[0];
    return `
      <h1 style="margin-bottom:6px">Tillykke med f√∏dselsdagen</h1>
      <div class="muted" style="margin-bottom:18px">${fmtDa(new Date().getFullYear()+'-'+it.date.slice(5))}</div>
      <div style="display:flex;align-items:center;gap:24px">
        ${it.photo ? `<img src="${it.photo}" alt="" style="width:280px;height:280px;object-fit:cover;border-radius:50%;box-shadow:0 10px 24px rgba(0,0,0,.35)">`
                    : `<div style="width:280px;height:280px;border-radius:50%;background:#16243c;display:flex;align-items:center;justify-content:center;font-size:62px;letter-spacing:.1em">${(it.name||'?').slice(0,1).toUpperCase()}</div>`}
        <div>
          <div style="font-size:56px;font-weight:800">${it.name||''}</div>
          <div class="muted" style="margin-top:10px;font-size:22px">Vi h√•ber du f√•r en rigtig god uge üéâ</div>
        </div>
      </div>
    `;
  }

  async function run(){
    try{
      const res = await fetch(DATA_URL + '?v='+Date.now());
      const data = await res.json();

      $('#brand').textContent = data.brand || 'Bredsgaard ‚Ä¢ Infoskaerm';
      renderLogo(data);

      const slides = data.slides || [];
      if(!slides.length){
        $('#content').innerHTML = `<h1>Ingen slides</h1><ul><li>Tilf√∏j slides i admin.</li></ul>`;
        return;
      }

      // loop
      while(true){
        for(const s of slides){
          let html='';
          if(s.type==='bullets') html = viewBullets(s);
          else if(s.type==='image') html = viewImage(s);
          else if(s.type==='empties') html = viewEmpties(data);
          else if(s.type==='birthday') html = viewBirthday(data);
          else html = `<h1>${s.title||''}</h1>`;

          $('#content').innerHTML = html;
          await sleep((s.duration||12)*1000);
        }
      }
    }catch(err){
      $('#content').innerHTML = `<h1>Fejl</h1><div class="muted">${err.message}</div>`;
    }
  }

  // clock
  setInterval(()=>{
    const n = new Date();
    $('#clock').textContent = n.toLocaleString('da-DK',{weekday:'long', day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'});
  }, 1000);

  run();
</script>
</body>
</html>
