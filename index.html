<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Infosk√¶rm ‚Ä¢ Bredsgaard</title>
<style>
  :root{
    --bg:#0c1a22; --fg:#e8eefb; --muted:#9fb2c7; --accent:#5aa2ff;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);
    font-family:system-ui, Segoe UI, Roboto, Arial}
  .screen{position:relative; display:flex; align-items:center; justify-content:center;
    height:100%; overflow:hidden}
  .slide{width:100%; height:100%; display:flex; align-items:center; justify-content:center;
    padding:48px; box-sizing:border-box}
  .wrap{max-width:1400px; width:100%}
  h1{font-size:72px; line-height:1.05; margin:0 0 24px}
  p, li {font-size:36px; line-height:1.3}
  ul{margin:0; padding-left:28px}

  /* image slide */
  .image-holder{
    position:relative; width:100%; height:72vh; border-radius:20px; overflow:hidden;
    box-shadow:0 10px 50px rgba(0,0,0,.45);
    background:#0b1620 center/cover no-repeat;
  }

  /* logo overlay */
  .logo{
    position:absolute; z-index:5; opacity:var(--logoOpacity, .95);
    width:var(--logoSize, 140px); height:auto; pointer-events:none;
    filter:drop-shadow(0 6px 18px rgba(0,0,0,.5));
  }
  .top-left{top:24px; left:24px}
  .top-right{top:24px; right:24px}
  .bottom-left{bottom:24px; left:24px}
  .bottom-right{bottom:24px; right:24px}

  /* schedule table */
  table{width:100%; border-collapse:collapse; font-size:28px; background:#0f2230;
    border-radius:16px; overflow:hidden}
  th,td{border-bottom:1px solid #1d3342; padding:14px 18px}
  th{background:#123041; font-weight:700; text-transform:uppercase; letter-spacing:.02em}
  tr.highlight{background:#18394d; color:#fff}
  .two-cols{display:grid; grid-template-columns:1fr 1fr; gap:24px; align-items:start}
  .right-image{
    width:100%; max-width:520px; justify-self:end; border-radius:16px; overflow:hidden;
    aspect-ratio:1.1/1; background:#0b1620 center/cover no-repeat
  }

  /* birthday */
  .center{display:flex; align-items:center; justify-content:center; gap:36px; text-align:center}
  .avatar{
    width:420px; height:420px; border-radius:999px; background:#0b1620 center/cover no-repeat;
    box-shadow:0 10px 50px rgba(0,0,0,.45); border:4px solid rgba(255,255,255,.12)
  }
  .big{font-size:90px; line-height:1.05; margin:0}
  .sub{font-size:40px; opacity:.9; margin:10px 0 0}
  .flags{font-size:72px}
</style>
</head>
<body>
<div class="screen">
  <img id="logo" class="logo top-right" alt="Logo" hidden>
  <div id="mount" class="slide"><div class="wrap"><p>Indl√¶ser‚Ä¶</p></div></div>
</div>

<script>
(async function(){
  const DATA_URL = (new URLSearchParams(location.search).get('data') ||
    'https://perbonde07-byte.github.io/Infoskaerm/data.json');

  async function fetchJSON(){
    const r = await fetch(DATA_URL + '?v=' + Date.now(), { cache: 'no-store' });
    return await r.json();
  }

  // Hent f√∏rste data
  let data = await fetchJSON();
  let lastJSON = JSON.stringify(data);

  initScreen(data);

  // Auto-refresh hvert minut
  setInterval(async ()=>{
    try {
      const fresh = await fetchJSON();
      const sFresh = JSON.stringify(fresh);
      if(sFresh !== lastJSON){
        console.log("üîÅ Data √¶ndret ‚Äì genindl√¶ser");
        location.reload(); // nemmeste metode
      }
    } catch(e){ console.warn("Kunne ikke hente data.json", e); }
  }, 60000);

  // === Alt fra tidligere kode (rendering mv.) ===
  function initScreen(data){
    // --- logo setup ---
    const logo = document.getElementById('logo');
    const lg = (data.settings && data.settings.logo) || {};
    if(lg.url){
      logo.src = lg.url;
      logo.className = 'logo ' + (lg.position || 'top-right');
      logo.style.setProperty('--logoOpacity', (lg.opacity ?? .95));
      logo.style.setProperty('--logoSize', (lg.size ? lg.size+'px' : '140px'));
      logo.hidden = false;
    }

    const slides = data.slides || [];
    let idx = 0;

    function next(){
      let tries = 0;
      while(tries < slides.length){
        const s = slides[idx % slides.length];
        if(s.type === 'birthday' && !hasActiveBirthday(data.birthdays)) { idx++; tries++; continue; }
        renderSlide(s);
        const dur = Math.max(4, +s.duration || 12);
        setTimeout(()=>{ idx=(idx+1)%slides.length; next(); }, dur*1000);
        break;
      }
    }

    function renderSlide(s){
      const root = document.getElementById('mount');
      if(s.type === 'image'){
        root.innerHTML = `
          <div class="wrap">
            ${s.title ? `<h1>${escapeHTML(s.title)}</h1>`:''}
            <div class="image-holder" style="background-image:url('${escapeAttr(s.image||'')}')"></div>
          </div>`;
        return;
      }
      if(s.type === 'schedule'){
        const model = buildSchedule(data.schedule?.emptying);
        root.innerHTML = `
          <div class="wrap two-cols">
            <div>
              <h1>${escapeHTML(s.title||'T√òMNINGS DAGE')}</h1>
              ${renderScheduleTable(model)}
            </div>
            <div class="right-image" style="background-image:url('https://images.unsplash.com/photo-1556761175-4b46a572b786?q=80&w=1200&auto=format&fit=crop')"></div>
          </div>`;
        return;
      }
      if(s.type === 'birthday'){
        const bd = getActiveBirthday(data.birthdays);
        root.innerHTML = `
          <div class="wrap center">
            <div class="avatar" style="background-image:url('${escapeAttr(bd?.photo||'')}')"></div>
            <div>
              <h2 class="big">Tillykke med f√∏dselsdagen, ${escapeHTML(bd?.name||'')}</h2>
              <p class="sub">Ha' en rigtig dejlig uge! üéâ</p>
              <div class="flags">üá©üá∞üéÇüá©üá∞</div>
            </div>
          </div>`;
        return;
      }
      const items = (s.lines||[]).map(x=>`<li>${escapeHTML(x)}</li>`).join('');
      root.innerHTML = `
        <div class="wrap">
          ${s.title ? `<h1>${escapeHTML(s.title)}</h1>`:''}
          <ul>${items}</ul>
        </div>`;
    }

    // ---------- schedule helpers ----------
    function buildSchedule(cfg){
      const wd = (cfg?.weekdays && cfg.weekdays.length ? cfg.weekdays : [3]);
      const names = cfg?.names || [];
      const skip = new Set((cfg?.skipDates||[]));
      const today = new Date(); today.setHours(0,0,0,0);
      const items = [];
      let cursor = new Date(today);
      function isSkip(d){ return skip.has(d.toISOString().slice(0,10)); }
      let i=0, nIndex=0;
      while(items.length < 10 && i < 400){
        cursor = new Date(today);
        cursor.setDate(today.getDate()+i);
        const weekday = cursor.getDay()===0 ? 7 : cursor.getDay();
        if(wd.includes(weekday) && !isSkip(cursor)){
          const name = names[nIndex % Math.max(1, names.length)];
          items.push({date:new Date(cursor), name});
          nIndex++;
        }
        i++;
      }
      let hi = items.findIndex(x=>+x.date>=+today);
      if(hi===-1) hi = 0;
      return {items, highlightIndex:hi};
    }

    function renderScheduleTable(model){
      const left = model.items.slice(0,5);
      const right = model.items.slice(5,10);
      function rows(arr, baseIndex){
        return arr.map((x,i)=>{
          const d = fmtDate(x.date);
          const cls = (baseIndex+i)===model.highlightIndex ? ' class="highlight"' : '';
          return `<tr${cls}><td>${escapeHTML(x.name)}</td><td>${d}</td></tr>`;
        }).join('');
      }
      return `
        <table>
          <thead><tr><th>Navn</th><th>Dato</th></tr></thead>
          <tbody>${rows(left,0)}</tbody>
        </table>
        <div style="height:18px"></div>
        <table>
          <thead><tr><th>Navn</th><th>Dato</th></tr></thead>
          <tbody>${rows(right,5)}</tbody>
        </table>`;
    }

    // ---------- birthday helpers ----------
    function startOfWeek(d){ const t=new Date(d); const day=(t.getDay()||7); if(day>1)t.setDate(t.getDate()-(day-1)); t.setHours(0,0,0,0); return t; }
    function endOfWeek(d){ const s=startOfWeek(d); const e=new Date(s); e.setDate(s.getDate()+6); return e; }
    function hasActiveBirthday(list){ return !!getActiveBirthday(list); }
    function getActiveBirthday(list){
      if(!Array.isArray(list)||list.length===0) return null;
      const today=new Date(); today.setHours(0,0,0,0);
      const sOW=startOfWeek(today), eOW=endOfWeek(today);
      for(const p of list){
        const [y,m,d]=p.date.split('-').map(Number);
        const inThis=new Date(today.getFullYear(),m-1,d);
        const inNext=new Date(today.getFullYear()+1,m-1,d);
        if(inThis>=sOW && inThis<=eOW) return p;
        if(inNext>=sOW && inNext<=eOW) return p;
      }
      return null;
    }

    // ---------- util ----------
    function fmtDate(d){const months=['jan','feb','mar','apr','maj','jun','jul','aug','sep','okt','nov','dec'];return d.getDate()+' '+months[d.getMonth()]+' '+d.getFullYear();}
    function escapeHTML(s){return (s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
    function escapeAttr(s){return escapeHTML(s).replace(/"/g,'&quot;');}

    next();
  }
})();
</script>
</body>
</html>

