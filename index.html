<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Infoskærm</title>
<style>
  :root{
    --bg1:#0b6a74;
    --bg2:#0d4952;
    --accent:#a7d0c9;
    --ink:#e9fbff;
    --panel:rgba(0,0,0,.08);
    --line:rgba(255,255,255,.10);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    margin:0;
    background:linear-gradient(160deg,var(--bg1),var(--bg2));
    color:var(--ink);
    font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial;
  }

  /* PB-DESIGN: Scene */
  .stage{
    position:fixed;
    inset:0;
    padding:18px;
  }
  .frame{
    position:relative;
    width:100%;
    height:100%;
    border-radius:20px;
    border:1px solid rgba(255,255,255,.12);
  }
  .frame::before{
    content:"";
    position:absolute;
    inset:10px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.08);
  }
  .content{
    position:absolute;
    inset:20px 20px 60px 20px;
    display:grid;
    place-items:center;
  }

  /* Footer brand */
  .brand{
    position:absolute;
    left:0;right:0;bottom:0;
    height:56px;
    display:flex;
    align-items:center;
    gap:10px;
    padding:0 22px;
    color:var(--ink);
  }
  .brand .logo{height:28px}
  .brand .dot{
    width:8px;height:8px;
    background:var(--accent);
    border-radius:50%;
  }

  /* === PB-DESIGN • Empties (tømningsdage) – 21" optimering === */
  .slide-empties {
    --base: clamp(12px, 1.2vw + 8px, 22px);
    --title: clamp(24px, 3vw, 46px);
    --head: clamp(12px, 0.9vw + 8px, 18px);
    --row: clamp(14px, 1.1vw + 8px, 22px);
    --row-h: clamp(42px, 4.2vh, 64px);
    --radius: 16px;
    width: 100%;
    height: 100%;
    display: grid;
    place-items: center;
    padding: min(3.5vh, 28px);
  }
  .slide-empties .card{
    width:min(1120px,90vw);
    border-radius:var(--radius);
    background:var(--panel);
    border:1px solid rgba(255,255,255,.06);
    box-shadow:0 8px 30px rgba(0,0,0,.25) inset;
    padding:clamp(14px,2.8vh,30px);
  }
  .slide-empties h1{
    font-size:var(--title);
    line-height:1.1;
    letter-spacing:.12em;
    margin:0 0 clamp(14px,2.4vh,24px);
    text-align:center;
    font-weight:800;
  }
  .slide-empties .grid{
    display:grid;
    grid-template-columns:1fr minmax(280px,1fr);
    gap:clamp(14px,2.6vw,36px);
  }
  .slide-empties .tbl{width:100%}
  .slide-empties .thead,
  .slide-empties .row{
    display:grid;
    grid-template-columns:1.2fr .9fr;
    align-items:center;
    column-gap:clamp(8px,2vw,20px);
  }
  .slide-empties .thead{
    font-size:var(--head);
    text-transform:uppercase;
    letter-spacing:.12em;
    color:rgba(233,251,255,.8);
    border-bottom:1px solid rgba(255,255,255,.12);
    padding:0 4px 8px;
    margin-bottom:6px;
  }
  .slide-empties .row{
    font-size:var(--row);
    height:var(--row-h);
    border-bottom:1px dashed rgba(255,255,255,.10);
    padding:0 4px;
  }
  .slide-empties .row.is-now{
    background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.18);
    box-shadow:0 4px 18px rgba(0,0,0,.2);
    border-radius:12px;
  }
  .slide-empties .date{
    font-feature-settings:"tnum" 1,"ss01" 1;
    letter-spacing:.02em;
    justify-self:end;
  }
  @media (max-width:820px){
    .slide-empties .grid{grid-template-columns:1fr}
    .slide-empties h1{text-align:left}
  }

  /* === PB-DESIGN • Billede + valgfri sidetekst === */
  .slide-image{
    display:grid;
    grid-template-columns:1fr;
    gap:22px;
    align-items:center;
    width:min(1200px,94vw);
  }
  .slide-image.has-text{
    grid-template-columns:1.1fr .9fr;
  }
  .slide-image .box{
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .slide-image img{
    max-width:100%;
    max-height:64vh;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    box-shadow:0 12px 40px rgba(0,0,0,.28);
  }
  .slide-image .text{
    font-size:clamp(16px,1.5vw,26px);
    line-height:1.35;
  }
  .slide-image h2{
    margin:0 0 10px;
    font-size:clamp(20px,2vw,34px);
    letter-spacing:.04em;
  }
  .slide-image p{margin:.5em 0}

  /* === PB-DESIGN • Tekst-slide === */
  .slide-text{
    width:min(1100px,92vw);
  }
  .slide-text h2{
    margin:0 0 .3em;
    font-size:clamp(22px,2.4vw,36px);
    letter-spacing:.04em;
  }
  .slide-text p{
    margin:.4em 0;
    font-size:clamp(16px,1.6vw,26px);
  }

  /* === PB-DESIGN • Fødselsdag === */
  .slide-birthday{
    width:min(1100px,92vw);
    text-align:center;
  }
  .slide-birthday h1{
    margin:0 0 .6em;
    font-size:clamp(26px,3vw,48px);
    letter-spacing:.05em;
  }
  .slide-birthday .photo{
    width:min(340px,38vw);
    height:min(340px,38vw);
    object-fit:cover;
    border-radius:18px;
    border:2px solid rgba(255,255,255,.18);
    box-shadow:0 10px 36px rgba(0,0,0,.25);
  }
  .slide-birthday .name{
    margin:.6em 0;
    font-size:clamp(22px,2.6vw,40px);
    font-weight:800;
  }
  .slide-birthday .msg{
    font-size:clamp(16px,1.6vw,26px);
  }
</style>
</head>
<body>
<div class="stage">
  <div class="frame">
    <div id="app" class="content"><!-- PB-DESIGN: slides renderes her --></div>
    <div class="brand">
      <img id="brandLogo" class="logo" alt="" />
      <span class="dot"></span>
      <span id="brandText"></span>
    </div>
  </div>
</div>

<script>
/* ===== PB-DESIGN • helper ===== */
const $ = (q,el=document)=>el.querySelector(q);
function escapeHtml(s){return String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;" }[m]))}
function pad2(n){return String(n).padStart(2,"0")}
function fmtDMY(d){ return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${d.getFullYear()}` }
function asYMD(d){ return `${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}` }

/* ===== PB-DESIGN • load data ===== */
let DATA=null, IDX=0, TIMER=null, BDAY_INDEX=0;

async function loadData(){
  const r = await fetch("/api/data");
  const j = await r.json();
  if(!j.ok) throw new Error(j.error||"Kunne ikke hente data.json");
  return j.content;
}

function applyTheme(){
  document.documentElement.style.setProperty("--bg1", DATA?.theme?.bg1 || "#0b6a74");
  document.documentElement.style.setProperty("--bg2", DATA?.theme?.bg2 || "#0d4952");
  document.documentElement.style.setProperty("--accent", DATA?.theme?.accent || "#a7d0c9");
  $("#brandLogo").src = DATA?.logoUrl || "";
  $("#brandLogo").style.display = DATA?.logoUrl ? "block":"none";
  $("#brandText").textContent = DATA?.brand || "Infoskærm";
}

/* ===== PB-DESIGN • slide engine ===== */
function nextSlide(){
  if(!DATA?.slides?.length) return;
  IDX = (IDX + 1) % DATA.slides.length;
  renderSlide();
}
function startTimer(sec){
  clearTimeout(TIMER);
  TIMER = setTimeout(nextSlide, (Number(sec)||12)*1000);
}
function renderSlide(){
  const app = $("#app");
  app.innerHTML = "";
  const s = DATA.slides[IDX] || {};
  if(s.type==="image")        renderImageSlide(app, s);
  else if(s.type==="text")    renderTextSlide(app, s);
  else if(s.type==="empties") renderEmptiesSlide(app, s);
  else if(s.type==="birthday")renderBirthdaySlide(app, s);
  else app.textContent = s.title || "Slide";
  startTimer(s.duration ?? 12);
}

/* ===== PB-DESIGN • slides ===== */
function renderImageSlide(root, s){
  const hasText = Boolean((s.sideText||"").trim());
  root.innerHTML = `
    <section class="slide-image ${hasText?"has-text":""}">
      <div class="box">
        <img src="${escapeHtml(s.image||"")}" alt="">
      </div>
      ${hasText?`
      <div class="text">
        <h2>${escapeHtml(s.title||"")}</h2>
        ${s.sideText.split(/\n+/).map(p=>`<p>${escapeHtml(p)}</p>`).join("")}
      </div>`:""}
    </section>
  `;
}

function renderTextSlide(root, s){
  root.innerHTML = `
    <section class="slide-text">
      <h2>${escapeHtml(s.title||"")}</h2>
      ${(s.content||"").split(/\n+/).map(p=>`<p>${escapeHtml(p)}</p>`).join("")}
    </section>
  `;
}

/* === PB-DESIGN • Fødselsdag: søndag før → søndag efter + rotation === */
function renderBirthdaySlide(root, s){
  const msg = DATA?.birthdays?.message || "Tillykke med fødselsdagen!";
  const people = DATA?.birthdays?.people || [];
  if(!people.length){
    root.innerHTML = `<div class="slide-text"><h2>Fødselsdag</h2><p>Ingen registreret.</p></div>`;
    return;
  }

  const today = new Date();
  const currentYear = today.getFullYear();

  function prevSunday(d){
    const date = new Date(d);
    while(date.getDay() !== 0){ // 0 = søndag
      date.setDate(date.getDate() - 1);
    }
    return date;
  }
  function nextSunday(d){
    const date = new Date(d);
    do{
      date.setDate(date.getDate() + 1);
    }while(date.getDay() !== 0); // stop ved næste søndag
    return date;
  }

  function parsePerson(p){
    // p.date: "dd.mm" eller "dd.mm.yyyy"
    const m = String(p.date||"").match(/^(\d{1,2})\.(\d{1,2})(?:\.(\d{4}))?$/);
    if(!m) return null;
    const dd = +m[1];
    const mm = (+m[2]) - 1;
    const bornYear = m[3] ? +m[3] : null;

    const thisYear = new Date(currentYear, mm, dd);
    const displayDate = fmtDMY(thisYear);
    const windowStart = prevSunday(thisYear);
    const windowEnd   = nextSunday(thisYear);

    return {
      name: p.name,
      image: p.image,
      bornYear,
      thisYear,
      displayDate,
      windowStart,
      windowEnd
    };
  }

  const parsed = people.map(parsePerson).filter(Boolean);
  if(!parsed.length){
    root.innerHTML = `<div class="slide-text"><h2>Fødselsdag</h2><p>Ingen gyldige datoer.</p></div>`;
    return;
  }

  // alle som har aktiv periode nu (søndag før → søndag efter)
  const active = parsed.filter(p => today >= p.windowStart && today <= p.windowEnd);

  let person;
  if(active.length){
    // roter gennem ALLE aktive før vi starter forfra
    if(BDAY_INDEX >= active.length){
      BDAY_INDEX = 0;
    }
    person = active[BDAY_INDEX];
    BDAY_INDEX++;
  } else {
    // ingen aktiv lige nu → find næste kommende fødselsdag i kalenderen
    const candidates = parsed.map(p=>{
      let nextDate = new Date(p.thisYear);
      if(nextDate < today){
        nextDate = new Date(currentYear+1, p.thisYear.getMonth(), p.thisYear.getDate());
      }
      return {
        ...p,
        nextDate,
        diff: nextDate - today
      };
    }).sort((a,b)=>a.diff - b.diff);

    person = candidates[0];
    BDAY_INDEX = 0; // reset rotation udenfor aktive vinduer
  }

  const age = person.bornYear ? (currentYear - person.bornYear) : null;
  const shortDate = person.displayDate.slice(0,5); // dd.mm

  root.innerHTML = `
    <section class="slide-birthday">
      <h1>FØDSELSDAG</h1>
      <img class="photo" src="${escapeHtml(person.image||"")}" alt="">
      <div class="name">${escapeHtml(person.name||"")}</div>
      <div class="msg">
        ${escapeHtml(msg)}
        ${shortDate ? ` (${escapeHtml(shortDate)})` : ""}
        ${age ? ` – ${age} år` : ""}
      </div>
    </section>
  `;
}

/* ===== PB-DESIGN • TØMNINGS DAGE (ny visning) ===== */
function renderEmptiesSlide(root/*, s*/){
  const plan = buildEmptiesPlan();
  const cols = Math.max(1, Math.min(2, Number(DATA?.empties?.columns||2)));
  const mid = cols===2 ? Math.ceil(plan.length/2) : plan.length;
  const left = plan.slice(0, mid);
  const right = cols===2 ? plan.slice(mid) : [];

  root.innerHTML = `
    <section class="slide-empties">
      <div class="card">
        <h1>TØMNINGS DAGE</h1>
        <div class="grid">
          ${col(left)}
          ${cols===2 ? col(right) : ""}
        </div>
      </div>
    </section>
  `;
  function col(list){
    return `
      <div class="tbl">
        <div class="thead"><div>NAVN</div><div class="date">DATO</div></div>
        ${list.map(r=>`
          <div class="row ${r.isNow?"is-now":""}">
            <div>${escapeHtml(r.name)}</div>
            <div class="date">${escapeHtml(r.dateStr)}</div>
          </div>
        `).join("")}
      </div>
    `;
  }
}

/* PB-DESIGN: Plan-generator der IKKE “skubber” på refresh */
function buildEmptiesPlan(){
  const E = DATA?.empties || {};
  const start = E.startDate ? new Date(E.startDate) : new Date();
  const weekdays = (E.weekdays||[1]).map(Number).filter(n=>n>=1 && n<=7); // 1=man .. 7=søn
  const names = (E.names||[]).filter(Boolean);
  const skip = new Set((E.skipDates||[]).map(s=>s.trim()));
  const horizon = Math.max(4, Math.min(40, Number(E.horizon||8)));

  const out=[], todayYMD=asYMD(new Date());
  let nameIdx=0;
  let d = new Date(start);
  while (d.getDay()!==1) d.setDate(d.getDate()-1);          // rul bagud til mandag for stabilitet
  function isWantedDay(date){ const wd = date.getDay()||7; return weekdays.includes(wd); }
  function stepToNextWanted(date){ do { date.setDate(date.getDate()+1); } while (!isWantedDay(date)); }
  while(!isWantedDay(d) || d < start) stepToNextWanted(d);  // første ønskedag >= start

  while(out.length < horizon){
    const dmy = fmtDMY(d);
    if(!skip.has(dmy)){
      const ymd = asYMD(d);
      const item = { name: (names[nameIdx % Math.max(1,names.length)])||"", dateStr: dmy, yyyymmdd: ymd };
      out.push(item);
      nameIdx++;
    }
    stepToNextWanted(d);
  }

  let flagged=false;
  for(const r of out){
    if(!flagged && r.yyyymmdd>=todayYMD){ r.isNow=true; flagged=true; } else r.isNow=false;
  }
  if(!flagged && out.length) out[out.length-1].isNow = true;
  return out;
}

/* ===== PB-DESIGN • boot ===== */
(async function start(){
  DATA = await loadData();
  BDAY_INDEX = 0;

  // defaults
  DATA.theme ??={};
  DATA.settings??={refreshMs:300000};
  DATA.empties??={startDate:"",horizon:8,weekdays:[1],names:[],skipDates:[],columns:2};
  DATA.slides ??=[];
  applyTheme();

  // AUTO: indsæt birthday-slide hvis der findes fødselsdagsdata,
  // men ingen slides med type "birthday"
  const hasBirthdaySlide = DATA.slides.some(s => s.type === "birthday");
  if(!hasBirthdaySlide && DATA.birthdays?.people?.length){
    DATA.slides.push({
      type: "birthday",
      duration: DATA.birthdays.duration ?? 12
    });
  }

  $("#brandText").textContent = DATA.brand || "Infoskærm";

  IDX = 0;
  renderSlide();

  const ms = Math.max(60000, Number(DATA.settings.refreshMs||300000));
  setInterval(async ()=>{
    try{
      const fresh = await loadData();
      DATA = fresh;
      BDAY_INDEX = 0; // reset rotation ved reload af data
      DATA.theme ??={};
      DATA.settings??={refreshMs:300000};
      DATA.empties??={startDate:"",horizon:8,weekdays:[1],names:[],skipDates:[],columns:2};
      DATA.slides ??=[];
      applyTheme();

      const hasBirthdaySlide = DATA.slides.some(s => s.type === "birthday");
      if(!hasBirthdaySlide && DATA.birthdays?.people?.length){
        DATA.slides.push({
          type: "birthday",
          duration: DATA.birthdays.duration ?? 12
        });
      }

      renderSlide();
    }catch(e){
      // ignorer net-fejl på TV
    }
  }, ms);
})();
</script>
</body>
</html>
