<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Infoskærm</title>
<style>
  :root{
    /* Pb-desigen: Tema-variabler (overskrives af settings.theme) */
    --bg1:#0d4b59; --bg2:#134d60; --accent:#e8b15c;
    --panel:rgba(255,255,255,.06); --grid:#235a6b; --muted:#cfe2ff;

    /* Pb-desigen: Globale skaleringer (overskrives af settings.style) */
    --t:1;            /* textScale */
    --h:1;            /* titleScale */
    --imgvh:70;       /* image max-vh for image-slides */
    --bdimgvh:50;     /* image max-vh for birthday */
    --imgfit:contain; /* contain | cover */

    /* Pb-desigen: Pr. slide multiplikatorer */
    --lt:1;           /* local text scale */
    --lh:1;           /* local title scale */
  }
  html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,sans-serif;background:var(--bg1);color:#fff;}
  .screen{position:relative;height:100%;display:grid;grid-template-rows:1fr auto;}
  .frame{position:absolute;left:2.6vh;right:2.6vh;top:2.6vh;border-radius:22px;box-shadow:inset 0 0 0 2px rgba(255,255,255,.12),inset 0 0 0 12px rgba(0,0,0,.18);}
  .bggrad{position:absolute;inset:0;background:linear-gradient(145deg,var(--bg1),var(--bg2));z-index:-1;}
  #slides{height:100%;display:grid;}
  .slide{display:none;align-items:center;justify-content:center;padding:4vh;text-align:left}
  .slide.active{display:flex}
  .title{font-size:calc(4.8vh * var(--h) * var(--lh));font-weight:800;letter-spacing:.02em;margin:0 0 2vh 0;text-transform:uppercase}
  .muted{color:var(--muted);font-size:2.2vh}
  .brandbar{display:flex;align-items:center;gap:16px;padding:12px 20px;background:rgba(0,0,0,.35);border-top:1px solid rgba(255,255,255,.12);}
  .brandbar img{height:28px}

  .text{font-size:calc(3vh * var(--t) * var(--lt));line-height:1.35}
  .sidetext{font-size:calc(3.2vh * var(--t) * var(--lt));line-height:1.4}

  .imgsplit{display:grid;gap:3vh;align-items:center;width:min(1400px,94vw)}
  .imgsplit.two{grid-template-columns:1fr 1fr}
  .imgwrap{display:flex;justify-content:center;align-items:center;min-height:60vh}
  .imgwrap img{
    max-width:100%;
    max-height:calc(var(--imgvh) * 1vh);
    border-radius:16px;
    object-fit:var(--imgfit);
  }
  @media (max-width: 900px){ .imgsplit.two{grid-template-columns:1fr} }

  .bd{display:grid;gap:2vh;place-items:center;min-height:70vh}
  .bd img{
    max-width:100%;
    max-height:calc(var(--bdimgvh) * 1vh);
    border:3px solid var(--accent);
    border-radius:20px;
    object-fit:var(--imgfit);
  }
  .bd .msg{font-size:calc(4vh * var(--t) * var(--lt))}
  .bd .name{font-size:calc(6vh * var(--h) * var(--lh));font-weight:900}

  .empties{width:min(1200px,94vw)}
  .empties .cols{display:grid;gap:22px}
  .empties .cols.cols-1{grid-template-columns:1fr}
  .empties .cols.cols-2{grid-template-columns:1fr 1fr}
  .empties .cols.cols-3{grid-template-columns:1fr 1fr 1fr}
  table{width:100%;border-collapse:collapse;font-size:calc(3vh * var(--t));background:transparent}
  th,td{border-bottom:1px solid var(--grid);padding:.7em 1em}
  th{font-weight:800;border-bottom:2px solid var(--grid);text-transform:uppercase;letter-spacing:.04em}
  tr.current{background:color-mix(in oklab,var(--accent) 35%, rgba(0,0,0,.25))}
  tr.current td{font-weight:800}
</style>
</head>
<body>
<div class="bggrad"></div>
<div class="screen">
  <div class="frame"></div>
  <div id="slides"></div>
  <div class="brandbar">
    <img id="logo" alt="logo"/>
    <div id="brand" class="muted"></div>
  </div>
</div>

<script>
/* Pb-desigen: ramme justeres efter brand-baren */
function adjustFrame(){
  const frame=document.querySelector('.frame');
  const bar=document.querySelector('.brandbar');
  if(!frame||!bar) return;
  const inset=window.innerHeight*0.026;
  const barH=bar.offsetHeight||56;
  frame.style.left=frame.style.right=frame.style.top=inset+'px';
  frame.style.bottom=(barH+inset)+'px';
}
addEventListener('load',adjustFrame);
addEventListener('resize',adjustFrame);
if(document.fonts&&document.fonts.ready) document.fonts.ready.then(adjustFrame);

/* Pb-desigen: helper */
async function loadData(){const r=await fetch('/api/data',{cache:'no-store'});if(!r.ok)throw new Error('Kunne ikke hente data');return await r.json();}
function h(tag,attrs={},children=[]){const el=document.createElement(tag);for(const[k,v]of Object.entries(attrs)){if(k==='class')el.className=v;else if(k==='text')el.textContent=v;else el.setAttribute(k,v);}children.forEach(c=>el.appendChild(c));return el;}

const elSlides=document.getElementById('slides'),elBrand=document.getElementById('brand'),elLogo=document.getElementById('logo');
window.CURRENT_MODEL_SETTINGS = {};

/* Pb-desigen: 2-cifret datoformat dd.MM.yyyy */
function fmtDMY(d){
  const dd=String(d.getDate()).padStart(2,'0');
  const mm=String(d.getMonth()+1).padStart(2,'0');
  const yyyy=d.getFullYear();
  return `${dd}.${mm}.${yyyy}`;
}

/* ----- Fødselsdag (uændrede hjælpefunktioner forkortet) ----- */
function titleCaseHyphen(name){return String(name||'').trim().split(/\s+/).map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join('-');}
function buildImageCandidates(personName, imgValue){
  const cand = [];
  if (imgValue && (/^https?:\/\//i.test(imgValue) || imgValue.startsWith('/'))) cand.push(imgValue);
  const baseFromInput = imgValue ? imgValue.replace(/^\/?medarbejdere\/?/i,'').replace(/\.(jpg|jpeg|png)$/i,'').trim() : '';
  const bases = new Set();
  if (baseFromInput){ bases.add(baseFromInput); bases.add(baseFromInput.toLowerCase()); }
  if (personName){ const t=titleCaseHyphen(personName); bases.add(t); bases.add(t.toLowerCase()); bases.add(String(personName).replace(/\s+/g,'')); }
  ['/medarbejdere/'].forEach(prefix=>['.jpg','.jpeg','.png'].forEach(ext=>bases.forEach(b=>cand.push(prefix+b+ext))));
  return [...new Set(cand)];
}
function createImgWithFallback(personName, imgValue){
  const candidates = buildImageCandidates(personName, imgValue);
  if (!candidates.length) return null;
  const img = document.createElement('img');
  let i = 0; img.src = candidates[i++]; img.onerror = ()=>{ if (i < candidates.length) img.src = candidates[i++]; };
  return img;
}
function parseDMY(s){if(!s)return null;const m=s.trim().match(/^(\d{1,2})\.(\d{1,2})(?:\.(\d{4}))?$/);if(!m)return null;const d=+m[1],mo=+m[2]-1,y=m[3]?+m[3]:new Date().getFullYear();const dt=new Date(y,mo,d,12,0,0);return isNaN(dt)?null:dt;}
function parseBirthdayParts(s){const m=String(s||'').trim().match(/^(\d{1,2})\.(\d{1,2})(?:\.(\d{2,4}))?$/);if(!m)return null;const day=String(m[1]).padStart(2,'0');const mon=String(m[2]).padStart(2,'0');let year=m[3]?String(m[3]):'';if(year&&year.length===2)year=(year>'30'?'19'+year:'20'+year);return{day:day,mon:mon,year:year};}
const WD_MAP={mon:1,tue:2,wed:3,thu:4,fri:5,sat:6,sun:0};

function slideBirthdayList(s,settings){
  const list=settings?.birthdays||[];
  return h('div',{class:'slide'},[h('div',{},[
    h('div',{class:'title',text:s.title||'Fødselsdage'}),
    h('div',{class:'text',text:list.map(b=>{
      const p=parseBirthdayParts(b.date);
      return p ? `${b.name} – ${p.day}.${p.mon}${p.year?'.'+p.year:''}` : `${b.name} – ${b.date}`;
    }).join('   ')})
  ])]);
}
function birthdayAlertSlides(settings){
  const list=settings?.birthdays||[]; const defaultMsg=settings?.birthdaysMessage||'Tillykke!';
  const out=[]; const today=new Date(); today.setHours(0,0,0,0);
  const mondayOfWeek=d=>{ const n=new Date(d); const day=n.getDay(); const diff=(day===0?-6:1-day); n.setDate(n.getDate()+diff); n.setHours(0,0,0,0); return n; };
  for(const b of list){
    const parts=parseBirthdayParts(b.date); if(!parts) continue;
    const dt=parseDMY(String(b.date||'')); if(!dt) continue;
    const thisYear=new Date(dt); thisYear.setFullYear(today.getFullYear()); thisYear.setHours(0,0,0,0);
    const nextYear=new Date(dt); nextYear.setFullYear(today.getFullYear()+1); nextYear.setHours(0,0,0,0);
    for(const when of [thisYear,nextYear]){
      const monday=mondayOfWeek(when);
      const isAlertWeek=(today>=monday && today<=new Date(monday.getFullYear(),monday.getMonth(),monday.getDate()+6));
      const isToday = today.getTime()===when.getTime();
      if(isAlertWeek || isToday){
        out.push({type:'_bdalert',title:'FØDSELSDAG',name:b.name,image:b.image||'',message:defaultMsg,dayShort:`${parts.day}.${parts.mon}`,birthYear:parts.year||''});
        break;
      }
    }
  }
  return out;
}
function renderBirthdayAlertSlide(s){
  const st = CURRENT_MODEL_SETTINGS?.style || {};
  const baseImgVh = Number(st.birthdayImageMaxVh || 50);
  const imgVh = Math.max(20, Math.min(100, baseImgVh * Number(s.imageScale || 1)));
  const holder=document.createElement('div');
  const imgEl=createImgWithFallback(s.name, s.image||'');
  if(imgEl){ imgEl.style.maxHeight = imgVh + 'vh'; holder.appendChild(imgEl); }
  const yearText = s.birthYear ? ` • ${s.birthYear}` : '';
  return h('div',{class:'slide', style:'--lt:1;--lh:1;'},[
    h('div',{class:'bd'},[
      h('div',{class:'title',text:s.title}),
      holder,
      h('div',{class:'name',text:s.name||''}),
      h('div',{class:'msg',text:`${s.message} (${s.dayShort}${yearText})`})
    ])
  ]);
}

/* ----- Tømning: auto + side-lås (kun udsnit – samme logik som før) ----- */
function buildAutoEmpties(settings){
  const auto=settings?.empties?.auto; if(!auto||!auto.enabled) return [];
  const names=(auto.names||[]).map(s=>String(s).trim()).filter(Boolean); if(!names.length) return [];
  const d0 = auto.startDate ? new Date(auto.startDate+'T12:00:00') : null; if(!d0||isNaN(d0)) return [];
  const weekdays=(auto.weekdays||[]).map(w=>({mon:1,tue:2,wed:3,thu:4,fri:5,sat:6,sun:0}[w])).filter(v=>v!==undefined); if(!weekdays.length) return [];
  const exclSet=new Set((auto.exclude||[]).map(s=>{const p=parseDMY(String(s));return p?new Date(p.getFullYear(),p.getMonth(),p.getDate()).getTime():null;}).filter(Boolean));
  const horizon=Math.max(1, Number(auto.horizon||12));
  const today=new Date(); today.setHours(0,0,0,0);
  const items=[]; let rosterIdx=0, safe=0; let cur=new Date(d0.getFullYear(),d0.getMonth(),d0.getDate(),12,0,0);
  while(items.length < horizon && safe < 20000){
    safe++; const isAllowed=weekdays.includes(cur.getDay()); const key=new Date(cur.getFullYear(),cur.getMonth(),cur.getDate()).getTime();
    if(isAllowed && !exclSet.has(key)){ if(cur>=today){items.push({name:names[rosterIdx%names.length],_date:new Date(cur)});} rosterIdx++; }
    cur.setDate(cur.getDate()+1);
  }
  return items;
}
function slideEmpties_makeSlides(s, settings){
  const items = buildAutoEmpties(settings);
  if (!items.length) {
    return h('div',{class:'slide'},[
      h('div',{class:'empties'},[
        h('div',{class:'title',text:s.title||'TØMNINGS DAGE'}),
        h('div',{class:'text',text:'Ingen plan fundet.'})
      ])
    ]);
  }
  const preview = settings?.empties?.previewDate ? parseDMY(String(settings.empties.previewDate)) : null;
  const ref = preview || (()=>{const d=new Date();d.setHours(0,0,0,0);return d;})();
  /* Pb-desigen: markerings-indeks (hi) */
  let hi = items.findIndex(p=>{const d=new Date(p._date); d.setFullYear(ref.getFullYear()); return d >= ref;});
  if (hi < 0) hi = 0;

  const cols = Math.max(1, Math.min(3, Number(settings?.empties?.columns || 1)));
  const ROWS_PER_COL = 6;
  const PAGE_SIZE = ROWS_PER_COL * cols;

  /* Pb-desigen: daglig anker + side-lås */
  const dayKey = ref.toISOString().slice(0,10);
  const anchorKeyName = 'emptiesAnchorKey';
  const anchorIdxName = 'emptiesAnchorIdx';
  const pageKeyName   = 'emptiesPageStart';
  if (!preview) {
    const savedKey = localStorage.getItem(anchorKeyName);
    const savedIdx = Number(localStorage.getItem(anchorIdxName));
    if (savedKey === dayKey && Number.isInteger(savedIdx) && savedIdx >= 0 && savedIdx < items.length) {
      const sd = new Date(items[savedIdx]._date); sd.setFullYear(ref.getFullYear());
      if (sd >= ref) hi = savedIdx;
    } else {
      localStorage.setItem(anchorKeyName, dayKey);
      localStorage.setItem(anchorIdxName, String(hi));
      localStorage.removeItem(pageKeyName);
    }
  }
  let pageStartLocked = Number(localStorage.getItem(pageKeyName));
  if (!Number.isInteger(pageStartLocked) || pageStartLocked < 0 || pageStartLocked >= items.length) {
    pageStartLocked = Math.floor(hi / PAGE_SIZE) * PAGE_SIZE;
    localStorage.setItem(pageKeyName, String(pageStartLocked));
  }
  const pageEndLocked = pageStartLocked + PAGE_SIZE - 1;
  if (hi > pageEndLocked) {
    pageStartLocked = Math.min(pageStartLocked + PAGE_SIZE, Math.max(0, Math.floor((items.length-1)/PAGE_SIZE)*PAGE_SIZE));
    localStorage.setItem(pageKeyName, String(pageStartLocked));
  }

  const pageStart = pageStartLocked;
  const windowItems = items.slice(pageStart, pageStart + PAGE_SIZE);

  const groups = cols===1 ? [windowItems] : (()=>{const out=[];const size=ROWS_PER_COL;for(let c=0;c<cols;c++){out.push(windowItems.slice(c*size,(c+1)*size));}return out;})();
  const tables = groups.map((group,gIdx)=>h('table',{},[
    h('thead',{},[h('tr',{},[h('th',{text:'Navn'}),h('th',{text:'Dato'})])]),
    h('tbody',{},group.map((p,idx)=>{
      const d=new Date(p._date); d.setFullYear(ref.getFullYear());
      const globalIdx = pageStart + gIdx*ROWS_PER_COL + idx;
      const isCurrent = (globalIdx === hi);
      return h('tr',{class:isCurrent?'current':'row'},[
        h('td',{text:p.name||''}),
        h('td',{text:fmtDMY(d)}) /* Pb-desigen: altid dd.MM.yyyy */
      ]);
    }))
  ]));

  const colsWrap = h('div',{class:'cols cols-'+cols}, tables);
  const node = h('div',{class:'slide'},[
    h('div',{class:'empties'},[
      h('div',{class:'title',text:s.title||'TØMNINGS DAGE'}),
      colsWrap
    ])
  ]);
  node.dataset.duration = Math.max(3, Number(s.duration||12));
  return node;
}

/* ----- Billede/tekst (uforkortet fra tidligere) ----- */
function slideImage(s){
  const hasText=(s.sideText||'').trim().length>0;
  const align=(s.imageAlign==='left'?'left':'right');

  const st = CURRENT_MODEL_SETTINGS?.style || {};
  const baseImgVh = Number(st.imageMaxVh || 70);
  const imgVh = Math.max(20, Math.min(100, baseImgVh * Number(s.imageScale || 1)));
  const localTextScale = Number(s.textScale || 1);
  const localTitleScale = Number(s.titleScale || 1);

  const imgEl = h('img',{src:s.image,alt:s.title||'', style:`max-height:${imgVh}vh;`});

  if(!hasText){
    return h('div',{class:'slide', style:`--lt:${localTextScale};--lh:${localTitleScale};`},[
      h('div',{class:'imgsplit'},[
        h('div',{class:'imgwrap'},[ imgEl ])
      ])
    ]);
  }
  const blockImg=h('div',{class:'imgwrap'},[ imgEl ]);
  const blockTxt=h('div',{class:'sidetext',text:s.sideText});
  const order=align==='left'?[blockImg,blockTxt]:[blockTxt,blockImg];
  return h('div',{class:'slide', style:`--lt:${localTextScale};--lh:${localTitleScale};`},[
    h('div',{class:'imgsplit two'},order)
  ]);
}
function slideText(s){return h('div',{class:'slide'},[h('div',{},[h('div',{class:'title',text:s.title||''}),h('div',{class:'text',text:s.text||''})])]);}

/* ----- Byg/carousel ----- */
function buildSlides(model){
  window.CURRENT_MODEL_SETTINGS = model.settings || {};
  const theme=model?.settings?.theme||{};
  if(theme.bg1)document.documentElement.style.setProperty('--bg1',theme.bg1);
  if(theme.bg2)document.documentElement.style.setProperty('--bg2',theme.bg2);
  if(theme.accent)document.documentElement.style.setProperty('--accent',theme.accent);

  const st = model?.settings?.style || {};
  if (st.textScale)  document.documentElement.style.setProperty('--t', String(st.textScale));
  if (st.titleScale) document.documentElement.style.setProperty('--h', String(st.titleScale));
  if (st.imageMaxVh) document.documentElement.style.setProperty('--imgvh', String(st.imageMaxVh));
  if (st.birthdayImageMaxVh) document.documentElement.style.setProperty('--bdimgvh', String(st.birthdayImageMaxVh));
  if (st.imageFit)   document.documentElement.style.setProperty('--imgfit', st.imageFit);

  elSlides.innerHTML=''; elBrand.textContent=model.brand||''; if(model.logoUrl) elLogo.src=model.logoUrl; else elLogo.remove();

  const makers={ image:slideImage, text:slideText, empties:(s)=>slideEmpties_makeSlides(s,model.settings), birthday:(s)=>slideBirthdayList(s,model.settings), _bdalert:renderBirthdayAlertSlide };
  const seq=[ ...birthdayAlertSlides(model.settings), ...(model.slides||[]) ];
  const nodes=[];
  seq.forEach(s=>{
    const make=makers[s.type]||slideText;
    const out=make(s);
    (Array.isArray(out)?out:[out]).forEach(n=>{
      if(!n.dataset.duration){ n.dataset.duration=Math.max(3, Number(s.duration||(s.type==='_bdalert'?10:8))); }
      nodes.push(n);
    });
  });
  nodes.forEach(n=>elSlides.appendChild(n));
  runCarousel(nodes);
}
function runCarousel(nodes){
  let i=0;
  function show(idx){
    nodes.forEach(n=>n.classList.remove('active'));
    nodes[idx].classList.add('active');
    const d=Number(nodes[idx].dataset.duration)*1000;
    setTimeout(()=>{i=(i+1)%nodes.length;show(i);},d);
  }
  if(nodes.length) show(0);
}

/* ----- Init / auto-refresh ----- */
(async()=>{
  try{
    const { data } = await loadData();
    buildSlides(data); adjustFrame();
    const minMs=300000; const cfgMs=Number(data?.settings?.refreshMs||minMs); const every=Math.max(minMs,isFinite(cfgMs)?cfgMs:minMs);
    setInterval(async()=>{ try{ const { data:fresh } = await loadData(); buildSlides(fresh); adjustFrame(); }catch{} }, every);
  }catch(e){ document.body.innerHTML = `<pre style="padding:2rem;color:#fff">${e.message}</pre>`; }
})();
</script>
</body>
</html>
