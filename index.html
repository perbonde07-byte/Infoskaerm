<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Infoskærm</title>
<style>
  /* ========== PB-DESIGN: Tema & layout ========== */
  :root{
    --bg1:#0d4952;
    --bg2:#0b6a74;
    --accent:#a7d0c9;
    --ink:#e9fbff;
    --muted:rgba(233,251,255,.75);
    --line:rgba(255,255,255,.12);
    --card:rgba(0,0,0,.10);
    --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    color:var(--ink);
    background:linear-gradient(160deg,var(--bg1),var(--bg2));
    font:16px/1.5 system-ui, Segoe UI, Roboto, Helvetica, Arial;
  }
  .stage{
    min-height:100%;
    padding:24px;
    display:grid;
    place-items:center;
  }
  .card{
    width:min(1280px,96vw);
    min-height:70vh;
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--radius);
    padding:28px;
    display:flex;
    flex-direction:column;
    gap:16px;
  }
  .brandbar{
    display:flex; align-items:center; justify-content:space-between; gap:16px;
  }
  .brand-left{
    display:flex; align-items:center; gap:12px;
  }
  .brand-logo{
    width:48px; height:48px; border-radius:12px; object-fit:contain;
    border:1px solid var(--line); background:rgba(0,0,0,.15); padding:6px;
  }
  .brand-name{ font-weight:800; letter-spacing:.02em }
  .clock{ opacity:.9; font-variant-numeric:tabular-nums; }

  .slide{
    flex:1;
    display:grid;
    place-items:center;
    padding:10px;
  }
  .slide-inner{
    width:100%;
    background:rgba(0,0,0,.12);
    border:1px solid var(--line);
    border-radius:16px;
    padding:20px;
  }
  h2.title{ margin:0 0 10px; letter-spacing:.02em; }
  .muted{ color:var(--muted) }

  /* ========== PB-DESIGN: Billedeslide ========== */
  .image-two-col{
    display:grid;
    grid-template-columns:1.2fr .8fr;
    gap:16px;
    align-items:center;
  }
  .image-centered{
    display:grid; place-items:center;
  }
  .image{
    width:100%; height:58vh; max-height:62vh; object-fit:contain;
    border-radius:14px; background:rgba(0,0,0,.18); border:1px solid var(--line);
  }
  .side-text{
    background:rgba(0,0,0,.10);
    border:1px solid var(--line);
    border-radius:14px; padding:16px; font-size:20px;
  }

  /* ========== PB-DESIGN: Tekstslide ========== */
  .text-body{
    font-size:22px;
    line-height:1.6;
    white-space:pre-wrap;
  }

  /* ========== PB-DESIGN: Tømningsplan ========== */
  .empties-grid{
    display:grid;
    gap:10px;
  }
  .empties-row{
    display:grid;
    grid-template-columns:160px 1fr 220px;
    align-items:center;
    gap:12px;
    background:rgba(0,0,0,.10);
    border:1px solid var(--line);
    border-radius:12px; padding:10px 12px;
  }
  .badge-date{
    font-variant-numeric:tabular-nums;
    background:rgba(255,255,255,.10); border:1px solid var(--line);
    padding:8px 10px; border-radius:10px; text-align:center; min-width:140px;
  }
  .name{ font-weight:700 }
  .who{ opacity:.9 }
  .is-current{
    outline:2px solid var(--accent);
    box-shadow:0 0 0 4px rgba(167,208,201,.25) inset;
  }

  /* ========== PB-DESIGN: Fødselsdag ========== */
  .bday{
    display:grid; grid-template-columns:1fr .9fr; gap:18px; align-items:center;
  }
  .bday .photo{
    width:100%; height:55vh; object-fit:contain; background:rgba(0,0,0,.2);
    border-radius:16px; border:1px solid var(--line);
  }
  .bday .panel{
    background:rgba(0,0,0,.12); border:1px solid var(--line);
    border-radius:16px; padding:16px;
  }
  .bday .name{ font-size:42px; font-weight:900; letter-spacing:.02em }
  .bday .meta{ margin-top:8px; font-size:18px; opacity:.9 }
  .bday .msg{ margin-top:12px; font-size:20px; white-space:pre-wrap }

  @media (max-width:900px){
    .bday{ grid-template-columns:1fr; }
    .image-two-col{ grid-template-columns:1fr; }
    .image{ height:48vh; }
  }
</style>
</head>
<body>
<div class="stage">
  <div class="card">
    <div class="brandbar">
      <div class="brand-left">
        <img id="logo" class="brand-logo" alt="">
        <div class="brand-name" id="brand">Infoskærm</div>
      </div>
      <div class="clock" id="clock"></div>
    </div>

    <div class="slide">
      <div class="slide-inner" id="slideHost">
        <div class="muted">Indlæser…</div>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   PB-DESIGN: Hjælpefunktioner
========================= */
const $  = (q, el=document)=>el.querySelector(q);
const pad2 = n => String(n).padStart(2,"0");
const fmtDate = d => `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${d.getFullYear()}`;
const fmtDateDM = d => `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}`;

/* Klokke */
function tickClock(){
  const now = new Date();
  $("#clock").textContent = `${fmtDate(now)}  ${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
}

/* Hent data.json via API */
async function getData(){
  const r = await fetch("/api/data");
  const j = await r.json();
  if(!j.ok) throw new Error(j.error||"Fejl fra /api/data");
  return j.content;
}

/* =========================
   PB-DESIGN: Empties (automatisk plan)
   - Generér kommende datoer på valgte ugedage
   - Afstem rækkefølgen af navne
   - Markér aktuel (første dato der er “i dag” eller frem)
========================= */
function parseSkip(list){
  // dd.mm.yyyy -> Date(midnight)
  return (list||[]).map(s=>{
    const m = s.trim().match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
    if(!m) return null;
    const [_,dd,mm,yyyy] = m;
    return new Date(Number(yyyy), Number(mm)-1, Number(dd), 0,0,0,0);
  }).filter(Boolean).map(d=>+d);
}

function buildEmpties(em, horizon){
  const start = em.startDate ? new Date(em.startDate) : new Date();
  start.setHours(0,0,0,0);
  const weekdays = (em.weekdays||[]).slice().sort(); // 1=Mon..5=Fri
  const names = (em.names||[]).slice();
  const skipSet = new Set(parseSkip(em.skipDates||[]));
  const res = [];
  if(!weekdays.length || !names.length) return res;

  // find første dato >= start på nærmeste valgte ugedag
  let d = new Date(start);
  function isChosenWeekday(date){
    const wd = date.getDay(); // 0=Sun .. 6=Sat
    const dk = wd===0?7:wd;   // 1..7
    return weekdays.includes(dk);
  }
  // Tril frem til første gyldige ugedag
  while(!isChosenWeekday(d)) d.setDate(d.getDate()+1);

  // generér datoer til vi har horizon (spring eksklusioner over)
  let nameIdx = 0;
  while(res.length < horizon+4){ // lidt buffer
    const dn = new Date(d);
    dn.setHours(0,0,0,0);
    const stamp = +dn;
    if(!skipSet.has(stamp)){
      res.push({
        date: new Date(dn),
        name: names[nameIdx % names.length]
      });
      nameIdx++;
    }
    // videre til næste valgte ugedag
    d.setDate(d.getDate()+1);
    while(!isChosenWeekday(d)) d.setDate(d.getDate()+1);
  }
  return res.slice(0,horizon);
}

function renderEmpties(host, DATA){
  const em = DATA.empties || {};
  const horizon = Number(em.horizon || 8);
  const cols = Math.max(1, Math.min(4, Number(em.columns||2)));
  const items = buildEmpties(em, horizon);
  host.innerHTML = `
    <h2 class="title">${(DATA.slides.find(s=>s.type==='empties')?.title)||'TØMNINGS DAGE'}</h2>
    <div class="empties-grid" style="grid-template-columns: repeat(${cols}, 1fr)">
    </div>
  `;
  const grid = host.querySelector(".empties-grid");
  const today = new Date(); today.setHours(0,0,0,0);

  items.forEach((row,i)=>{
    const tr = document.createElement("div");
    tr.className = "empties-row";
    const isCurrent = (+row.date) === +today;
    tr.innerHTML = `
      <div class="badge-date ${isCurrent?'is-current':''}">${fmtDate(row.date)}</div>
      <div class="name">${row.name || '-'}</div>
      <div class="who muted">Rækkefølge #${i+1}</div>
    `;
    grid.appendChild(tr);
  });
}

/* =========================
   PB-DESIGN: Fødselsdag (auto)
   - Finder alle personer hvor dato matcher dd.mm i dag
   - Viser hver person som sit eget slide (i rækkefølge)
========================= */
function peopleWithBirthdayToday(DATA){
  const todayDM = fmtDateDM(new Date()); // "dd.mm"
  const list = (DATA.birthdays?.people || []);
  return list.filter(p=>{
    const d = (p.date||"").trim();
    // tillad "dd.mm" eller "dd.mm.yyyy"
    return d.startsWith(todayDM);
  });
}

function renderBdaySlide(host, DATA, person){
  const msg = DATA.birthdays?.message || "Tillykke med fødselsdagen!";
  host.innerHTML = `
    <div class="bday">
      <img class="photo" src="${person.image||''}" alt="">
      <div class="panel">
        <h2 class="title">FØDSELSDAG</h2>
        <div class="name">${person.name||''}</div>
        <div class="meta">
          Født: ${(person.date||'')}
        </div>
        <div class="msg">${msg}</div>
      </div>
    </div>
  `;
}

/* =========================
   PB-DESIGN: Billedeslide & Tekstslide
========================= */
function renderImageSlide(host, slide){
  if(slide.sideText && slide.sideText.trim()){
    host.innerHTML = `
      <h2 class="title">${slide.title||'Billede'}</h2>
      <div class="image-two-col">
        <div><img class="image" src="${slide.image||''}" alt=""></div>
        <div class="side-text">${(slide.sideText||'').replace(/\n/g,'<br>')}</div>
      </div>
    `;
  } else {
    host.innerHTML = `
      <h2 class="title">${slide.title||'Billede'}</h2>
      <div class="image-centered">
        <img class="image" src="${slide.image||''}" alt="">
      </div>
    `;
  }
}

function renderTextSlide(host, slide){
  host.innerHTML = `
    <h2 class="title">${slide.title||'Info'}</h2>
    <div class="text-body">${(slide.content||'').replace(/\n/g,'<br>')}</div>
  `;
}

/* =========================
   PB-DESIGN: Slideshow
   - Udvider 'birthday' til en sekvens af personspecifikke slides (kun for i dag)
   - Respekterer slide.duration (sekunder)
========================= */
let DATA = null;
let QUEUE = [];
let idx = 0;
let timer = null;

function buildQueueFromSlides(slides){
  const out = [];
  for(const s of (slides||[])){
    if(s.type === "birthday"){
      const todays = peopleWithBirthdayToday(DATA);
      if(todays.length){
        // Push hver person som et "virtuel slide" med egen render
        todays.forEach(p=>{
          out.push({
            _virtual:true,
            type:"birthday:person",
            duration: s.duration ?? 12,
            render: (host)=>renderBdaySlide(host, DATA, p)
          });
        });
      } else {
        // Ingen fødselar i dag – vis en pæn besked (kort varighed)
        out.push({
          _virtual:true,
          type:"birthday:none",
          duration: Math.min(8, s.duration ?? 12),
          render: (host)=>{
            host.innerHTML = `
              <h2 class="title">${s.title || 'FØDSELSDAG'}</h2>
              <div class="muted">Ingen fødselsdag i dag.</div>
            `;
          }
        });
      }
    } else if(s.type === "empties"){
      out.push({
        _virtual:true,
        type:"empties",
        duration: s.duration ?? 12,
        render: (host)=>renderEmpties(host, DATA)
      });
    } else if(s.type === "image"){
      out.push({
        _virtual:true,
        type:"image",
        duration: s.duration ?? 12,
        render: (host)=>renderImageSlide(host, s)
      });
    } else if(s.type === "text"){
      out.push({
        _virtual:true,
        type:"text",
        duration: s.duration ?? 12,
        render: (host)=>renderTextSlide(host, s)
      });
    } else {
      // Ukendt type -> inert slide
      out.push({
        _virtual:true,
        type:"unknown",
        duration: 6,
        render: (host)=>{
          host.innerHTML = `<div class="muted">Ukendt slide-type: ${s.type||'n/a'}</div>`;
        }
      });
    }
  }
  return out;
}

function showCurrent(){
  const host = $("#slideHost");
  if(!QUEUE.length){
    host.innerHTML = `<div class="muted">Ingen slides konfigureret.</div>`;
    return;
  }
  const item = QUEUE[idx % QUEUE.length];
  try{
    item.render(host);
  } catch(err){
    host.innerHTML = `<div class="muted">Fejl i slide: ${err?.message||err}</div>`;
  }
  clearTimeout(timer);
  const ms = Math.max(1000, (item.duration||12)*1000);
  timer = setTimeout(()=>{
    idx = (idx+1) % QUEUE.length;
    showCurrent();
  }, ms);
}

/* =========================
   PB-DESIGN: Init + auto-refresh
========================= */
async function boot(){
  try{
    DATA = await getData();

    // Tema/brand
    $("#brand").textContent = DATA.brand || "Infoskærm";
    if(DATA.logoUrl) $("#logo").src = DATA.logoUrl;
    document.documentElement.style.setProperty('--bg1', DATA.theme?.bg1 || getComputedStyle(document.documentElement).getPropertyValue('--bg1'));
    document.documentElement.style.setProperty('--bg2', DATA.theme?.bg2 || getComputedStyle(document.documentElement).getPropertyValue('--bg2'));
    document.documentElement.style.setProperty('--accent', DATA.theme?.accent || getComputedStyle(document.documentElement).getPropertyValue('--accent'));

    // Kø op
    QUEUE = buildQueueFromSlides(DATA.slides||[]);
    idx = 0;
    showCurrent();

    // Auto-refresh af hele DATA (ikke skift slide i utide)
    const interval = Math.max(60000, Number(DATA.settings?.refreshMs||300000));
    setTimeout(boot, interval);
  }catch(e){
    $("#slideHost").innerHTML = `<div class="muted">Fejl ved indlæsning: ${e?.message||e}</div>`;
  }
}

/* Start */
tickClock();
setInterval(tickClock, 1000);
boot();
</script>
</body>
</html>



