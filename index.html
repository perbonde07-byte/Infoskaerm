<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Infoskærm</title>
  <style>
    :root{--bg:#0b1220;--panel:#111a2d;--muted:#96a2be;--fg:#e8eefb;--acc:#5aa2ff}
    html,body{height:100%;margin:0}
    body{background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Arial}
    .screen{display:flex;align-items:center;justify-content:center;height:100%}
    .slide{width:min(95vw,1200px);min-height:70vh;background:linear-gradient(180deg,#0f1830,#0e162a);
           border:1px solid rgba(255,255,255,.08);border-radius:24px;box-shadow:0 10px 40px rgba(0,0,0,.35);
           padding:28px 32px;display:flex;flex-direction:column}
    .title{font-size:40px;font-weight:800;letter-spacing:.02em;margin:0 0 16px}
    .body{flex:1;display:flex;gap:24px}
    .bullets{display:flex;flex-direction:column;gap:14px;font-size:28px}
    .image-wrap{display:flex;align-items:center;justify-content:center;flex:1}
    .image-wrap img{max-width:100%;max-height:62vh;border-radius:18px;object-fit:contain}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:24px}
    table{width:100%;border-collapse:collapse;background:var(--panel);border-radius:14px;overflow:hidden}
    th,td{padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.08)}
    th{font-weight:600;color:var(--muted);text-transform:uppercase;font-size:12px;letter-spacing:.08em}
    tr:last-child td{border-bottom:none}
    tr.today{background:rgba(90,162,255,.22)}
    td.date{white-space:nowrap}
    .brand{position:fixed;left:16px;bottom:12px;color:var(--muted);font-size:12px;letter-spacing:.08em}
  </style>
</head>
<body>
  <div class="screen"><div id="mount"></div></div>
  <div class="brand">Bredsgaard • Infoskærm</div>

  <script>
    // === KONFIG ===
    const DATA_URL = "https://perbonde07-byte.github.io/Infoskaerm/data.json";
    const SLIDE_MS = 12000; // fallback, men hvert slide kan have duration

    // === HJÆLPERE ===
    const WD = { sun:0, mon:1, tue:2, wed:3, thu:4, fri:5, sat:6 };
    function escapeHTML(s){return (s||"").replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}
    function parseISO(d){const t=d.split('-').map(Number);return new Date(t[0],t[1]-1,t[2]);}
    function fmtDate(date){return date.toLocaleDateString('da-DK',{day:'numeric',month:'short',year:'numeric'}).replace('.','');}
    function sameDay(a,b){return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate();}
    function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x;}

    // Frame
    function makeFrame(title=""){
      const root=document.createElement('div');root.className="slide";
      root.innerHTML=`<h2 class="title">${escapeHTML(title)}</h2><div class="body"></div>`;
      return root;
    }

    // === RENDER: BULLETS ===
    function renderBullets(s){
      const el=makeFrame(s.title||"");
      const body=el.querySelector(".body");
      const lines=(s.lines||[]).filter(Boolean);
      body.innerHTML=`<div class="bullets">${lines.map(x=>`<div>• ${escapeHTML(x)}</div>`).join("")}</div>`;
      return el;
    }

    // === RENDER: IMAGE ===
    function renderImage(s){
      const el=makeFrame(s.title||"");
      const body=el.querySelector(".body");
      body.innerHTML=`<div class="image-wrap">${s.image?`<img src="${escapeHTML(s.image)}" alt="">`:"(intet billede)"}</div>`;
      return el;
    }

    // === RENDER: ROTA ===
    function computeRotaSchedule(cfg, fromDate=new Date()){
      const start=parseISO(cfg.startDate);
      const wdSet=new Set((cfg.weekdays||[]).map(k=>WD[k]));
      const names=cfg.names||[];
      const placeholder=cfg.placeholder||"Ingen";
      const blackouts=new Set((cfg.blackouts||[]));
      const overrides=cfg.overrides||{};
      const weeksToShow=cfg.weeksToShow||10;

      // 1) find index i rotationen frem til i dag
      let rotIndex=0;
      let cursor=new Date(start);
      const today=new Date(fromDate.getFullYear(),fromDate.getMonth(),fromDate.getDate());
      while(cursor<today){
        if(wdSet.has(cursor.getDay())){
          const iso=cursor.toISOString().slice(0,10);
          const over=overrides[iso];
          const isPlaceholder=(over&&over.trim()===placeholder);
          if(blackouts.has(iso)||isPlaceholder){ /* forbrug ikke */ }
          else{ rotIndex++; }
        }
        cursor=addDays(cursor,1);
      }

      // 2) fremad: saml datoer
      const needed=weeksToShow*2; // heuristik (2 pr uge, justér hvis du har 3+ dage/uge)
      const out=[];
      cursor=new Date(today);
      while(out.length<needed){
        if(wdSet.has(cursor.getDay())){
          const iso=cursor.toISOString().slice(0,10);
          let name=null;
          if(iso in overrides){
            name=overrides[iso];
            const isPlaceholder=name.trim()===placeholder;
            if(!isPlaceholder) rotIndex++; // override forbruger rotation
          }else if(blackouts.has(iso)){
            name=placeholder; // tæller ikke
          }else{
            if(names.length>0){ name=names[rotIndex%names.length]; rotIndex++; }
            else{ name=placeholder; }
          }
          out.push({date:new Date(cursor),iso,name});
        }
        cursor=addDays(cursor,1);
      }
      return out;
    }

    function renderRota(s){
      const el=makeFrame(s.title||"TØMNINGS DAGE");
      const body=el.querySelector(".body");

      const rows=computeRotaSchedule(s);
      const half=Math.ceil(rows.length/2);
      const left=rows.slice(0,half), right=rows.slice(half);

      const renderCol=list=>`
        <table>
          <thead><tr><th>Navn</th><th>Dato</th></tr></thead>
          <tbody>
            ${list.map(r=>{
              const todayCls=sameDay(r.date,new Date())?' class="today"':'';
              return `<tr${todayCls}><td>${escapeHTML(r.name||"")}</td><td class="date">${fmtDate(r.date)}</td></tr>`;
            }).join("")}
          </tbody>
        </table>
      `;

      body.innerHTML=`<div class="row"><div>${renderCol(left)}</div><div>${renderCol(right)}</div></div>`;
      return el;
    }

    // === APP ===
    function renderSlide(s){
      switch(s.type){
        case "bullets": return renderBullets(s);
        case "image":  return renderImage(s);
        case "rota":   return renderRota(s);
        default:       return renderBullets({title:"Ukendt slide",lines:[JSON.stringify(s)]});
      }
    }

    async function main(){
      const mount=document.getElementById("mount");
      let data={ slides:[] };
      try{
        const r=await fetch(DATA_URL+"?v="+Date.now());
        data=await r.json();
      }catch(e){
        data={ slides:[{type:"bullets",title:"Ingen data",lines:["Kunne ikke hente data.json"]}] };
      }
      if(!Array.isArray(data.slides)||data.slides.length===0){
        data.slides=[{type:"bullets",title:"Ingen slides",lines:["Tilføj slides i admin."]}];
      }

      let i=0;
      async function showNext(){
        mount.innerHTML="";
        const s=data.slides[i%data.slides.length];
        const el=renderSlide(s);
        mount.appendChild(el);
        i++;
        const ms=Math.max(3000, (s.duration||12)*1000);
        setTimeout(showNext, ms);
      }
      showNext();
    }
    main();
  </script>
</body>
</html>
