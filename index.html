<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Infoskærm</title>
<style>
  :root{ --bg1:#0d4b59; --bg2:#134d60; --accent:#e8b15c; --panel:rgba(255,255,255,.06); --grid:#235a6b; --muted:#cfe2ff;}
  html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,sans-serif;background:var(--bg1);color:#fff;}
  .screen{position:relative;height:100%;display:grid;grid-template-rows:1fr auto;}
  .frame{position:absolute;left:2.6vh;right:2.6vh;top:2.6vh;
         border-radius:22px;box-shadow:inset 0 0 0 2px rgba(255,255,255,.12),inset 0 0 0 12px rgba(0,0,0,.18);}
  .bggrad{position:absolute;inset:0;background:linear-gradient(145deg,var(--bg1),var(--bg2));z-index:-1;}
  .slide{display:none;align-items:center;justify-content:center;padding:4vh;text-align:left}
  .slide.active{display:flex}
  .title{font-size:4.8vh;font-weight:800;letter-spacing:.02em;margin:0 0 2vh 0;text-transform:uppercase}
  .muted{color:var(--muted);font-size:2.2vh}
  .brandbar{display:flex;align-items:center;gap:16px;padding:12px 20px;background:rgba(0,0,0,.35);border-top:1px solid rgba(255,255,255,.12);box-sizing:border-box;}
  .brandbar img{height:28px}
  .text{font-size:3vh;line-height:1.35}

  /* Tømning – 1/2/3 kolonner */
  .empties{width:min(1200px,94vw)}
  .empties .cols{display:grid;gap:22px}
  .empties .cols.cols-1{grid-template-columns:1fr}
  .empties .cols.cols-2{grid-template-columns:1fr 1fr}
  .empties .cols.cols-3{grid-template-columns:1fr 1fr 1fr}
  table{width:100%;border-collapse:collapse;font-size:3vh;background:transparent}
  th,td{border-bottom:1px solid var(--grid);padding:.7em 1em}
  th{font-weight:800;border-bottom:2px solid var(--grid);text-transform:uppercase;letter-spacing:.04em}
  tr.current{background:color-mix(in oklab,var(--accent) 35%,rgba(0,0,0,.25))}
  tr.current td{font-weight:800}

  /* Fødselsdagskort */
  .bd{display:grid;gap:2vh;align-items:center;justify-items:center}
  .bd .msg{font-size:4vh}
  .bd .name{font-size:6vh;font-weight:900}
  .bd img{max-width:45vw;max-height:50vh;border-radius:20px;border:3px solid var(--accent)}

  /* Billede med valgfri sidetekst */
  .imgsplit{display:grid;gap:3vh;align-items:center;width:min(1400px,94vw)}
  .imgsplit.two{grid-template-columns:1fr 1fr}
  .imgwrap{display:flex;justify-content:center}
  .imgwrap img{max-width:100%;max-height:70vh;border-radius:16px}
  .sidetext{font-size:3.2vh;line-height:1.4}
  @media (max-width: 900px){
    .imgsplit.two{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div class="bggrad"></div>
<div class="screen">
  <div class="frame"></div>
  <div id="slides"></div>
  <div class="brandbar">
    <img id="logo" alt="logo"/>
    <div id="brand" class="muted"></div>
  </div>
</div>

<script>
/* --- Dynamisk justering af rammehøjde --- */
function adjustFrame(){
  const frame=document.querySelector('.frame');
  const bar=document.querySelector('.brandbar');
  if(!frame||!bar) return;
  const inset=window.innerHeight*0.026;
  const barH=bar.offsetHeight||56;
  frame.style.left=frame.style.right=frame.style.top=inset+'px';
  frame.style.bottom=(barH+inset)+'px';
}
window.addEventListener('load',adjustFrame);
window.addEventListener('resize',adjustFrame);
if(document.fonts&&document.fonts.ready) document.fonts.ready.then(adjustFrame);

/* --- Datahåndtering --- */
async function loadData(){const r=await fetch('/api/data',{cache:'no-store'});if(!r.ok)throw new Error('Kunne ikke hente data');return await r.json();}
function h(tag,attrs={},children=[]){const el=document.createElement(tag);for(const[k,v]of Object.entries(attrs)){if(k==='class')el.className=v;else if(k==='text')el.textContent=v;else el.setAttribute(k,v);}children.forEach(c=>el.appendChild(c));return el;}
const elSlides=document.getElementById('slides'),elBrand=document.getElementById('brand'),elLogo=document.getElementById('logo');

/* --- Hjælpere --- */
function parseDMY(s){if(!s)return null;const m=s.trim().match(/^(\d{1,2})\.(\d{1,2})(?:\.(\d{4}))?$/);if(!m)return null;const d=+m[1],mo=+m[2]-1,y=m[3]?+m[3]:new Date().getFullYear();const dt=new Date(y,mo,d,12,0,0);return isNaN(dt)?null:dt;}
const WD_MAP={mon:1,tue:2,wed:3,thu:4,fri:5,sat:6,sun:0}; // JS: 0=sun

/* --- Fødselsdage --- */
function slideBirthdayList(s,settings){
  const list=settings?.birthdays||[];
  return h('div',{class:'slide'},[h('div',{},[
    h('div',{class:'title',text:s.title||'Fødselsdage'}),
    h('div',{class:'text',text:list.map(b=>{
      const d=parseDMY(String(b.date||'')); return `${b.name} – ${d?d.toLocaleDateString('da-DK',{day:'2-digit',month:'2-digit'}):b.date}`;
    }).join('   ')})
  ])]);
}
function birthdayAlertSlides(settings){
  const list=settings?.birthdays||[];
  const defaultMsg=settings?.birthdaysMessage || 'Tillykke!';
  const out=[];
  const today=new Date(); today.setHours(0,0,0,0);
  const mondayOfWeek=d=>{ const n=new Date(d); const day=n.getDay(); const diff=(day===0?-6:1-day); n.setDate(n.getDate()+diff); n.setHours(0,0,0,0); return n; };

  for(const b of list){
    const dt=parseDMY(String(b.date||'')); if(!dt) continue;
    const thisYear=new Date(dt); thisYear.setFullYear(today.getFullYear()); thisYear.setHours(0,0,0,0);
    const nextYear=new Date(dt); nextYear.setFullYear(today.getFullYear()+1); nextYear.setHours(0,0,0,0);

    for(const when of [thisYear,nextYear]){
      const monday=mondayOfWeek(when);
      const isAlertWeek=(today>=monday && today<=new Date(monday.getFullYear(),monday.getMonth(),monday.getDate()+6));
      const isToday = today.getTime()===when.getTime();
      if(isAlertWeek || isToday){
        out.push({
          type:'_bdalert', title:'Fødselsdag', name:b.name, image:b.image||'',
          message: defaultMsg,
          dayShort: when.toLocaleDateString('da-DK', { day:'2-digit', month:'2-digit' })
        });
        break;
      }
    }
  }
  return out;
}
function renderBirthdayAlertSlide(s){
  return h('div',{class:'slide'},[h('div',{class:'bd'},[
    h('div',{class:'title',text:s.title}),
    s.image ? h('img',{src:s.image,alt:s.name}) : h('div'),
    h('div',{class:'name',text:s.name||''}),
    h('div',{class:'msg',text:`${s.message} (${s.dayShort})`})
  ])]);
}

/* --- Tømning: kun automatisk plan + kolonner --- */
function buildAutoEmpties(settings){
  const auto=settings?.empties?.auto;
  if(!auto || !auto.enabled) return [];
  const names=(auto.names||[]).map(s=>String(s).trim()).filter(Boolean);
  if(!names.length) return [];
  const d0 = auto.startDate ? new Date(auto.startDate+'T12:00:00') : null; // yyyy-mm-dd
  if(!d0 || isNaN(d0)) return [];
  const weekdays=(auto.weekdays||[]).map(w=>WD_MAP[w]).filter(v=>v!==undefined);
  if(!weekdays.length) return [];

  const exclSet=new Set((auto.exclude||[]).map(s=>{
    const p=parseDMY(String(s)); return p? new Date(p.getFullYear(),p.getMonth(),p.getDate()).getTime(): null;
  }).filter(Boolean));

  const horizon=Math.max(1, Number(auto.horizon||12));
  const today=new Date(); today.setHours(0,0,0,0);

  const items=[];
  let rosterIdx=0, safe=0;
  let cur=new Date(d0.getFullYear(),d0.getMonth(),d0.getDate(),12,0,0);

  while(items.length < horizon && safe < 20000){
    safe++;
    const isAllowed = weekdays.includes(cur.getDay());
    const key=new Date(cur.getFullYear(),cur.getMonth(),cur.getDate()).getTime();
    if(isAllowed && !exclSet.has(key)){
      if(cur >= today){
        items.push({ name: names[rosterIdx % names.length], _date: new Date(cur) });
      }
      rosterIdx++;
    }
    cur.setDate(cur.getDate()+1);
  }

  return items.map(p=>({ name:p.name, _date:p._date }));
}
function chunk(arr,n){
  const out=[]; const size=Math.ceil(arr.length/n);
  for(let i=0;i<n;i++){ out.push(arr.slice(i*size,(i+1)*size)); }
  return out;
}
function slideEmpties(s,settings){
  const items = buildAutoEmpties(settings);
  const today = new Date(); today.setHours(0,0,0,0);

  // marker “næste”
  let upcomingIdx = items.findIndex(p=>{const d=new Date(p._date); d.setFullYear(today.getFullYear()); return d>=today;});
  if (upcomingIdx<0) upcomingIdx = 0;

  const cols = Math.max(1, Math.min(3, Number(settings?.empties?.columns || 1)));
  const groups = cols===1 ? [items] : chunk(items, cols);

  const tables = groups.map(group=>{
    return h('table',{},[
      h('thead',{},[h('tr',{},[h('th',{text:'Navn'}),h('th',{text:'Dato'})])]),
      h('tbody',{},group.map((p)=>{
        const d=new Date(p._date); d.setFullYear(today.getFullYear());
        return h('tr',{class:(p===items[upcomingIdx])?'current':'row'},[
          h('td',{text:p.name||''}),
          h('td',{text:d.toLocaleDateString('da-DK')})
        ]);
      }))
    ]);
  });

  const colsWrap = h('div',{class:'cols cols-'+cols}, tables);
  return h('div',{class:'slide'},[
    h('div',{class:'empties'},[
      h('div',{class:'title',text:s.title||'TØMNINGS DAGE'}),
      colsWrap
    ])
  ]);
}

/* --- Billede med valgfri sidetekst --- */
function slideImage(s){
  const hasText = (s.sideText||'').trim().length>0;
  const align = (s.imageAlign==='left'?'left':'right');
  if(!hasText){
    return h('div',{class:'slide'},[
      h('div',{class:'imgsplit'},[
        h('div',{class:'imgwrap'},[
          h('img',{src:s.image,alt:s.title||'',style:'max-width:100%;max-height:70vh;border-radius:16px'})
        ])
      ])
    ]);
  }
  const imgEl = h('div',{class:'imgwrap'},[ h('img',{src:s.image,alt:s.title||''}) ]);
  const txtEl = h('div',{class:'sidetext',text:s.sideText} );
  const order = align==='left' ? [imgEl,txtEl] : [txtEl,imgEl];
  return h('div',{class:'slide'},[
    h('div',{class:'imgsplit two'}, order)
  ]);
}

/* --- Alm. tekst --- */
function slideText(s){return h('div',{class:'slide'},[h('div',{},[h('div',{class:'title',text:s.title||''}),h('div',{class:'text',text:s.text||''})])]);}

/* --- Orkestrering --- */
function buildSlides(model){
  // Tema
  const theme=model?.settings?.theme||{};
  if(theme.bg1)document.documentElement.style.setProperty('--bg1',theme.bg1);
  if(theme.bg2)document.documentElement.style.setProperty('--bg2',theme.bg2);
  if(theme.accent)document.documentElement.style.setProperty('--accent',theme.accent);

  elSlides.innerHTML=''; elBrand.textContent=model.brand||''; if(model.logoUrl) elLogo.src=model.logoUrl; else elLogo.remove();

  const makers={
    image:slideImage,
    text:slideText,
    empties:(s)=>slideEmpties(s,model.settings),
    birthday:(s)=>slideBirthdayList(s,model.settings),
    _bdalert:renderBirthdayAlertSlide
  };
  const seq=[ ...birthdayAlertSlides(model.settings), ...(model.slides||[]) ];
  const nodes=seq.map(s=>{const make=makers[s.type]||slideText; const n=make(s); n.dataset.duration=Math.max(3, Number(s.duration||(s.type==='_bdalert'?10:8))); return n;});
  nodes.forEach(n=>elSlides.appendChild(n));
  runCarousel(nodes);
}
function runCarousel(nodes){let i=0;function show(idx){nodes.forEach(n=>n.classList.remove('active'));nodes[idx].classList.add('active');const d=Number(nodes[idx].dataset.duration)*1000;setTimeout(()=>{i=(i+1)%nodes.length;show(i);},d);}if(nodes.length)show(0);}

/* --- Init --- */
(async()=>{
  try{
    const { data } = await loadData();
    buildSlides(data);
    adjustFrame();
    const minMs=300000; // 5 min minimum
    const cfgMs=Number(data?.settings?.refreshMs||minMs);
    const every=Math.max(minMs, isFinite(cfgMs)?cfgMs:minMs);
    setInterval(async()=>{ try{ const { data:fresh } = await loadData(); buildSlides(fresh); adjustFrame(); }catch{} }, every);
  }catch(e){
    document.body.innerHTML = `<pre style="padding:2rem;color:#fff">${e.message}</pre>`;
  }
})();
</script>
</body>
</html>
