<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bredsgaard ‚Ä¢ Infoskaerm</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#111a2d; --muted:#243147; --text:#e8eefb; --accent:#5aa2ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
    .stage{position:relative;inset:0;display:flex;align-items:center;justify-content:center;height:100%;padding:40px}
    .card{
      width:100%;height:100%;border-radius:18px;background:linear-gradient(180deg,#0f172a, #0b1220 70%);
      border:1px solid rgba(255,255,255,.06);box-shadow:0 10px 40px rgba(0,0,0,.35);
      padding:48px;position:relative;overflow:hidden;
    }
    /* logo */
    .logo{position:absolute;max-height:70px;max-width:min(28vw,380px);opacity:.95}
    .pos-tr{top:22px;right:28px}.pos-tl{top:22px;left:28px}
    .pos-br{bottom:22px;right:28px}.pos-bl{bottom:22px;left:28px}

    /* footer brand */
    .brand{position:absolute;left:22px;bottom:18px;font-size:12.5px;opacity:.75}

    /* typografi */
    h1{margin:0 0 16px;font-size:64px;line-height:1.05}
    h2{margin:0 0 12px;font-size:38px}
    p{margin:6px 0;font-size:22px;opacity:.95}
    ul{margin:18px 0 0 0;padding:0;list-style:none}
    li{font-size:28px;margin:10px 0;display:flex;align-items:flex-start;gap:14px}
    li::before{content:"‚Ä¢";color:var(--accent);font-size:34px;line-height:1}

    /* billede */
    .image-wrap{width:100%;height:100%;display:flex;align-items:center;justify-content:center}
    .image-wrap img{max-width:100%;max-height:100%;object-fit:contain;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.35)}

    /* t√∏mningstabel ‚Äì simpel, p√¶n */
    .table{width:100%;border-collapse:collapse;margin-top:10px}
    .table th,.table td{border-bottom:1px solid var(--muted);padding:10px 12px;text-align:left;font-size:20px}
    .hl{background:rgba(90,162,255,.18)}

    /* f√∏dselsdag */
    .bd-wrap{display:grid;grid-template-columns:1fr 380px;gap:28px;align-items:center}
    .bd-photo{display:flex;align-items:center;justify-content:center}
    .bd-photo img{max-width:100%;max-height:320px;border-radius:999px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .bd-flag{font-size:48px}

    /* fade */
    .fade{animation:fade .45s ease}
    @keyframes fade{from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:none}}
  </style>
</head>
<body>
  <div class="stage">
    <div class="card" id="card">
      <img id="logo" class="logo pos-tr" alt="" />
      <div id="slide"></div>
      <div id="brand" class="brand"></div>
    </div>
  </div>

  <script>
    // --------- KONFIG ---------
    const DATA_URL = "https://perbonde07-byte.github.io/Infoskaerm/data.json";
    const POLL_MS = 60000; // tjek for opdateret data hvert minut

    // --------- STATE ---------
    let data = { brand:"", logoUrl:"", logoPos:"√òverst h√∏jre", slides:[] };
    let i = 0, timer = null, etag = "", lastMod = "";

    const el = {
      slide: document.getElementById("slide"),
      brand: document.getElementById("brand"),
      logo:  document.getElementById("logo"),
      card:  document.getElementById("card"),
    };

    // --------- HENT DATA ---------
    async function load(force=false){
      try{
        const headers = {};
        if(!force && etag) headers["If-None-Match"] = etag;
        if(!force && lastMod) headers["If-Modified-Since"] = lastMod;

        const res = await fetch(DATA_URL, {headers});
        if(res.status === 304) return; // intet nyt

        if(!res.ok) throw new Error("HTTP "+res.status);
        etag = res.headers.get("ETag") || etag;
        lastMod = res.headers.get("Last-Modified") || lastMod;

        data = await res.json();
        i = 0;
        renderBrandLogo();
        play(); // start forfra p√• f√∏rste slide
      }catch(err){
        // hvis vi ingen data har, vis bare tom baggrund
        console.warn("load:", err.message);
        renderBrandLogo();
        if(!data.slides || !data.slides.length){
          el.slide.innerHTML = ""; // ingen fallback-tekst
        }
      }
    }

    function renderBrandLogo(){
      el.brand.textContent = data.brand || "";
      // Logo
      el.logo.src = (data.logoUrl||"").trim();
      el.logo.style.display = el.logo.src ? "block":"none";
      el.logo.classList.remove("pos-tr","pos-tl","pos-br","pos-bl");
      switch((data.logoPos||"√òverst h√∏jre").toLowerCase()){
        case "√∏verst venstre": el.logo.classList.add("pos-tl"); break;
        case "nederst h√∏jre":  el.logo.classList.add("pos-br"); break;
        case "nederst venstre":el.logo.classList.add("pos-bl"); break;
        default:               el.logo.classList.add("pos-tr");
      }
    }

    // --------- VIS SLIDES ---------
    function play(){
      clearTimeout(timer);
      if(!data.slides || !data.slides.length){
        el.slide.innerHTML = ""; // ingen slides => blank
        timer = setTimeout(next, 10000);
        return;
      }
      const s = data.slides[i % data.slides.length];
      show(s);
      timer = setTimeout(next, Math.max(4, +s.duration || 12) * 1000);
    }
    function next(){ i = (i+1) % Math.max(1, data.slides.length || 1); play(); }

    // Renderer pr. skabelon
    function show(s){
      const wrap = document.createElement("div");
      wrap.className = "fade";

      if(s.type === "image"){
        wrap.innerHTML = `
          <div class="image-wrap">
            <img src="${escapeHtml(s.image||'')}" alt="" />
          </div>`;
      }
      else if(s.type === "empties"){ // T√∏mningstabel ‚Äì forventer title + lines med CSV "navn;dato"
        wrap.innerHTML = `
          <h1>${escapeHtml(s.title||'T√∏mning')}</h1>
          <table class="table" id="tTbl"><thead><tr><th>Navn</th><th>Dato</th></tr></thead><tbody></tbody></table>`;
        const tb = wrap.querySelector("#tTbl tbody");
        const rows = (s.lines||[]).map(x=>x.split("|").join("")).filter(Boolean);
        const today = new Date(); today.setHours(0,0,0,0);
        rows.forEach(line=>{
          // Accepter "Navn;YYYY-MM-DD" eller "Navn,DD-MM-YYYY"
          let [navn, dato] = line.split(/[,;]+/).map(t=>t.trim());
          let d = parseDateLoose(dato);
          const tr = document.createElement("tr");
          if(isSameWeek(d,today)) tr.className = "hl";
          tr.innerHTML = `<td>${escapeHtml(navn)}</td><td>${formatDK(d)}</td>`;
          tb.appendChild(tr);
        });
      }
      else if(s.type === "birthday"){ // F√∏dselsdag ‚Äì titel som ‚ÄúTillykke‚Äù, lines = [navn, ...tekst], image valgfrit
        const navn = (s.lines||[])[0] || s.title || "Tillykke!";
        const extra = (s.lines||[]).slice(1).join(" ");
        wrap.innerHTML = `
          <div class="bd-wrap">
            <div>
              <div class="bd-flag">üéâ üá©üá∞ üéâ</div>
              <h1>${escapeHtml(navn)}</h1>
              ${extra?`<p>${escapeHtml(extra)}</p>`:""}
            </div>
            <div class="bd-photo">${s.image?`<img src="${escapeHtml(s.image)}" alt="">`:""}</div>
          </div>`;
      }
      else { // bullets (default)
        const items = (s.lines||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("") || "<li>(tom)</li>";
        wrap.innerHTML = `
          ${s.title?`<h1>${escapeHtml(s.title)}</h1>`:""}
          <ul>${items}</ul>`;
      }

      el.slide.replaceChildren(wrap);
    }

    // --------- HJ√ÜLPERE ---------
    function escapeHtml(s){ return (s||"").replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function formatDK(d){ if(!(d instanceof Date) || isNaN(d)) return ""; const dd=String(d.getDate()).padStart(2,"0"); const mm=String(d.getMonth()+1).padStart(2,"0"); return `${dd}-${mm}-${d.getFullYear()}`; }
    function isSameWeek(d1,d2){
      if(!d1||!d2||isNaN(d1)||isNaN(d2)) return false;
      const a=new Date(d1), b=new Date(d2);
      a.setHours(0,0,0,0); b.setHours(0,0,0,0);
      const day = (x)=> (x.getDay()+6)%7; // ISO-uge, mandag 0
      const aMon = new Date(a); aMon.setDate(a.getDate()-day(a));
      const bMon = new Date(b); bMon.setDate(b.getDate()-day(b));
      return aMon.getTime()===bMon.getTime();
    }
    function parseDateLoose(s){
      if(!s) return new Date(NaN);
      // YYYY-MM-DD
      let m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(m) return new Date(+m[1], +m[2]-1, +m[3]);
      // DD-MM-YYYY
      m = s.match(/^(\d{2})-(\d{2})-(\d{4})$/);
      if(m) return new Date(+m[3], +m[2]-1, +m[1]);
      const d = new Date(s); return d;
    }

    // --------- K√òR ---------
    load(true);
    setInterval(load, POLL_MS);
  </script>
</body>
</html>

