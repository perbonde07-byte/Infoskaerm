<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Infoskærm</title>
<style>
  /* PB-DESIGN: stabil visning som tidligere */
  :root{
    --bg1:#0d4952; --bg2:#0b6a74; --accent:#a7d0c9; --ink:#e9fbff; --line:rgba(255,255,255,.14);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    color:var(--ink);
    background:linear-gradient(160deg,var(--bg1),var(--bg2));
    font:18px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial;
  }
  .wrap{min-height:100%;display:flex;flex-direction:column}
  header{
    display:flex;align-items:center;gap:14px;
    padding:14px 20px;border-bottom:1px solid var(--line);
    background:rgba(0,0,0,.10);
  }
  header img.logo{height:42px;object-fit:contain}
  header .brand{font-weight:800;letter-spacing:.02em}
  main{flex:1;display:grid;place-items:center;padding:20px}
  .card{
    width:min(1200px,95vw);
    background:rgba(0,0,0,.08);
    border:1px solid rgba(255,255,255,.10);
    border-radius:18px;
    padding:20px;
    box-shadow:0 10px 30px rgba(0,0,0,.2);
  }

  /* Slide layout */
  .slide{display:none}
  .slide.active{display:block}

  /* Image slide */
  .img-row{
    display:grid;grid-template-columns:1fr 1fr;gap:18px;align-items:center;
  }
  .img-only{
    display:flex;align-items:center;justify-content:center;min-height:52vh;
  }
  .img-only img,.img-row img{
    max-width:100%;max-height:62vh;border-radius:14px;
    object-fit:contain;background:rgba(255,255,255,.03);
    border:1px solid rgba(255,255,255,.08);padding:8px;
  }
  .sideText{
    background:rgba(0,0,0,.10);border:1px solid rgba(255,255,255,.10);
    border-radius:14px;padding:16px;font-size:1.05rem;
  }

  /* Text slide */
  .text-block{
    background:rgba(0,0,0,.08);border:1px solid rgba(255,255,255,.10);
    border-radius:14px;padding:18px;font-size:1.25rem
  }

  /* Empties slide */
  .empties-grid{
    display:grid;gap:12px;margin-top:10px;
  }
  .empties-grid.cols2{grid-template-columns:1fr 1fr}
  .empties-item{
    display:flex;justify-content:space-between;gap:10px;
    background:rgba(0,0,0,.10);border:1px solid rgba(255,255,255,.10);
    border-radius:12px;padding:12px 14px
  }
  .empties-item .name{font-weight:700}
  .empties-item .date{opacity:.9}
  .empties-item.today{
    outline:2px solid var(--accent);
    background:rgba(255,255,255,.06);
  }

  /* Birthday slide */
  .bday-wrap{display:grid;gap:12px;margin-top:10px}
  .bday-item{
    display:flex;align-items:center;gap:12px;
    background:rgba(0,0,0,.10);border:1px solid rgba(255,255,255,.10);
    border-radius:12px;padding:10px 12px
  }
  .bday-item img{
    width:72px;height:72px;border-radius:12px;object-fit:cover;
    border:1px solid rgba(255,255,255,.12);background:#041f24
  }
  .bday-item .who{font-weight:800}
  .bday-item .when{opacity:.9}
  .bday-item.today{outline:2px solid var(--accent);background:rgba(255,255,255,.06)}
  .muted{opacity:.8}
  h2{margin:0 0 10px;font-size:1.35rem;letter-spacing:.02em}
  .titlebar{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .title{font-weight:900;font-size:1.45rem}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <img class="logo" id="logo" alt="" src="" onerror="this.style.display='none'">
    <div class="brand" id="brand">Infoskærm</div>
  </header>

  <main>
    <div class="card">
      <!-- container for slides -->
      <div id="slidesHost"></div>
    </div>
  </main>
</div>

<script>
/* ===== PB-DESIGN: helpers ===== */
const $ = (q,el=document)=>el.querySelector(q);
function pad2(n){return String(n).padStart(2,"0")}
function fmtDate(d){return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${d.getFullYear()}`}

/* ===== Load data ===== */
async function loadData(){
  const r = await fetch("/api/data?t="+Date.now(), {cache:"no-store"});
  const j = await r.json();
  if(!j.ok) throw new Error(j.error||"Fejl ved /api/data");
  return j.content||{};
}

/* ===== Empties schedule ===== */
function parseSkipLines(lines){
  const out=new Set();
  (lines||[]).forEach(s=>{
    const m = s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
    if(!m) return;
    const d = new Date(Number(m[3]), Number(m[2])-1, Number(m[1]));
    out.add(d.toDateString());
  });
  return out;
}
function nextSchedule(startDateStr, weekdays, horizon, skipSet){
  // Byg næste 'horizon' arbejdsdatoer i rækkefølge
  const out=[];
  if(!startDateStr || !weekdays?.length) return out;
  const start = new Date(startDateStr+"T00:00:00");
  const today = new Date(); today.setHours(0,0,0,0);

  // find første gyldige fra start
  let d = new Date(start);
  const wdSet = new Set(weekdays.map(Number));
  // Sikkerhed – begræns loop
  let guard=0;
  while(out.length<horizon && guard<2000){
    const wd = d.getDay(); // 0= søn ... 1=man
    const wk = wd===0?7:wd; // 1..7
    const valid = wdSet.has(wk) && !skipSet.has(d.toDateString());
    if(valid){
      out.push(new Date(d));
    }
    // hop 1 dag
    d.setDate(d.getDate()+1);
    guard++;
  }
  // Marker "today" KUN hvis dato <= i dag (dvs. ikke før man har passeret)
  return out.map(dt=>{
    const pastOrToday = dt.getTime() <= today.getTime();
    const isToday = dt.toDateString() === today.toDateString();
    return { date: dt, isToday: isToday, highlight: isToday && pastOrToday };
  });
}

/* ===== Birthday helpers ===== */
function parseBdayStr(s){
  // dd.mm eller dd.mm.yyyy
  const m = s.match(/^(\d{1,2})\.(\d{1,2})(?:\.(\d{4}))?$/);
  if(!m) return null;
  const dd=Number(m[1]), mm=Number(m[2]), yyyy = m[3]?Number(m[3]):null;
  return { dd, mm, yyyy };
}
function calcAgeIfYear(yyyy){
  if(!yyyy) return null;
  const now = new Date();
  return now.getFullYear()-yyyy;
}

/* ===== Render slides ===== */
function createImageSlide(s){
  const host=document.createElement("div"); host.className="slide";
  const title = s.title||"";
  const hasSide = (s.sideText||"").trim().length>0;
  host.innerHTML = `
    <div class="titlebar"><div class="title">${title}</div></div>
    ${hasSide ? `
      <div class="img-row">
        <img src="${s.image||""}" alt="">
        <div class="sideText">${(s.sideText||"").replace(/\n/g,"<br>")}</div>
      </div>
    ` : `
      <div class="img-only"><img src="${s.image||""}" alt=""></div>
    `}
  `;
  return host;
}
function createTextSlide(s){
  const host=document.createElement("div"); host.className="slide";
  host.innerHTML = `
    <div class="titlebar"><div class="title">${s.title||""}</div></div>
    <div class="text-block">${(s.content||"").replace(/\n/g,"<br>")}</div>
  `;
  return host;
}
function createEmptiesSlide(s, DATA){
  const host=document.createElement("div"); host.className="slide";
  const E = DATA.empties||{};
  const names = (E.names||[]);
  const cols = Number(E.columns||1);
  const skip = parseSkipLines(E.skipDates||[]);
  const rows = nextSchedule(E.startDate, E.weekdays||[], Number(E.horizon||8), skip);

  // fordel navne cyklisk (klassisk logik)
  const items = rows.map((r, i)=>({
    date: r.date,
    label: names.length ? names[i % names.length] : "—",
    today: r.isToday && r.highlight
  }));

  const gridClass = cols===2 ? "empties-grid cols2":"empties-grid";
  const title = s.title || "TØMNINGS DAGE";
  host.innerHTML = `
    <div class="titlebar"><div class="title">${title}</div></div>
    <div class="${gridClass}">
      ${items.map(it=>`
        <div class="empties-item ${it.today?'today':''}">
          <div class="name">${it.label}</div>
          <div class="date">${fmtDate(it.date)}</div>
        </div>
      `).join("")}
    </div>
  `;
  return host;
}
function createBirthdaySlide(s, DATA){
  const host=document.createElement("div"); host.className="slide";
  const B = DATA.birthdays||{message:"",people:[]};
  const msg = B.message||"Tillykke med fødselsdagen!";
  const today = new Date(); const tdd=today.getDate(), tmm=today.getMonth()+1;

  const enriched = (B.people||[]).map(p=>{
    const meta = parseBdayStr(p.date||"");
    if(!meta) return null;
    const {dd,mm,yyyy} = meta;
    const age = yyyy? calcAgeIfYear(yyyy) : null;
    const isToday = (dd===tdd && mm===tmm);
    const dobStr = `${pad2(dd)}.${pad2(mm)}${yyyy?'.'+yyyy:''}`;
    return {name:p.name||"", image:p.image||"", dob:dobStr, age, isToday};
  }).filter(Boolean);

  host.innerHTML = `
    <div class="titlebar"><div class="title">${s.title||"FØDSELSDAG"}</div></div>
    <div class="bday-wrap">
      ${enriched.length? enriched.map(b=>`
        <div class="bday-item ${b.isToday?'today':''}">
          <img src="${b.image}" alt="">
          <div>
            <div class="who">${b.name}${b.age!==null?' • '+b.age+' år':''}</div>
            <div class="when">${b.dob}${b.isToday?' • <strong style="color:var(--accent)">TILLYKKE</strong>':''}</div>
            ${b.isToday? `<div class="muted">${msg}</div>`:''}
          </div>
        </div>
      `).join("") : `<div class="muted">Ingen registrerede fødselsdage.</div>`}
    </div>
  `;
  return host;
}

/* ===== Slide loop ===== */
let CURRENT=0, SLIDES=[], TIMER=null;
function showSlide(i){
  SLIDES.forEach((el,idx)=> el.classList.toggle("active", idx===i));
}
function nextSlide(){
  if(!SLIDES.length) return;
  CURRENT = (CURRENT+1) % SLIDES.length;
  showSlide(CURRENT);
  scheduleNext();
}
function scheduleNext(){
  clearTimeout(TIMER);
  const conf = window._slideConfs[CURRENT] || {duration:12};
  const ms = Math.max(3000, Number(conf.duration||12)*1000);
  TIMER = setTimeout(nextSlide, ms);
}

/* ===== Boot ===== */
(async function start(){
  const DATA = await loadData();

  // Tema, brand, logo
  document.documentElement.style.setProperty('--bg1', DATA?.theme?.bg1 || getComputedStyle(document.documentElement).getPropertyValue('--bg1'));
  document.documentElement.style.setProperty('--bg2', DATA?.theme?.bg2 || getComputedStyle(document.documentElement).getPropertyValue('--bg2'));
  document.documentElement.style.setProperty('--accent', DATA?.theme?.accent || getComputedStyle(document.documentElement).getPropertyValue('--accent'));
  $("#brand").textContent = DATA.brand || "Infoskærm";
  const logo = DATA.logoUrl||"";
  if(logo){ $("#logo").src = logo; $("#logo").style.display=""; }

  // Byg slides
  const host = $("#slidesHost"); host.innerHTML="";
  window._slideConfs = [];
  (DATA.slides||[]).forEach(s=>{
    let el=null;
    if(s.type==="image")     el = createImageSlide(s);
    else if(s.type==="text") el = createTextSlide(s);
    else if(s.type==="empties") el = createEmptiesSlide(s, DATA);
    else if(s.type==="birthday") el = createBirthdaySlide(s, DATA);
    if(el){
      host.appendChild(el);
      window._slideConfs.push({duration:s.duration??12});
    }
  });

  SLIDES = Array.from(host.children);
  if(SLIDES.length){
    CURRENT=0; showSlide(0); scheduleNext();
  }else{
    host.innerHTML = `<div class="slide active"><div class="text-block">Ingen slides oprettet endnu.</div></div>`;
    window._slideConfs=[{duration:12}];
    SLIDES = Array.from(host.children);
  }

  // Auto-refresh hele siden (holder data up-to-date)
  const refreshMs = Math.max(60000, Number(DATA?.settings?.refreshMs||300000));
  setTimeout(()=>location.reload(), refreshMs);
})();
</script>
</body>
</html>
