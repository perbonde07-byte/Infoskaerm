<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bredsgaard • Infoskærm</title>
  <style>
    :root{ --bg:#0b1220; --panel:#0f172a; --text:#e8eefb; --muted:#243147; --accent:#5aa2ff; }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
    .stage{position:relative;height:100vh;display:flex;align-items:center;justify-content:center;padding:40px}
    .card{width:100%;height:100%;background:radial-gradient(80% 80% at 50% 30%, #123 0%, #0b1220 70%);border-radius:22px;border:1px solid rgba(255,255,255,.06);padding:40px;overflow:hidden}
    h1,h2,h3{margin:0 0 12px}
    .brand{position:fixed;left:10px;bottom:8px;opacity:.7;font-size:12px}
    .logo{position:fixed;max-height:64px;max-width:180px;opacity:.95}
    .top-right{top:10px;right:10px}.top-left{top:10px;left:10px}.bottom-right{bottom:10px;right:10px}.bottom-left{bottom:10px;left:10px}
    ul{margin:0;padding-left:22px;font-size:34px;line-height:1.35}
    .center{display:flex;align-items:center;justify-content:center;height:100%}
    .img{max-width:100%;max-height:100%;object-fit:contain;display:block;margin:0 auto}
    table{border-collapse:collapse;width:70%;min-width:720px;margin-top:20px;background:rgba(0,0,0,.25);border-radius:12px;overflow:hidden}
    th,td{border-bottom:1px solid rgba(255,255,255,.1);padding:12px 16px;text-align:left;font-size:24px}
    th{background:rgba(255,255,255,.06)}
    .row-highlight{background:rgba(90,162,255,.18)}
    .msg{font-size:40px;opacity:.75}
  </style>
</head>
<body>
  <div class="stage">
    <div class="card" id="card">
      <div id="content" class="center"><div class="msg">Indlæser…</div></div>
    </div>
  </div>
  <div class="brand" id="brand">Bredsgaard • Infoskærm</div>
  <img id="logo" class="logo top-right" alt="" />

  <script>
    // -------- konfig --------
    const DATA_URL_DEFAULT = 'https://perbonde07-byte.github.io/Infoskaerm/data.json';
    const POLL_MS = 60_000;  // hent data.json hvert minut
    // ------------------------

    const $ = s => document.querySelector(s);
    const content = $('#content'), brandEl = $('#brand'), logoEl = $('#logo');

    const state = { dataUrl: DATA_URL_DEFAULT, data:null, idx:0, timer:null };

    function resolveMedia(src){
      if(!src) return '';
      const base = state.data?.media?.baseUrl || '';
      if(/^https?:\/\//i.test(src)) return src;
      if(base) return base.replace(/\/+$/,'') + '/' + String(src).replace(/^\/+/,'');
      return src;
    }

    function setLogo(){
      const url = state.data?.logoUrl || '';
      const pos = state.data?.logoPos || 'top-right';
      logoEl.src = url || '';
      logoEl.className = 'logo ' + pos;
      logoEl.style.display = url ? 'block' : 'none';
    }

    function setBrand(){
      brandEl.textContent = state.data?.brand || 'Infoskærm';
    }

    function renderSlide(s){
      if(!s){ content.innerHTML = '<div class="center"><div class="msg">Ingen slides • Tilføj i admin.</div></div>'; return; }
      const el = document.createElement('div');
      if(s.type==='bullets'){
        el.innerHTML = `<h1>${escapeHtml(s.title||'')}</h1>
          <ul>${(s.lines||[]).map(x=>'<li>'+escapeHtml(x)+'</li>').join('')}</ul>`;
      }else if(s.type==='image' || (s.type==='birthday' && s.image)){
        const img = resolveMedia(s.image);
        el.innerHTML = `<h1>${escapeHtml(s.title||'')}</h1>
          <div class="center"><img class="img" src="${escapeHtml(img)}" alt=""/></div>`;
      }else if(s.type==='empties'){
        el.append(renderEmpties());
      }else if(s.type==='birthday'){
        el.append(renderBirthdays());
      }else{
        el.innerHTML = `<div class="center"><div class="msg">Ukendt type</div></div>`;
      }
      content.innerHTML = ''; content.appendChild(el);
    }

    function renderEmpties(){
      const wrap = document.createElement('div');
      const cfg = state.data?.settings?.empties || {weekdays:[],skip:[],names:[]};
      wrap.innerHTML = `<h1>Tømning</h1>`;
      const list = computeEmptiesSchedule(cfg, 10);
      const tbl = document.createElement('table');
      tbl.innerHTML = `<thead><tr><th>Navn</th><th>Dato</th></tr></thead>`;
      const tb = document.createElement('tbody');
      const nextIdx = list.findIndex(x=>isSameDate(x.date, new Date()) || x.date > new Date());
      list.forEach((r,i)=>{
        const tr = document.createElement('tr');
        if(i===nextIdx) tr.classList.add('row-highlight');
        tr.innerHTML = `<td>${escapeHtml(r.name)}</td><td>${r.date.toLocaleDateString('da-DK')}</td>`;
        tb.appendChild(tr);
      });
      tbl.appendChild(tb); wrap.appendChild(tbl);
      return wrap;
    }

    function renderBirthdays(){
      const wrap = document.createElement('div');
      wrap.innerHTML = `<h1>Fødselsdage</h1>`;
      const week = birthdaysThisWeek(state.data?.settings?.birthdays||[]);
      if(!week.length){ wrap.innerHTML += `<div class="msg">Ingen i denne uge.</div>`; return wrap; }
      const tbl = document.createElement('table');
      tbl.innerHTML = `<thead><tr><th>Navn</th><th>Dato</th><th>Foto</th></tr></thead>`;
      const tb = document.createElement('tbody');
      week.forEach(b=>{
        const tr = document.createElement('tr');
        const img = b.photo ? `<img src="${escapeHtml(resolveMedia(b.photo))}" alt="" style="height:64px;border-radius:8px">` : '';
        tr.innerHTML = `<td>${escapeHtml(b.name)}</td><td>${new Date(b.date).toLocaleDateString('da-DK')}</td><td>${img}</td>`;
        tb.appendChild(tr);
      });
      tbl.appendChild(tb); wrap.appendChild(tbl);
      return wrap;
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]); }

    // --- empties beregning ---
    function computeEmptiesSchedule(cfg, count){
      const days = {mon:1,tue:2,wed:3,thu:4,fri:5};
      const wanted = (cfg.weekdays||[]).map(k=>days[k]).filter(Boolean).sort();
      if(!wanted.length || !(cfg.names||[]).length) return [];
      const skip = new Set((cfg.skip||[]).map(x=>x.trim()));
      const out = [];
      let cur = startOfDay(new Date());
      let i = 0, rot = 0;
      while(out.length < count && i < 365){
        cur = addDays(cur,1);
        if(wanted.includes(cur.getDay()) && !skip.has(fmtISO(cur))){
          const who = cfg.names[rot % cfg.names.length];
          out.push({name:who,date:new Date(cur)});
          rot++;
        }
        i++;
      }
      return out;
    }

    function birthdaysThisWeek(list){
      const now = new Date();
      const monday = addDays(startOfDay(now), (1 - (now.getDay()||7)) ); // mandag i denne uge
      const sunday = addDays(monday,6);
      return (list||[]).filter(b=>{
        if(!/^\d{4}-\d{2}-\d{2}$/.test(b.date)) return false;
        const d = startOfDay(new Date(b.date));
        return d>=monday && d<=sunday;
      });
    }

    // --- tid utils ---
    function startOfDay(d){ const x = new Date(d); x.setHours(0,0,0,0); return x; }
    function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
    function fmtISO(d){ return d.toISOString().slice(0,10); }
    function isSameDate(a,b){ return fmtISO(a)===fmtISO(b); }

    // loop
    function nextSlide(){
      const slides = state.data?.slides || [];
      if(!slides.length){ renderSlide(null); return; }
      state.idx = (state.idx % slides.length + slides.length) % slides.length;
      const cur = slides[state.idx];
      renderSlide(cur);
      const dur = Math.max(3, +cur.duration || 12);
      clearTimeout(state.timer);
      state.timer = setTimeout(()=>{ state.idx=(state.idx+1)%slides.length; nextSlide(); }, dur*1000);
    }

    async function loadData(){
      // tvungen opdatering flag?
      try{
        const f = localStorage.getItem('infoscreen_forceReloadAt');
        if(f && (!state.lastForce || +f > +state.lastForce)){ state.lastForce = +f; await fetchNow(); return; }
      }catch{}
      await fetchNow();
    }

    async function fetchNow(){
      try{
        const res = await fetch(state.dataUrl + '?v=' + Date.now(), {cache:'no-store'});
        if(!res.ok) throw new Error(res.status);
        const json = await res.json();
        const changed = JSON.stringify(json)!==JSON.stringify(state.data);
        state.data = json;
        setLogo(); setBrand();
        if(changed) nextSlide();
      }catch(e){
        // første indlæsning
        if(!state.data){
          state.data = { brand:'Infoskærm', slides:[] };
          setBrand(); nextSlide();
        }
      }
    }

    // init
    (async function(){
      const p = new URLSearchParams(location.search).get('data');
      if(p) state.dataUrl = p; // mulighed for at pege på anden data.json
      await loadData();
      setInterval(loadData, POLL_MS);
    })();
  </script>
</body>
</html>
